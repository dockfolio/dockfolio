services:
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: dockfolio-uptime-kuma
    restart: unless-stopped
    ports:
      - "127.0.0.1:9090:3001"
    volumes:
      - uptime-kuma-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    mem_limit: 150m
    cpus: 0.5
    pids_limit: 200
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: dockfolio-dashboard
    restart: unless-stopped
    ports:
      - "127.0.0.1:9091:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./dashboard/config.yml:/app/config.yml
      - ./dashboard/public:/app/public:ro
      # App .env files (read-write for editing)
      - /opt/promoforge/.env:/opt/promoforge/.env
      - /home/deploy/bannerforge/.env:/home/deploy/bannerforge/.env
      - /opt/headshot-ai/.env:/opt/headshot-ai/.env
      - /opt/abschlusscheck/.env:/opt/abschlusscheck/.env
      - /opt/lohncheck/.env:/opt/lohncheck/.env
      - /opt/sacredlens/.env.production:/opt/sacredlens/.env.production
      # Backup directories (read-only, for status monitoring)
      - /home/deploy/backups:/home/deploy/backups:ro
      # Marketing Manager SQLite data
      - /home/deploy/marketing:/home/deploy/marketing
      # Compose files (read-only, for docker compose up -d)
      - /opt/promoforge/docker-compose.yml:/opt/promoforge/docker-compose.yml:ro
      - /home/deploy/bannerforge/docker-compose.yml:/home/deploy/bannerforge/docker-compose.yml:ro
      - /opt/headshot-ai/docker-compose.yml:/opt/headshot-ai/docker-compose.yml:ro
      - /opt/abschlusscheck/docker-compose.prod.yml:/opt/abschlusscheck/docker-compose.prod.yml:ro
      - /opt/lohncheck/docker-compose.prod.yml:/opt/lohncheck/docker-compose.prod.yml:ro
      - /opt/sacredlens/docker-compose.prod.yml:/opt/sacredlens/docker-compose.prod.yml:ro
    mem_limit: 256m
    cpus: 0.5
    pids_limit: 200
    security_opt:
      - no-new-privileges:true
    environment:
      - NODE_ENV=production
      - PLAUSIBLE_URL=http://plausible-plausible-1:8000
      - PLAUSIBLE_API_KEY=${PLAUSIBLE_API_KEY:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - AUTH_DB_PATH=/home/deploy/marketing/auth.db
    networks:
      - default
      - plausible_default
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

networks:
  plausible_default:
    external: true

volumes:
  uptime-kuma-data:
