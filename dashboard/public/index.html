<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dockfolio</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a0a0f'/><circle cx='30' cy='35' r='8' fill='%2322c55e'/><circle cx='70' cy='35' r='8' fill='%2322c55e'/><circle cx='50' cy='65' r='8' fill='%233b82f6'/><line x1='30' y1='43' x2='50' y2='57' stroke='%232a2a3a' stroke-width='3'/><line x1='70' y1='43' x2='50' y2='57' stroke='%232a2a3a' stroke-width='3'/></svg>">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface2: #1a1a25;
      --surface3: #22222f;
      --border: #2a2a3a;
      --border-hover: #3a3a50;
      --text: #e4e4ed;
      --text-dim: #8888a0;
      --text-muted: #555568;
      --green: #22c55e;
      --green-dim: #16a34a;
      --yellow: #eab308;
      --red: #ef4444;
      --blue: #3b82f6;
      --purple: #a855f7;
      --cyan: #06b6d4;
      --orange: #f97316;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* Animated gradient background */
    @keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
    body::before { content:''; position:fixed; top:0; left:0; right:0; height:400px; background:linear-gradient(135deg, rgba(59,130,246,0.03), rgba(139,92,246,0.04), rgba(6,182,212,0.03)); pointer-events:none; z-index:0; animation:gradientShift 20s ease infinite; background-size:200% 200%; }

    /* Header */
    .header { padding: 20px 32px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position:relative; z-index:1; backdrop-filter:blur(12px); background:rgba(10,10,15,0.85); }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.02em; background:linear-gradient(135deg, var(--text), var(--cyan)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .health-summary { display: flex; gap: 12px; font-size: 12px; }
    .health-summary .hs-item { display: flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 12px; background: var(--surface2); }
    .health-summary .hs-count { font-weight: 600; font-variant-numeric: tabular-nums; }
    .header-right { display: flex; gap: 8px; align-items: center; }
    .search-input { font-size: 12px; padding: 5px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); width: 140px; outline: none; transition: all 0.15s; }
    .search-input:focus { border-color: var(--blue); width: 200px; }
    .search-input::placeholder { color: var(--text-muted); }
    .refresh-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); display: inline-block; animation: pulse 2s ease infinite; margin-right: 2px; }
    .last-updated { font-size: 11px; color: var(--text-muted); }
    .header-btn { font-size: 12px; color: var(--text-dim); text-decoration: none; padding: 5px 12px; border: 1px solid var(--border); border-radius: 6px; background: none; cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 4px; }
    .header-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border-hover); }
    .header-btn.primary { border-color: rgba(34, 197, 94, 0.3); color: var(--green); }
    .header-btn.primary:hover { background: rgba(34, 197, 94, 0.1); }

    /* System metrics bar */
    .system-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--surface); position:relative; z-index:1; }
    .metric { padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); transition: all 0.2s; }
    .metric:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); }
    .metric-top { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
    .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
    .metric-value { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
    .metric-bar { height: 3px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
    .metric-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
    .metric-detail { font-size: 10px; color: var(--text-muted); margin-top: 4px; font-variant-numeric: tabular-nums; }

    /* Sections */
    .section { padding: 20px 32px 8px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); font-weight: 600; }
    .section-count { font-size: 11px; color: var(--text-muted); background: var(--surface2); padding: 2px 8px; border-radius: 10px; }

    /* App cards */
    .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 10px; margin-bottom: 12px; }
    .app-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; cursor: pointer; transition: all 0.25s cubic-bezier(.4,0,.2,1); position: relative; overflow: hidden; }
    .app-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg, transparent, var(--green), transparent); opacity:0; transition:opacity 0.3s; }
    .app-card:hover { border-color: var(--border-hover); background: var(--surface2); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3), 0 0 0 1px rgba(59,130,246,0.1); }
    .app-card:hover::before { opacity:1; }
    .app-card.has-issue { border-left: 3px solid var(--red); }
    .app-card.has-warning { border-left: 3px solid var(--yellow); }
    .app-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .app-name { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .app-badges { display: flex; gap: 4px; }
    .badge { font-size: 10px; padding: 1px 6px; border-radius: 3px; font-weight: 500; }
    .badge-saas { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
    .badge-tool { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
    .badge-infra { background: rgba(249, 115, 22, 0.15); color: var(--orange); }
    .badge-static { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .badge-redirect { background: rgba(136, 136, 160, 0.1); color: var(--text-muted); }

    .status-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; flex-shrink: 0; transition: box-shadow 0.3s; }
    .status-dot.healthy, .status-dot.static { background: var(--green); box-shadow: 0 0 8px rgba(34, 197, 94, 0.4), 0 0 2px rgba(34, 197, 94, 0.8); }
    .status-dot.running { background: var(--green); opacity: 0.7; }
    .status-dot.unhealthy, .status-dot.degraded { background: var(--red); box-shadow: 0 0 6px rgba(239, 68, 68, 0.3); }
    .status-dot.restarting { background: var(--yellow); box-shadow: 0 0 6px rgba(234, 179, 8, 0.3); animation: pulse 1.2s ease infinite; }
    .status-dot.unknown { background: var(--text-muted); }

    .app-domain { font-size: 12px; color: var(--cyan); margin-bottom: 6px; opacity: 0.85; }
    .app-domain a { color: inherit; text-decoration: none; }
    .app-domain a:hover { text-decoration: underline; opacity: 1; }
    .app-desc { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; line-height: 1.4; }
    .app-meta { display: flex; gap: 12px; font-size: 10px; color: var(--text-muted); }
    .app-meta-item { display: flex; align-items: center; gap: 3px; }

    /* Container mini-bars in cards */
    .container-bars { display: flex; gap: 3px; margin-top: 8px; }
    .container-bar { flex: 1; height: 3px; border-radius: 2px; }
    .container-bar.healthy { background: var(--green); }
    .container-bar.running { background: var(--green); opacity: 0.6; }
    .container-bar.unhealthy { background: var(--red); }
    .container-bar.restarting { background: var(--yellow); }
    .container-bar.stopped { background: var(--text-muted); }

    /* Uptime sparkline */
    .sparkline { display: inline-flex; gap: 1px; align-items: flex-end; height: 14px; vertical-align: middle; margin-left: 4px; }
    .sparkline-bar { width: 2px; border-radius: 1px; min-height: 2px; }
    .sparkline-bar.up { background: var(--green); }
    .sparkline-bar.down { background: var(--red); }
    .sparkline-bar.pending { background: var(--text-muted); }

    /* Response time chart */
    .ping-chart { width: 100%; height: 30px; margin-top: 6px; position: relative; }
    .ping-chart canvas { width: 100%; height: 100%; }

    /* Activity feed */
    .activity-panel { display: none; padding: 12px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .activity-panel.visible { display: block; }
    .activity-list { max-height: 280px; overflow-y: auto; }
    .activity-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 12px; border-bottom: 1px solid var(--border); }
    .activity-item:last-child { border-bottom: none; }
    .activity-time { color: var(--text-muted); font-size: 10px; font-family: monospace; min-width: 55px; }
    .activity-action { padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: 500; min-width: 50px; text-align: center; }
    .activity-action.start { background: rgba(34,197,94,0.15); color: var(--green); }
    .activity-action.stop, .activity-action.die, .activity-action.kill { background: rgba(239,68,68,0.15); color: var(--red); }
    .activity-action.restart { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .activity-action.health_status { background: rgba(59,130,246,0.15); color: var(--blue); }
    .activity-action.create, .activity-action.destroy { background: rgba(136,136,160,0.1); color: var(--text-muted); }
    .activity-name { color: var(--text-dim); }

    /* Docker overview bar */
    .docker-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 32px 0; }
    .docker-stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; }
    .docker-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .docker-stat-value { font-size: 14px; font-weight: 600; font-variant-numeric: tabular-nums; }
    .docker-stat-sub { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); display: none; z-index: 100; justify-content: center; align-items: flex-start; padding-top: 48px; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg); border: 1px solid var(--border); border-radius: 16px; width: 720px; max-height: 85vh; overflow-y: auto; box-shadow: 0 24px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05); animation: modalIn 0.25s cubic-bezier(.4,0,.2,1); }
    @keyframes modalIn { from{opacity:0;transform:scale(0.96) translateY(8px)} to{opacity:1;transform:scale(1) translateY(0)} }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg); z-index: 1; border-radius: 14px 14px 0 0; }
    .modal-header h2 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .modal-close { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; font-size: 16px; width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .modal-close:hover { color: var(--text); background: var(--surface3); }
    .modal-body { padding: 20px 24px; }

    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 16px; margin-bottom: 20px; font-size: 13px; }
    .detail-grid dt { color: var(--text-muted); font-size: 11px; }
    .detail-grid dd { margin-bottom: 8px; }
    .detail-grid a { color: var(--cyan); text-decoration: none; }

    .container-detail { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; margin-bottom: 8px; }
    .container-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .container-detail-name { font-size: 13px; font-weight: 500; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; display: flex; align-items: center; gap: 6px; }
    .container-detail-uptime { font-size: 11px; color: var(--text-muted); }
    .container-detail-stats { display: flex; gap: 16px; font-size: 12px; color: var(--text-dim); }
    .stat-label { color: var(--text-muted); margin-right: 3px; }

    .btn { font-size: 11px; padding: 5px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); cursor: pointer; transition: all 0.2s cubic-bezier(.4,0,.2,1); }
    .btn:hover { background: var(--surface3); color: var(--text); border-color: var(--border-hover); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .btn:active { transform: translateY(0); }
    .btn-row { display: flex; gap: 6px; margin-top: 8px; }

    .log-viewer { background: #08080d; border: 1px solid var(--border); border-radius: 8px; padding: 14px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 11px; line-height: 1.7; max-height: 420px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; color: var(--text-dim); margin-top: 16px; }
    .log-viewer-header { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; margin-bottom: 8px; }
    .log-viewer-header h3 { font-size: 13px; font-weight: 500; }

    /* Error banner */
    .error-banner { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; padding: 12px 16px; margin: 16px 32px 0; display: none; }
    .error-banner.visible { display: flex; gap: 10px; align-items: flex-start; }
    .error-banner-icon { color: var(--red); font-size: 14px; flex-shrink: 0; margin-top: 1px; }
    .error-banner-text { font-size: 12px; color: var(--text-dim); line-height: 1.5; }
    .error-banner-title { color: var(--red); font-weight: 600; margin-bottom: 2px; }

    /* Modal tabs */
    .modal-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); padding: 0 24px; background: var(--surface); }
    .modal-tab { padding: 10px 16px; font-size: 12px; font-weight: 500; color: var(--text-muted); cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; transition: all 0.15s; }
    .modal-tab:hover { color: var(--text-dim); }
    .modal-tab.active { color: var(--text); border-bottom-color: var(--blue); }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }

    /* Env table */
    .env-table { width: 100%; border-collapse: collapse; }
    .env-row { border-bottom: 1px solid var(--border); }
    .env-row:last-child { border-bottom: none; }
    .env-row td { padding: 8px 0; vertical-align: middle; }
    .env-key { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 11px; font-weight: 500; color: var(--text); min-width: 180px; white-space: nowrap; }
    .env-value { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 11px; color: var(--text-dim); word-break: break-all; max-width: 360px; }
    .env-value.empty { color: var(--yellow); font-style: italic; }
    .env-actions { white-space: nowrap; text-align: right; }
    .env-toggle { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 12px; padding: 2px 6px; border-radius: 3px; }
    .env-toggle:hover { color: var(--text); background: var(--surface2); }
    .env-status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .env-status-dot.valid { background: var(--green); }
    .env-status-dot.expired { background: var(--red); }
    .env-status-dot.empty { background: var(--yellow); }
    .env-status-dot.present { background: var(--green); opacity: 0.5; }
    .env-edit-input { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 11px; padding: 4px 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--text); width: 100%; outline: none; }
    .env-edit-input:focus { border-color: var(--blue); }
    .env-add-row { padding: 8px 0; }
    .env-add-row input { width: 160px; margin-right: 8px; }
    .env-warning { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 6px; font-size: 11px; color: var(--text-dim); margin-bottom: 12px; }

    /* Sentry badge */
    .badge-sentry { background: rgba(34, 197, 94, 0.15); color: var(--green); font-size: 9px; padding: 1px 4px; border-radius: 3px; font-weight: 600; }
    .badge-no-sentry { background: rgba(239, 68, 68, 0.1); color: var(--red); font-size: 9px; padding: 1px 4px; border-radius: 3px; font-weight: 500; opacity: 0.7; }

    /* Key health panel */
    .key-health-panel { display: none; padding: 12px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .key-health-panel.visible { display: block; }
    .key-health-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 8px; }
    .key-health-app { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; }
    .key-health-app-name { font-size: 12px; font-weight: 600; margin-bottom: 6px; }
    .key-health-item { display: flex; justify-content: space-between; align-items: center; font-size: 11px; padding: 2px 0; }
    .key-health-status { font-weight: 500; }
    .key-health-status.valid { color: var(--green); }
    .key-health-status.expired { color: var(--red); }
    .key-health-status.error { color: var(--yellow); }

    /* Marketing Manager */
    .marketing-panel { display: none; padding: 0; border-bottom: 1px solid var(--border); background: var(--surface); position:relative; }
    .marketing-panel.visible { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
    .mkt-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 32px 0; }
    .mkt-header-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); font-weight: 600; background:linear-gradient(90deg, var(--purple), var(--cyan)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .mkt-tabs { display: flex; gap: 0; padding: 8px 32px 0; border-bottom: 1px solid var(--border); overflow-x:auto; scrollbar-width:none; }
    .mkt-tabs::-webkit-scrollbar { display:none; }
    .mkt-tab { padding: 8px 14px; font-size: 11px; font-weight: 500; color: var(--text-muted); cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; transition: all 0.2s; white-space:nowrap; }
    .mkt-tab:hover { color: var(--text-dim); background: rgba(255,255,255,0.02); }
    .mkt-tab.active { color: var(--text); border-bottom-color: var(--cyan); }
    .mkt-tab-content { display: none; padding: 16px 32px; }
    .mkt-tab-content.active { display: block; animation: tabFadeIn 0.3s ease; }
    @keyframes tabFadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .marketing-summary { display: flex; gap: 16px; margin-bottom: 12px; align-items: center; flex-wrap: wrap; }
    .marketing-avg-score { font-size: 36px; font-weight: 700; font-variant-numeric: tabular-nums; line-height: 1; }
    .marketing-avg-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .marketing-stat { text-align: center; padding: 6px 14px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.04); }
    .marketing-stat-value { font-size: 18px; font-weight: 600; font-variant-numeric: tabular-nums; }
    .marketing-stat-label { font-size: 10px; color: var(--text-muted); }
    .marketing-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 10px; }

    /* Revenue cards */
    .rev-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .rev-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .rev-card-name { font-size: 13px; font-weight: 600; }
    .rev-amount { font-size: 22px; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--green); }
    .rev-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .rev-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 10px 0; }
    .rev-stat { text-align: center; }
    .rev-stat-val { font-size: 14px; font-weight: 600; font-variant-numeric: tabular-nums; }
    .rev-stat-lbl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
    .rev-charges { margin-top: 8px; border-top: 1px solid var(--border); padding-top: 6px; }
    .rev-charge { display: flex; justify-content: space-between; font-size: 11px; padding: 2px 0; color: var(--text-dim); }
    .rev-shared { font-size: 10px; color: var(--text-muted); font-style: italic; margin-top: 4px; }

    /* Analytics cards */
    .ana-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .ana-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .ana-card-name { font-size: 13px; font-weight: 600; }
    .ana-realtime { font-size: 12px; font-weight: 600; color: var(--green); }
    .ana-realtime-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s ease infinite; margin-right: 4px; }
    .ana-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 8px 0; }
    .ana-stat { text-align: center; }
    .ana-stat-val { font-size: 14px; font-weight: 600; font-variant-numeric: tabular-nums; }
    .ana-stat-lbl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
    .ana-list { margin-top: 6px; }
    .ana-list-title { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 3px; }
    .ana-list-item { display: flex; justify-content: space-between; font-size: 11px; padding: 1px 0; color: var(--text-dim); }
    .ana-list-bar { height: 3px; background: var(--surface3); border-radius: 2px; margin-top: 1px; overflow: hidden; }
    .ana-list-bar-fill { height: 100%; background: var(--blue); border-radius: 2px; }

    /* SEO cards */
    .seo-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .seo-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .seo-card-name { font-size: 13px; font-weight: 600; }
    .seo-card-domain { font-size: 11px; color: var(--cyan); }
    .seo-score { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
    .seo-score.grade-A { color: var(--green); }
    .seo-score.grade-B { color: var(--green); opacity: 0.8; }
    .seo-score.grade-C { color: var(--yellow); }
    .seo-score.grade-D { color: var(--orange); }
    .seo-score.grade-F { color: var(--red); }
    .seo-grade { font-size: 11px; font-weight: 600; padding: 1px 6px; border-radius: 3px; margin-left: 6px; }
    .seo-checks { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 2px; margin: 8px 0; }
    .seo-check { font-size: 10px; padding: 2px 0; display: flex; align-items: center; gap: 4px; }
    .seo-check.pass { color: var(--green); }
    .seo-check.fail { color: var(--text-muted); }
    .seo-issues { border-top: 1px solid var(--border); margin-top: 8px; padding-top: 8px; }
    .seo-issue { font-size: 10px; padding: 2px 0; display: flex; align-items: center; gap: 4px; }
    .seo-issue.high { color: var(--red); }
    .seo-issue.medium { color: var(--yellow); }
    .seo-issue.low { color: var(--text-dim); }
    .seo-bar { height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; margin: 6px 0; }
    .seo-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
    .marketing-info { font-size: 10px; color: var(--text-muted); margin-top: 8px; border-top: 1px solid var(--border); padding-top: 6px; }
    .marketing-info span { display: inline-block; margin-right: 12px; }

    /* Overview health cards */
    .health-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; }
    .health-card-left { flex: 1; }
    .health-card-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
    .health-card-factors { font-size: 10px; color: var(--text-muted); }
    .health-card-score { font-size: 28px; font-weight: 700; font-variant-numeric: tabular-nums; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .app-card { animation: fadeIn 0.2s ease; }

    /* Subtabs (Revenue/Cohorts, Sequences/Queue) */
    .mkt-subtabs { display: flex; gap: 0; margin-bottom: 12px; border-bottom: 1px solid var(--border); }
    .mkt-subtab { padding: 6px 14px; font-size: 11px; font-weight: 500; color: var(--text-muted); cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; transition: all 0.15s; }
    .mkt-subtab:hover { color: var(--text-dim); }
    .mkt-subtab.active { color: var(--text); border-bottom-color: var(--purple); }
    .mkt-subtab-content { display: none; }
    .mkt-subtab-content.active { display: block; }

    /* Cohort cards */
    .cohort-matrix { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 6px; margin-top: 8px; }
    .cohort-cell { background: var(--surface3); border-radius: 6px; padding: 8px 10px; text-align: center; }
    .cohort-cell-count { font-size: 20px; font-weight: 700; color: var(--purple); font-variant-numeric: tabular-nums; }
    .cohort-cell-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    .crosssell-card { background: var(--surface2); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 10px; padding: 14px 16px; }
    .crosssell-pairing { font-size: 13px; font-weight: 600; color: var(--purple); margin-bottom: 4px; }

    /* Sequence cards */
    .seq-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .seq-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .seq-card-name { font-size: 13px; font-weight: 600; }
    .seq-status { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
    .seq-status.active { background: rgba(34,197,94,0.15); color: var(--green); }
    .seq-status.paused { background: rgba(239,68,68,0.1); color: var(--red); }
    .seq-step { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 11px; color: var(--text-dim); border-top: 1px solid var(--border); margin-top: 4px; }
    .seq-step-day { font-size: 10px; background: var(--surface3); color: var(--text-muted); padding: 1px 6px; border-radius: 3px; flex-shrink: 0; }
    .queue-row { display: grid; grid-template-columns: 1fr 120px 100px 80px; gap: 8px; align-items: center; padding: 6px 10px; font-size: 11px; border-bottom: 1px solid var(--border); }
    .queue-header { font-size: 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
    .daily-cap-bar { height: 4px; background: var(--surface3); border-radius: 2px; margin: 4px 0; overflow: hidden; }
    .daily-cap-fill { height: 100%; border-radius: 2px; }

    /* Content cards */
    .content-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .content-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .content-type-badge { font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.04em; }
    .content-type-badge.meta_description { background: rgba(6,182,212,0.15); color: var(--cyan); }
    .content-type-badge.blog_outline { background: rgba(59,130,246,0.15); color: var(--blue); }
    .content-type-badge.title { background: rgba(168,85,247,0.15); color: var(--purple); }
    .content-type-badge.faq_schema { background: rgba(249,115,22,0.15); color: var(--orange); }
    .content-type-badge.comparison_page { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .content-status { font-size: 10px; font-weight: 600; }
    .content-status.draft { color: var(--text-muted); }
    .content-status.approved { color: var(--green); }
    .content-status.published { color: var(--cyan); }
    .content-status.rejected { color: var(--red); }
    .content-body { font-size: 11px; color: var(--text-dim); line-height: 1.5; margin: 8px 0; max-height: 80px; overflow: hidden; position: relative; white-space: pre-wrap; }
    .content-body.expanded { max-height: none; }
    .content-actions { display: flex; gap: 6px; margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; }

    /* Generate modal */
    .gen-form { display: flex; flex-direction: column; gap: 10px; padding: 16px; }
    .gen-form select, .gen-form input { padding: 6px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; }

    /* Command Palette */
    .cmd-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; padding-top: 15vh; }
    .cmd-overlay.active { display: flex; }
    .cmd-box { width: 560px; max-height: 420px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .cmd-input { width: 100%; padding: 16px 20px; font-size: 16px; background: transparent; border: none; border-bottom: 1px solid var(--border); color: var(--text); outline: none; font-family: inherit; }
    .cmd-input::placeholder { color: var(--text-muted); }
    .cmd-results { overflow-y: auto; max-height: 340px; }
    .cmd-item { padding: 10px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); transition: background 0.1s; }
    .cmd-item:hover, .cmd-item.selected { background: var(--surface2); }
    .cmd-item-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 13px; flex-shrink: 0; }
    .cmd-item-icon.app { background: rgba(59,130,246,0.15); color: var(--blue); }
    .cmd-item-icon.command { background: rgba(168,85,247,0.15); color: var(--purple); }
    .cmd-item-icon.action { background: rgba(249,115,22,0.15); color: var(--orange); }
    .cmd-item-text { flex: 1; }
    .cmd-item-name { font-size: 13px; font-weight: 500; }
    .cmd-item-desc { font-size: 11px; color: var(--text-muted); }
    .cmd-item-shortcut { font-size: 10px; color: var(--text-muted); background: var(--surface3); padding: 2px 6px; border-radius: 4px; }
    .cmd-hint { padding: 8px 20px; font-size: 10px; color: var(--text-muted); text-align: center; border-top: 1px solid var(--border); }

    /* Morning Briefing */
    .briefing-panel { display: none; padding: 20px 32px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--surface) 0%, rgba(59,130,246,0.03) 100%); }
    .briefing-panel.active { display: block; }
    .briefing-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .briefing-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--blue); font-weight: 600; }
    .briefing-body { font-size: 13px; line-height: 1.7; color: var(--text); }
    .briefing-body strong { color: var(--text); }
    .briefing-body ul { padding-left: 20px; margin: 6px 0; }
    .briefing-body li { margin: 4px 0; }
    .briefing-body h2, .briefing-body h3 { font-size: 13px; color: var(--text-dim); margin: 10px 0 4px; }
    .briefing-meta { margin-top: 10px; font-size: 10px; color: var(--text-muted); }
    .briefing-actions { display: flex; gap: 8px; }

    /* Healing Panel */
    .healing-panel { display: none; padding: 12px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .healing-panel.active { display: block; }
    .security-panel { display: none; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .security-panel.active { display: block; animation: tabFadeIn 0.3s ease; }
    .sec-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 14px; }
    .sec-tab { background: none; border: none; color: var(--text-dim); font-size: 12px; padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .sec-tab:hover { color: var(--text); }
    .sec-tab.active { color: var(--text); border-bottom-color: var(--cyan); }
    .sec-tab-content { display: none; }
    .sec-tab-content.active { display: block; }
    .sec-score-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
    .sec-score-big { font-size: 42px; font-weight: 700; line-height: 1; }
    .sec-grade { font-size: 18px; font-weight: 700; display: inline-block; padding: 2px 10px; border-radius: 6px; margin-top: 4px; }
    .sec-category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 12px; }
    .sec-cat-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
    .sec-cat-card h4 { font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 6px; }
    .sec-cat-score { font-size: 24px; font-weight: 700; }
    .sec-findings-summary { display: flex; gap: 12px; margin-top: 14px; flex-wrap: wrap; }
    .sec-count { font-size: 12px; padding: 4px 10px; border-radius: 6px; font-weight: 600; }
    .sec-count.critical { background: rgba(239,68,68,0.15); color: var(--red); }
    .sec-count.high { background: rgba(249,115,22,0.15); color: var(--orange); }
    .sec-count.medium { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .sec-count.low { background: rgba(34,197,94,0.15); color: var(--green); }
    .sec-finding { padding: 10px 14px; border-radius: 6px; background: var(--surface2); border: 1px solid var(--border); margin-bottom: 4px; font-size: 12px; display: flex; align-items: flex-start; gap: 10px; }
    .sec-finding.critical { border-left: 3px solid var(--red); }
    .sec-finding.high { border-left: 3px solid var(--orange); }
    .sec-finding.medium { border-left: 3px solid var(--yellow); }
    .sec-finding.low { border-left: 3px solid var(--green); }
    .sec-finding .sec-badge { font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 700; text-transform: uppercase; white-space: nowrap; flex-shrink: 0; }
    .sec-badge.critical { background: rgba(239,68,68,0.15); color: var(--red); }
    .sec-badge.high { background: rgba(249,115,22,0.15); color: var(--orange); }
    .sec-badge.medium { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .sec-badge.low { background: rgba(34,197,94,0.15); color: var(--green); }
    .sec-finding-body { flex: 1; }
    .sec-finding-title { font-weight: 500; margin-bottom: 3px; }
    .sec-finding-remediation { font-size: 11px; color: var(--text-dim); margin-top: 4px; padding: 4px 8px; background: var(--surface3); border-radius: 4px; font-family: monospace; cursor: pointer; }
    .sec-finding-remediation:hover { background: var(--border); }
    .sec-dismiss-btn { font-size: 10px; padding: 2px 8px; background: none; border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); cursor: pointer; flex-shrink: 0; }
    .sec-dismiss-btn:hover { background: var(--surface3); color: var(--text); }
    .sec-container-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .sec-container-name { font-size: 13px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .sec-checks-grid { display: flex; flex-wrap: wrap; gap: 4px; }
    .sec-check { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
    .sec-check.pass { background: rgba(34,197,94,0.1); color: var(--green); }
    .sec-check.fail { background: rgba(239,68,68,0.1); color: var(--red); }
    .sec-domain-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .sec-domain-name { font-size: 13px; font-weight: 600; margin-bottom: 8px; }
    .sec-header-actions { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .sec-scan-btn { font-size: 12px; padding: 6px 14px; background: var(--cyan); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .sec-scan-btn:hover { opacity: 0.9; }
    .sec-scan-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .sec-timestamp { font-size: 10px; color: var(--text-muted); }
    /* Projects Manager */
    .projects-panel { display: none; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .projects-panel.active { display: block; animation: tabFadeIn 0.3s ease; }
    .proj-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 14px; }
    .proj-tab { background: none; border: none; color: var(--text-dim); font-size: 12px; padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .proj-tab:hover { color: var(--text); }
    .proj-tab.active { color: var(--text); border-bottom-color: var(--purple); }
    .proj-tab-content { display: none; }
    .proj-tab-content.active { display: block; }
    .proj-kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 14px; }
    .proj-kpi { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; text-align: center; }
    .proj-kpi-value { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .proj-kpi-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px; }
    .proj-lifecycle-strip { display: flex; gap: 8px; margin-bottom: 14px; overflow-x: auto; }
    .proj-lane { flex: 0 0 auto; min-width: 120px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; }
    .proj-lane-title { font-size: 9px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); font-weight: 600; margin-bottom: 6px; }
    .proj-chip { font-size: 11px; padding: 3px 8px; border-radius: 4px; margin-bottom: 3px; background: var(--surface3); border: 1px solid var(--border); cursor: pointer; white-space: nowrap; }
    .proj-chip:hover { border-color: var(--border-hover); }
    .proj-app-row { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; font-size: 12px; }
    .proj-app-row:hover { border-color: var(--border-hover); }
    .proj-lifecycle-badge { font-size: 9px; padding: 2px 8px; border-radius: 3px; font-weight: 600; text-transform: uppercase; }
    .proj-lifecycle-badge.idea { background: rgba(85,85,104,0.2); color: var(--text-muted); }
    .proj-lifecycle-badge.development { background: rgba(59,130,246,0.15); color: var(--blue); }
    .proj-lifecycle-badge.beta { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .proj-lifecycle-badge.launched { background: rgba(34,197,94,0.15); color: var(--green); }
    .proj-lifecycle-badge.mature { background: rgba(6,182,212,0.15); color: var(--cyan); }
    .proj-lifecycle-badge.deprecated { background: rgba(239,68,68,0.1); color: var(--red); }
    .proj-priority-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .proj-priority-dot.p1 { background: var(--red); }
    .proj-priority-dot.p2 { background: var(--yellow); }
    .proj-priority-dot.p3 { background: var(--text-muted); }
    .proj-priority-dot.p4 { background: var(--text-muted); opacity: 0.4; }
    .proj-task-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 4px; font-size: 12px; cursor: default; }
    .proj-task-row:hover { border-color: var(--border-hover); }
    .proj-task-row.done { opacity: 0.5; }
    .proj-task-row.done .proj-task-title { text-decoration: line-through; }
    .proj-task-title { flex: 1; font-weight: 500; }
    .proj-task-due { font-size: 10px; color: var(--text-muted); white-space: nowrap; }
    .proj-task-due.overdue { color: var(--red); font-weight: 600; }
    .proj-task-app { font-size: 9px; padding: 1px 6px; border-radius: 3px; background: rgba(168,85,247,0.1); color: var(--purple); white-space: nowrap; }
    .proj-task-priority { width: 4px; height: 16px; border-radius: 2px; flex-shrink: 0; }
    .proj-task-priority.critical { background: var(--red); }
    .proj-task-priority.high { background: var(--orange); }
    .proj-task-priority.medium { background: var(--yellow); }
    .proj-task-priority.low { background: var(--text-muted); }
    .proj-kanban { display: flex; gap: 10px; overflow-x: auto; }
    .proj-kanban-col { flex: 1; min-width: 220px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
    .proj-kanban-col-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .proj-kanban-card { background: var(--surface3); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .proj-kanban-card:hover { border-color: var(--border-hover); transform: translateY(-1px); }
    .proj-impact-badge, .proj-effort-badge { font-size: 9px; padding: 1px 5px; border-radius: 3px; font-weight: 500; }
    .proj-impact-badge.high { background: rgba(34,197,94,0.15); color: var(--green); }
    .proj-impact-badge.medium { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .proj-impact-badge.low { background: rgba(85,85,104,0.15); color: var(--text-muted); }
    .proj-effort-badge.high { background: rgba(239,68,68,0.1); color: var(--red); }
    .proj-effort-badge.medium { background: rgba(234,179,8,0.1); color: var(--yellow); }
    .proj-effort-badge.low { background: rgba(34,197,94,0.1); color: var(--green); }
    .proj-insight-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; margin-bottom: 10px; }
    .proj-insight-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
    .proj-insight-content { font-size: 12px; color: var(--text-dim); line-height: 1.6; white-space: pre-wrap; }
    .proj-filter-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .proj-filter-bar select { font-size: 11px; padding: 4px 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--text); }
    .proj-overdue-banner { background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.3); border-radius: 6px; padding: 8px 12px; font-size: 12px; color: var(--yellow); margin-bottom: 10px; }
    .proj-form { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; margin-bottom: 12px; display: none; }
    .proj-form.active { display: block; }
    .proj-form input, .proj-form select, .proj-form textarea { font-size: 12px; padding: 6px 10px; background: var(--surface3); border: 1px solid var(--border); border-radius: 4px; color: var(--text); width: 100%; }
    .proj-form textarea { min-height: 60px; resize: vertical; font-family: inherit; }
    .proj-form-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-end; flex-wrap: wrap; }
    .proj-form-field { flex: 1; min-width: 120px; }
    .proj-form-field label { display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Ops Intelligence Panel */
    .ops-panel { display: none; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .ops-panel.active { display: block; animation: tabFadeIn 0.3s ease; }
    .ops-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 14px; }
    .ops-tab { background: none; border: none; color: var(--text-dim); font-size: 12px; padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .ops-tab:hover { color: var(--text); }
    .ops-tab.active { color: var(--text); border-bottom-color: #f97316; }
    .ops-tab-content { display: none; }
    .ops-tab-content.active { display: block; }
    .worry-score-display { text-align: center; padding: 20px; }
    .worry-score-number { font-size: 64px; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; }
    .worry-score-number.green { color: var(--green); }
    .worry-score-number.yellow { color: #eab308; }
    .worry-score-number.orange { color: #f97316; }
    .worry-score-number.red { color: var(--red); }
    .worry-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-top: 4px; }
    .worry-breakdown { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-top: 16px; }
    .worry-factor { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; }
    .worry-factor-score { font-size: 20px; font-weight: 700; }
    .worry-factor-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
    .streak-display { display: inline-flex; align-items: center; gap: 8px; justify-content: center; margin-top: 12px; padding: 8px 16px; background: var(--surface2); border-radius: 8px; }
    .streak-count { font-size: 18px; font-weight: 700; color: #f97316; }
    .streak-label { font-size: 11px; color: var(--text-muted); }
    .heartbeat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 12px; }
    .heartbeat-app { text-align: center; padding: 12px 8px; border-radius: 8px; background: var(--surface2); border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .heartbeat-app:hover { border-color: var(--text-muted); transform: scale(1.05); }
    .heartbeat-dot { width: 20px; height: 20px; border-radius: 50%; margin: 0 auto 6px; }
    .heartbeat-dot.healthy { background: var(--green); box-shadow: 0 0 12px rgba(34,197,94,0.4); animation: heartPulse 2s ease infinite; }
    .heartbeat-dot.unhealthy { background: var(--red); box-shadow: 0 0 12px rgba(239,68,68,0.4); animation: heartPulse 0.8s ease infinite; }
    .heartbeat-dot.restarting { background: #eab308; animation: heartPulse 1.2s ease infinite; }
    .heartbeat-dot.degraded { background: #f97316; animation: heartPulse 1.5s ease infinite; }
    .heartbeat-dot.static { background: var(--text-muted); opacity: 0.5; }
    .heartbeat-name { font-size: 10px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    @keyframes heartPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.15)} }
    .report-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
    .report-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .report-card-grade { font-size: 28px; font-weight: 800; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
    .report-card-grade.A { background: rgba(34,197,94,0.15); color: var(--green); }
    .report-card-grade.B { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .report-card-grade.C { background: rgba(234,179,8,0.15); color: #eab308; }
    .report-card-grade.D { background: rgba(249,115,22,0.15); color: #f97316; }
    .report-card-grade.F { background: rgba(239,68,68,0.15); color: var(--red); }
    .report-dims { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px; }
    .report-dim { text-align: center; padding: 4px 2px; border-radius: 4px; }
    .report-dim-score { font-size: 12px; font-weight: 700; }
    .report-dim-label { font-size: 8px; text-transform: uppercase; color: var(--text-muted); }
    .dep-shared-key { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 6px; }
    .dep-key-name { font-size: 12px; font-weight: 600; color: var(--cyan); margin-bottom: 4px; }
    .dep-app-list { display: flex; flex-wrap: wrap; gap: 4px; }
    .dep-app-badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: rgba(59,130,246,0.1); color: #3b82f6; }
    body.adhd-mode .heartbeat-app.ok { opacity: 0.2; }
    body.adhd-mode .worry-factor.zero { opacity: 0.2; }
    body.adhd-mode .report-card.grade-a, body.adhd-mode .report-card.grade-b { opacity: 0.2; }
    .worry-badge { font-size: 9px; padding: 1px 5px; border-radius: 3px; margin-left: 4px; font-weight: 700; }
    .worry-badge.green { background: rgba(34,197,94,0.15); color: var(--green); }
    .worry-badge.yellow { background: rgba(234,179,8,0.15); color: #eab308; }
    .worry-badge.orange { background: rgba(249,115,22,0.15); color: #f97316; }
    .worry-badge.red { background: rgba(239,68,68,0.15); color: var(--red); }
    .ops-event { padding: 8px 12px; border-radius: 6px; background: var(--surface2); border: 1px solid var(--border); margin-bottom: 4px; font-size: 12px; display: flex; align-items: center; gap: 10px; }
    .ops-event.critical { border-left: 3px solid var(--red); }
    .ops-event.warning { border-left: 3px solid #eab308; }
    .ops-event.info { border-left: 3px solid #3b82f6; }
    .ops-event-time { font-size: 10px; color: var(--text-muted); font-family: monospace; min-width: 65px; }
    .ops-event-title { flex: 1; }
    .ops-event-ack { font-size: 10px; padding: 2px 8px; background: none; border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); cursor: pointer; }
    .ops-event-ack:hover { background: var(--surface3); color: var(--text); }

    .settings-panel { display: none; padding: 20px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .settings-panel.active { display: block; }
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px; }
    .settings-section { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
    .settings-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); }
    .app-config-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; font-size: 13px; }
    .app-config-item .app-config-name { font-weight: 500; }
    .app-config-item .app-config-type { font-size: 11px; color: var(--text-muted); background: var(--surface3); padding: 2px 8px; border-radius: 10px; }
    .app-config-item .app-config-actions { display: flex; gap: 6px; }
    .app-config-item .app-config-actions button { font-size: 11px; padding: 3px 8px; background: none; border: 1px solid var(--border); border-radius: 4px; color: var(--text-dim); cursor: pointer; }
    .app-config-item .app-config-actions button:hover { background: var(--surface3); color: var(--text); }
    .app-config-item .app-config-actions button.danger:hover { background: rgba(239,68,68,0.1); color: var(--red); border-color: var(--red); }
    .discover-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border: 1px solid rgba(34,197,94,0.2); border-radius: 6px; margin-bottom: 6px; font-size: 13px; background: rgba(34,197,94,0.03); }
    .add-app-form { display: none; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 12px; }
    .add-app-form.active { display: block; }
    .add-app-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .add-app-form label { font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.04em; }
    .add-app-form input, .add-app-form select { width: 100%; padding: 6px 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px; }
    .add-app-form input:focus, .add-app-form select:focus { outline: none; border-color: var(--blue); }
    .healing-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--surface2); border-radius: 6px; margin-bottom: 4px; font-size: 12px; border: 1px solid var(--border); }
    .healing-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .healing-badge.executed { background: rgba(34,197,94,0.15); color: var(--green); }
    .healing-badge.pending { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .healing-badge.failed { background: rgba(239,68,68,0.15); color: var(--red); }
    .healing-badge.dismissed { background: rgba(85,85,104,0.15); color: var(--text-muted); }
    .healing-shield { display: inline-flex; align-items: center; gap: 3px; }

    @media (max-width: 768px) {
      .system-bar { grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 12px 16px; }
      .app-grid { grid-template-columns: 1fr; }
      .header, .section { padding-left: 16px; padding-right: 16px; }
      .health-summary { display: none; }
      .docker-bar { grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 0 16px; }
      .modal { width: calc(100vw - 24px); margin: 0 12px; }
    }

    /* === Enhanced UI: Premium touches === */

    /* Glow ring on active health items */
    .hs-item { transition: all 0.2s; }
    .hs-item:hover { background: var(--surface3); }

    /* Section titles with gradient underline */
    .section-title { position: relative; }
    .section-title::after { content:''; display:block; width:40px; height:2px; background:linear-gradient(90deg, var(--cyan), transparent); margin-top:4px; border-radius:1px; }

    /* Docker stat hover glow */
    .docker-stat { transition: all 0.2s; }
    .docker-stat:hover { border-color: var(--border-hover); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    /* Banner/Playbook card enhancements */
    #mktBannersGrid > div, #mktPlaybookGrid > div, #mktCrosspromoGrid > div {
      transition: all 0.2s cubic-bezier(.4,0,.2,1);
    }
    #mktBannersGrid > div:hover, #mktPlaybookGrid > div:hover, #mktCrosspromoGrid > div:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      border-color: var(--border-hover) !important;
    }

    /* Pulse animation for live indicators */
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    @keyframes glow { 0%,100%{box-shadow:0 0 4px rgba(34,197,94,0.3)} 50%{box-shadow:0 0 12px rgba(34,197,94,0.5)} }
    .refresh-dot { animation: glow 2s ease infinite; }

    /* Smooth scrollbar */
    ::-webkit-scrollbar { width:6px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background:var(--border-hover); }

    /* Search focus ring */
    .search-input:focus { border-color: var(--cyan); box-shadow: 0 0 0 3px rgba(6,182,212,0.15); }

    /* Header button glow */
    .header-btn.primary:hover { box-shadow: 0 0 12px rgba(34,197,94,0.2); }

    /* Playbook section cards */
    #mktPlaybookGrid > div { border-left: 3px solid var(--cyan) !important; }
    #mktPlaybookGrid > div:nth-child(2) { border-left-color: var(--blue) !important; }
    #mktPlaybookGrid > div:nth-child(3) { border-left-color: var(--green) !important; }
    #mktPlaybookGrid > div:nth-child(4) { border-left-color: var(--yellow) !important; }
    #mktPlaybookGrid > div:nth-child(5) { border-left-color: var(--purple) !important; }
    #mktPlaybookGrid > div:nth-child(6) { border-left-color: var(--red) !important; }

    /* Banner form styling */
    #bannerFormContainer .search-input, #playbookFormContainer .search-input, #crosspromoFormContainer .search-input {
      background: var(--surface);
      border-color: var(--border);
      transition: all 0.2s;
    }
    #bannerFormContainer .search-input:focus, #playbookFormContainer .search-input:focus, #crosspromoFormContainer .search-input:focus {
      border-color: var(--cyan);
      box-shadow: 0 0 0 3px rgba(6,182,212,0.1);
    }

    /* Login page enhancement */
    .login-container { backdrop-filter: blur(20px); }

    /* === Toast Notifications === */
    .toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
    .toast { pointer-events:auto; padding:10px 16px; border-radius:10px; font-size:12px; font-weight:500; display:flex; align-items:center; gap:8px; backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.08); box-shadow:0 8px 32px rgba(0,0,0,0.4); animation:toastIn 0.3s cubic-bezier(.4,0,.2,1), toastOut 0.3s ease 3.7s forwards; max-width:360px; }
    .toast.success { background:rgba(34,197,94,0.15); color:var(--green); border-color:rgba(34,197,94,0.2); }
    .toast.error { background:rgba(239,68,68,0.15); color:var(--red); border-color:rgba(239,68,68,0.2); }
    .toast.info { background:rgba(59,130,246,0.15); color:var(--blue); border-color:rgba(59,130,246,0.2); }
    .toast.warning { background:rgba(234,179,8,0.15); color:var(--yellow); border-color:rgba(234,179,8,0.2); }
    @keyframes toastIn { from{opacity:0;transform:translateX(40px) scale(0.95)} to{opacity:1;transform:translateX(0) scale(1)} }
    @keyframes toastOut { to{opacity:0;transform:translateX(40px) scale(0.95)} }

    /* === Loading Skeletons === */
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
    .skeleton { background:linear-gradient(90deg, var(--surface2) 25%, var(--surface3) 50%, var(--surface2) 75%); background-size:200% 100%; animation:shimmer 1.5s ease infinite; border-radius:8px; }
    .skeleton-card { height:120px; border-radius:12px; }
    .skeleton-line { height:12px; border-radius:4px; margin-bottom:8px; }
    .skeleton-line.short { width:60%; }
    .skeleton-line.medium { width:80%; }

    /* === Staggered card animations === */
    .marketing-grid > * { animation:cardIn 0.3s cubic-bezier(.4,0,.2,1) both; }
    .marketing-grid > *:nth-child(1) { animation-delay:0s; }
    .marketing-grid > *:nth-child(2) { animation-delay:0.05s; }
    .marketing-grid > *:nth-child(3) { animation-delay:0.1s; }
    .marketing-grid > *:nth-child(4) { animation-delay:0.15s; }
    .marketing-grid > *:nth-child(5) { animation-delay:0.2s; }
    .marketing-grid > *:nth-child(6) { animation-delay:0.25s; }
    .marketing-grid > *:nth-child(n+7) { animation-delay:0.3s; }
    @keyframes cardIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

    /* === Marketing card hover polish === */
    .rev-card, .ana-card, .seo-card, .seq-card, .content-card, .health-card, .crosssell-card {
      transition: all 0.2s cubic-bezier(.4,0,.2,1);
      border-radius: 12px;
    }
    .rev-card:hover, .ana-card:hover, .seo-card:hover, .seq-card:hover, .content-card:hover, .health-card:hover, .crosssell-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      border-color: var(--border-hover);
    }

    /* === Better button states === */
    .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none !important; }
    .btn.loading { position:relative; color:transparent !important; }
    .btn.loading::after { content:''; position:absolute; width:12px; height:12px; border:2px solid var(--text-muted); border-top-color:transparent; border-radius:50%; animation:spin 0.6s linear infinite; }
    @keyframes spin { to{transform:rotate(360deg)} }

    /* === Form enhancements === */
    select.search-input:focus { border-color:var(--cyan); box-shadow:0 0 0 3px rgba(6,182,212,0.15); }
    textarea.search-input:focus { border-color:var(--cyan); box-shadow:0 0 0 3px rgba(6,182,212,0.15); }

    /* === Empty state styling === */
    .empty-state { text-align:center; padding:40px 20px; color:var(--text-muted); }
    .empty-state-icon { font-size:32px; margin-bottom:12px; opacity:0.5; }
    .empty-state-text { font-size:13px; margin-bottom:12px; line-height:1.5; }
    .empty-state .btn { margin:0 4px; }

    /* === Stat pill sparkle on hover === */
    .marketing-stat { transition:all 0.2s; cursor:default; }
    .marketing-stat:hover { background:rgba(255,255,255,0.05); border-color:rgba(255,255,255,0.08); transform:translateY(-1px); }

    /* === Modal scrollbar fix === */
    .modal::-webkit-scrollbar { width:6px; }
    .modal::-webkit-scrollbar-track { background:transparent; }
    .modal::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
    .modal::-webkit-scrollbar-thumb:hover { background:var(--border-hover); }
    .errors-panel { display: none; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .errors-panel.active { display: block; animation: tabFadeIn 0.3s ease; }
    .err-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 14px; }
    .err-tab { background: none; border: none; color: var(--text-dim); font-size: 12px; padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .err-tab:hover { color: var(--text); }
    .err-tab.active { color: var(--text); border-bottom-color: var(--red); }
    .err-tab-content { display: none; }
    .err-tab-content.active { display: block; }
    .err-severity { font-size: 10px; padding: 2px 6px; border-radius: 3px; font-weight: 600; text-transform: uppercase; }
    .err-severity.critical { background: rgba(239,68,68,0.2); color: var(--red); }
    .err-severity.error { background: rgba(239,68,68,0.12); color: #f87171; }
    .err-severity.warning { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .err-severity.info { background: rgba(59,130,246,0.12); color: var(--blue); }
    .err-source { font-size: 9px; padding: 1px 5px; border-radius: 3px; background: var(--surface3); color: var(--text-dim); }
    .err-issue-row { padding: 10px 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; display: flex; align-items: flex-start; gap: 10px; }
    .err-issue-row:hover { background: var(--surface2); }
    .err-issue-expand { display: none; padding: 12px; background: var(--surface3); border-radius: 6px; margin: 4px 12px 8px; font-size: 11px; }
    .err-issue-expand.active { display: block; }
    .err-stack { white-space: pre-wrap; font-family: monospace; font-size: 11px; color: var(--text-dim); background: var(--bg); padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
    .err-bar { height: 20px; border-radius: 3px; min-width: 2px; transition: width 0.3s ease; }
    .err-actions { display: flex; gap: 6px; margin-top: 8px; }
    .err-actions button { font-size: 10px; padding: 3px 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); cursor: pointer; }
    .err-actions button:hover { background: var(--surface3); color: var(--text); }
    .err-perf-cell { text-align: right; font-variant-numeric: tabular-nums; }
    .err-perf-slow { color: var(--yellow); }
    .err-perf-critical { color: var(--red); }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <div class="header">
    <div class="header-left">
      <h1>Dockfolio</h1>
      <div class="health-summary" id="healthSummary"></div>
    </div>
    <div class="header-right">
      <input class="search-input" id="searchInput" type="text" placeholder="Search apps... (/)" oninput="filterApps(this.value)">
      <span class="last-updated" id="lastUpdated"><span class="refresh-dot"></span><span id="countdown"></span></span>
      <button class="header-btn" onclick="toggleActivity()">Activity</button>
      <button class="header-btn" onclick="toggleSSLPanel()">SSL Certs</button>
      <button class="header-btn" onclick="toggleKeyHealth()">API Keys</button>
      <button class="header-btn" onclick="toggleBackups()">Backups</button>
      <button class="header-btn" onclick="toggleBriefing()" id="briefingBtn">Briefing</button>
      <button class="header-btn" onclick="toggleHealing()" id="healingBtn"><span class="healing-shield" id="healingShield">Healing</span></button>
      <button class="header-btn" onclick="toggleSecurity()" id="securityBtn">Security <span id="secGradeBadge" style="font-size:9px;padding:1px 5px;border-radius:3px;margin-left:4px;display:none"></span></button>
      <button class="header-btn" onclick="toggleProjects()" id="projectsBtn">Projects <span id="projTaskBadge" style="font-size:9px;padding:1px 5px;border-radius:3px;margin-left:4px;background:rgba(168,85,247,0.15);color:var(--purple);display:none"></span></button>
      <button class="header-btn" onclick="toggleOps()" id="opsBtn">Ops <span id="worryBadge" class="worry-badge" style="display:none"></span></button>
      <button class="header-btn" onclick="toggleErrors()" id="errorsBtn">Errors <span id="errCountBadge" style="font-size:9px;padding:1px 5px;border-radius:3px;margin-left:4px;background:rgba(239,68,68,0.15);color:var(--red);display:none"></span></button>
      <button class="header-btn" onclick="toggleMarketing()">Marketing</button>
      <a class="header-btn primary" href="/uptime/status-page/status" target="_blank">Status Page</a>
      <button class="header-btn" onclick="dockerPrune(this)">Prune</button>
      <a class="header-btn" href="/uptime/" target="_blank">Uptime Kuma</a>
      <button class="header-btn" onclick="toggleSettings()">Settings</button>
      <button class="header-btn" onclick="logout()" title="Sign out" style="color:var(--red)">Logout</button>
    </div>
  </div>

  <div class="system-bar" id="systemBar">
    <div class="metric">
      <div class="metric-top">
        <span class="metric-label">Memory</span>
        <span class="metric-value" id="memValue">--</span>
      </div>
      <div class="metric-bar"><div class="metric-bar-fill" id="memBar"></div></div>
      <div class="metric-detail" id="memDetail"></div>
    </div>
    <div class="metric">
      <div class="metric-top">
        <span class="metric-label">Swap</span>
        <span class="metric-value" id="swapValue">--</span>
      </div>
      <div class="metric-bar"><div class="metric-bar-fill" id="swapBar"></div></div>
      <div class="metric-detail" id="swapDetail"></div>
    </div>
    <div class="metric">
      <div class="metric-top">
        <span class="metric-label">Disk</span>
        <span class="metric-value" id="diskValue">--</span>
      </div>
      <div class="metric-bar"><div class="metric-bar-fill" id="diskBar"></div></div>
      <div class="metric-detail" id="diskDetail"></div>
    </div>
    <div class="metric">
      <div class="metric-top">
        <span class="metric-label">Load</span>
        <span class="metric-value" id="loadValue">--</span>
      </div>
      <div class="metric-bar"><div class="metric-bar-fill" id="loadBar"></div></div>
      <div class="metric-detail" id="loadDetail"></div>
    </div>
  </div>

  <div id="activityPanel" class="activity-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:12px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);font-weight:600">Recent Activity (6h)</span>
      <span id="activityCount" style="font-size:11px;color:var(--text-muted);background:var(--surface2);padding:2px 8px;border-radius:10px"></span>
    </div>
    <div class="activity-list" id="activityList"></div>
  </div>

  <div id="sslPanel" style="display:none;padding:12px 32px;border-bottom:1px solid var(--border);background:var(--surface)">
    <div style="font-size:12px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);margin-bottom:8px;font-weight:600">SSL Certificates</div>
    <div id="sslList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:6px"></div>
  </div>

  <div id="keyHealthPanel" class="key-health-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:12px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);font-weight:600">API Key Health</span>
      <button class="btn" onclick="fetchKeyHealth(true)">Recheck</button>
    </div>
    <div class="key-health-grid" id="keyHealthGrid"></div>
  </div>

  <div id="backupPanel" class="key-health-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:12px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);font-weight:600">Database Backups</span>
    </div>
    <div class="key-health-grid" id="backupGrid"></div>
  </div>

  <div id="briefingPanel" class="briefing-panel">
    <div class="briefing-header">
      <span class="briefing-title">Morning Briefing</span>
      <div class="briefing-actions">
        <button class="btn" onclick="fetchBriefing(true)">Refresh</button>
        <button class="btn" onclick="dismissBriefing()">Dismiss</button>
      </div>
    </div>
    <div class="briefing-body" id="briefingBody"><span style="color:var(--text-muted)">Loading briefing...</span></div>
    <div class="briefing-meta" id="briefingMeta"></div>
  </div>

  <div id="healingPanel" class="healing-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:12px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);font-weight:600">Auto-Healing Log</span>
      <button class="btn" onclick="fetchHealingLog()">Refresh</button>
    </div>
    <div id="healingList"></div>
  </div>

  <div id="securityPanel" class="security-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <span style="font-size:14px;font-weight:600">Security Manager</span>
      <div class="sec-header-actions">
        <span class="sec-timestamp" id="secLastScan"></span>
        <button class="sec-scan-btn" id="secScanBtn" onclick="runSecurityScan()">Run Scan</button>
      </div>
    </div>
    <div class="sec-tabs">
      <button class="sec-tab active" onclick="switchSecTab('dashboard',this)">Dashboard</button>
      <button class="sec-tab" onclick="switchSecTab('containers',this)">Containers</button>
      <button class="sec-tab" onclick="switchSecTab('certificates',this)">Certificates</button>
      <button class="sec-tab" onclick="switchSecTab('headers',this)">Headers</button>
      <button class="sec-tab" onclick="switchSecTab('network',this)">Network</button>
    </div>
    <div id="sec-dashboard" class="sec-tab-content active"><div id="secDashboardContent"><span style="color:var(--text-muted);font-size:12px">Press "Run Scan" to audit your infrastructure security.</span></div></div>
    <div id="sec-containers" class="sec-tab-content"><div id="secContainersContent"></div></div>
    <div id="sec-certificates" class="sec-tab-content"><div id="secCertificatesContent"></div></div>
    <div id="sec-headers" class="sec-tab-content"><div id="secHeadersContent"></div></div>
    <div id="sec-network" class="sec-tab-content"><div id="secNetworkContent"></div></div>
  </div>

  <div id="projectsPanel" class="projects-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <span style="font-size:14px;font-weight:600">Projects Manager</span>
      <button class="btn" onclick="fetchProjectsOverview(true)" style="font-size:11px;color:var(--purple)">Refresh</button>
    </div>
    <div class="proj-tabs">
      <button class="proj-tab active" onclick="switchProjTab('overview',this)">Overview</button>
      <button class="proj-tab" onclick="switchProjTab('tasks',this)">Tasks</button>
      <button class="proj-tab" onclick="switchProjTab('roadmap',this)">Roadmap</button>
      <button class="proj-tab" onclick="switchProjTab('insights',this)">Insights</button>
    </div>
    <div id="proj-overview" class="proj-tab-content active"><div id="projOverviewContent"><span style="color:var(--text-muted);font-size:12px">Loading...</span></div></div>
    <div id="proj-tasks" class="proj-tab-content"><div id="projTasksContent"></div></div>
    <div id="proj-roadmap" class="proj-tab-content"><div id="projRoadmapContent"></div></div>
    <div id="proj-insights" class="proj-tab-content"><div id="projInsightsContent"></div></div>
  </div>

  <div id="opsPanel" class="ops-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <span style="font-size:14px;font-weight:600">Ops Intelligence</span>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" onclick="toggleADHDMode()" title="ADHD Mode: show only issues" id="adhdModeBtn">ADHD</button>
        <button class="btn" onclick="createBaseline()">Snapshot Baseline</button>
        <button class="btn" onclick="fetchOpsAll(true)">Refresh</button>
      </div>
    </div>
    <div class="ops-tabs">
      <button class="ops-tab active" onclick="switchOpsTab('pulse',this)">Pulse</button>
      <button class="ops-tab" onclick="switchOpsTab('keys',this)">Keys &amp; Deps</button>
      <button class="ops-tab" onclick="switchOpsTab('reportcards',this)">Report Cards</button>
      <button class="ops-tab" onclick="switchOpsTab('timeline',this)">Timeline</button>
    </div>
    <div id="ops-pulse" class="ops-tab-content active"><div id="opsPulseContent"><span style="color:var(--text-muted);font-size:12px">Loading...</span></div></div>
    <div id="ops-keys" class="ops-tab-content"><div id="opsKeysContent"></div></div>
    <div id="ops-reportcards" class="ops-tab-content"><div id="opsReportCardsContent"></div></div>
    <div id="ops-timeline" class="ops-tab-content"><div id="opsTimelineContent"></div></div>
  </div>

  <div id="errorsPanel" class="errors-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <span style="font-size:14px;font-weight:600">Error Tracker</span>
      <div style="display:flex;gap:6px;align-items:center">
        <span style="font-size:10px;color:var(--text-muted)" id="errLastUpdate"></span>
        <button class="btn" onclick="fetchErrorsOverview()">Refresh</button>
      </div>
    </div>
    <div class="err-tabs">
      <button class="err-tab active" onclick="switchErrTab('overview',this)">Overview</button>
      <button class="err-tab" onclick="switchErrTab('issues',this)">Issues</button>
      <button class="err-tab" onclick="switchErrTab('events',this)">Events</button>
      <button class="err-tab" onclick="switchErrTab('perf',this)">Performance</button>
    </div>
    <div id="err-overview" class="err-tab-content active"><div id="errOverviewContent"><span style="color:var(--text-muted);font-size:12px">Loading...</span></div></div>
    <div id="err-issues" class="err-tab-content"><div id="errIssuesContent"></div></div>
    <div id="err-events" class="err-tab-content"><div id="errEventsContent"></div></div>
    <div id="err-perf" class="err-tab-content"><div id="errPerfContent"></div></div>
  </div>

  <div id="settingsPanel" class="settings-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <span style="font-size:12px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);font-weight:600">Settings</span>
      <div style="display:flex;gap:6px">
        <button class="btn" onclick="loadSettings()">Refresh</button>
        <button class="btn" onclick="toggleSettings()">Close</button>
      </div>
    </div>
    <div class="settings-grid">
      <div class="settings-section">
        <h3>Configured Apps (<span id="configAppCount">0</span>)</h3>
        <div id="configAppList"></div>
      </div>
      <div class="settings-section">
        <h3>Discovered Containers</h3>
        <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Docker containers not yet tracked by Dockfolio</p>
        <div id="discoverList"></div>
      </div>
    </div>
    <div id="addAppForm" class="add-app-form">
      <h3 style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--text)">Add New App</h3>
      <div class="form-row">
        <div><label>Name *</label><input type="text" id="addAppName" placeholder="My App"></div>
        <div><label>Type</label><select id="addAppType"><option value="app">App</option><option value="saas">SaaS</option><option value="tool">Tool</option><option value="static">Static</option><option value="infra">Infra</option></select></div>
      </div>
      <div class="form-row">
        <div><label>Domain</label><input type="text" id="addAppDomain" placeholder="myapp.example.com"></div>
        <div><label>Port</label><input type="number" id="addAppPort" placeholder="3000"></div>
      </div>
      <div class="form-row">
        <div><label>Health Endpoint</label><input type="text" id="addAppHealth" placeholder="/" value="/"></div>
        <div><label>Description</label><input type="text" id="addAppDesc" placeholder="What does this app do?"></div>
      </div>
      <div class="form-row">
        <div><label>Containers (comma-separated)</label><input type="text" id="addAppContainers" placeholder="myapp-web-1, myapp-db-1"></div>
        <div><label>Tech Stack</label><input type="text" id="addAppTech" placeholder="Node.js + PostgreSQL"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="submitAddApp()" style="background:var(--green);color:#000;font-weight:600">Add App</button>
        <button class="btn" onclick="cancelAddApp()">Cancel</button>
      </div>
      <div id="addAppError" style="color:var(--red);font-size:12px;margin-top:6px;display:none"></div>
    </div>
  </div>

  <div class="cmd-overlay" id="cmdOverlay">
    <div class="cmd-box">
      <input class="cmd-input" id="cmdInput" type="text" placeholder="Type a command or app name..." autocomplete="off">
      <div class="cmd-results" id="cmdResults"></div>
      <div class="cmd-hint">Type to search &middot; &uarr;&darr; to navigate &middot; Enter to execute &middot; Esc to close</div>
    </div>
  </div>

  <div id="marketingPanel" class="marketing-panel">
    <div class="mkt-header">
      <span class="mkt-header-title">Marketing Manager</span>
      <span id="mktLastUpdated" style="font-size:10px;color:var(--text-muted)"></span>
    </div>
    <div class="mkt-tabs">
      <button class="mkt-tab active" onclick="switchMktTab('overview',this)">Overview</button>
      <button class="mkt-tab" onclick="switchMktTab('revenue',this)">Revenue</button>
      <button class="mkt-tab" onclick="switchMktTab('traffic',this)">Traffic</button>
      <button class="mkt-tab" onclick="switchMktTab('seo',this)">SEO</button>
      <button class="mkt-tab" onclick="switchMktTab('emails',this)">Emails</button>
      <button class="mkt-tab" onclick="switchMktTab('content',this)">Content</button>
      <button class="mkt-tab" onclick="switchMktTab('crosspromo',this)">Cross-Promo</button>
      <button class="mkt-tab" onclick="switchMktTab('banners',this)">Banners</button>
      <button class="mkt-tab" onclick="switchMktTab('playbook',this)">Playbook</button>
    </div>
    <div id="mkt-overview" class="mkt-tab-content active">
      <div id="mktOverviewContent"><span style="color:var(--text-muted);font-size:12px">Loading...</span></div>
    </div>
    <div id="mkt-revenue" class="mkt-tab-content">
      <div class="mkt-subtabs">
        <button class="mkt-subtab active" onclick="switchRevenueSubtab('overview', this)">Revenue</button>
        <button class="mkt-subtab" onclick="switchRevenueSubtab('cohorts', this)">Cohorts</button>
      </div>
      <div id="rev-sub-overview" class="mkt-subtab-content active">
        <div id="mktRevenueSummary" class="marketing-summary"></div>
        <div id="mktRevenueGrid" class="marketing-grid"></div>
      </div>
      <div id="rev-sub-cohorts" class="mkt-subtab-content">
        <div id="mktCohortsSummary" class="marketing-summary"></div>
        <div id="mktCohortsContent"><span style="color:var(--text-muted);font-size:12px">Click to load cohort data...</span></div>
      </div>
    </div>
    <div id="mkt-traffic" class="mkt-tab-content">
      <div id="mktTrafficSummary" class="marketing-summary"></div>
      <div id="mktTrafficGrid" class="marketing-grid"></div>
    </div>
    <div id="mkt-seo" class="mkt-tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div id="marketingSummary" class="marketing-summary"></div>
        <button class="btn" onclick="fetchSEO(true)">Re-scan</button>
      </div>
      <div id="marketingGrid" class="marketing-grid"></div>
    </div>
    <div id="mkt-emails" class="mkt-tab-content">
      <div id="mktEmailsSummary" class="marketing-summary"></div>
      <div class="mkt-subtabs" style="margin-top:4px">
        <button class="mkt-subtab active" onclick="switchEmailsSubtab('sequences', this)">Sequences</button>
        <button class="mkt-subtab" onclick="switchEmailsSubtab('queue', this)">Queue</button>
      </div>
      <div id="email-sub-sequences" class="mkt-subtab-content active">
        <div id="mktSequencesGrid" class="marketing-grid"></div>
      </div>
      <div id="email-sub-queue" class="mkt-subtab-content">
        <div id="mktQueueContent"></div>
      </div>
    </div>
    <div id="mkt-content" class="mkt-tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div id="mktContentSummary" class="marketing-summary"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="contentAppFilter" class="search-input" onchange="fetchMktContent()" style="width:auto">
            <option value="">All Apps</option>
          </select>
          <select id="contentStatusFilter" class="search-input" onchange="fetchMktContent()" style="width:auto">
            <option value="">All</option>
            <option value="draft">Drafts</option>
            <option value="approved">Approved</option>
            <option value="published">Published</option>
            <option value="rejected">Rejected</option>
          </select>
          <button class="btn" onclick="showGenerateForm()" style="color:var(--cyan)">+ Generate</button>
        </div>
      </div>
      <div id="generateFormContainer" style="display:none;margin-bottom:12px">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
          <div style="font-size:12px;font-weight:600;margin-bottom:10px">Generate Content</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div>
              <label style="font-size:10px;color:var(--text-muted)">App</label>
              <select id="genAppSlug" class="search-input" style="width:auto;display:block;margin-top:2px"></select>
            </div>
            <div>
              <label style="font-size:10px;color:var(--text-muted)">Type</label>
              <select id="genContentType" class="search-input" style="width:auto;display:block;margin-top:2px">
                <option value="meta_description">Meta Description</option>
                <option value="title">Title</option>
                <option value="blog_outline">Blog Outline</option>
                <option value="faq_schema">FAQ Schema</option>
                <option value="comparison_page">Comparison Page</option>
              </select>
            </div>
            <div style="flex:1;min-width:150px">
              <label style="font-size:10px;color:var(--text-muted)">Keyword</label>
              <input id="genKeyword" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="e.g. AI video generator">
            </div>
            <button class="btn" id="genSubmitBtn" onclick="submitGenerate()" style="color:var(--cyan);padding:6px 16px">Generate</button>
            <button class="btn" onclick="hideGenerateForm()" style="color:var(--text-muted)">Cancel</button>
          </div>
        </div>
      </div>
      <div id="mktContentGrid" class="marketing-grid"></div>
    </div>
    <div id="mkt-crosspromo" class="mkt-tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div id="mktCrosspromoSummary" class="marketing-summary"></div>
        <button class="btn" onclick="showCrosspromoForm()" style="color:var(--cyan)">+ New Campaign</button>
      </div>
      <div id="crosspromoFormContainer" style="display:none;margin-bottom:12px">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
          <div style="font-size:12px;font-weight:600;margin-bottom:10px">New Cross-Promotion Campaign</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div style="flex:1;min-width:140px">
              <label style="font-size:10px;color:var(--text-muted)">Name</label>
              <input id="xpName" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="e.g. App A on App B">
            </div>
            <div>
              <label style="font-size:10px;color:var(--text-muted)">Show Banner On</label>
              <select id="xpSourceApp" class="search-input" style="width:auto;display:block;margin-top:2px"></select>
            </div>
            <div>
              <label style="font-size:10px;color:var(--text-muted)">Promote</label>
              <select id="xpTargetApp" class="search-input" style="width:auto;display:block;margin-top:2px"></select>
            </div>
            <div style="flex:1;min-width:140px">
              <label style="font-size:10px;color:var(--text-muted)">Headline</label>
              <input id="xpHeadline" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="Auto-generated if empty">
            </div>
            <div>
              <label style="font-size:10px;color:var(--text-muted)">CTA</label>
              <input id="xpCta" class="search-input" style="width:100px;display:block;margin-top:2px" value="Learn More">
            </div>
            <button class="btn" id="xpSubmitBtn" onclick="submitCrosspromoForm()" style="color:var(--cyan);padding:6px 16px">Create</button>
            <button class="btn" onclick="hideCrosspromoForm()" style="color:var(--text-muted)">Cancel</button>
          </div>
        </div>
      </div>
      <div id="mktCrosspromoGrid" class="marketing-grid"></div>
      <div id="crosspromoEmbed" style="display:none;margin-top:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
        <div style="font-size:12px;font-weight:600;margin-bottom:8px">Embed Code</div>
        <code id="crosspromoEmbedCode" style="font-size:11px;color:var(--cyan);word-break:break-all;display:block;background:var(--surface);padding:8px;border-radius:6px;cursor:pointer" onclick="navigator.clipboard.writeText(this.textContent)"></code>
        <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Click to copy. Add this to your site's HTML.</div>
      </div>
    </div>

    <!-- Banners Tab -->
    <div id="mkt-banners" class="mkt-tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div id="mktBannersSummary" class="marketing-summary"></div>
        <button class="btn" onclick="showBannerForm()" style="color:var(--cyan)">+ Create Banner</button>
      </div>
      <div id="bannerFormContainer" style="display:none;margin-bottom:12px">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
          <div style="font-size:12px;font-weight:600;margin-bottom:10px">New Banner</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div style="flex:1;min-width:140px">
              <label style="font-size:10px;color:var(--text-muted)">Name</label>
              <input id="bnName" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="e.g. Summer Sale Banner">
            </div>
            <div>
              <label style="font-size:10px;color:var(--text-muted)">Type</label>
              <select id="bnType" class="search-input" style="width:auto;display:block;margin-top:2px" onchange="toggleBannerFields()">
                <option value="bannerforge">BannerForge</option>
                <option value="image_url">Image URL</option>
                <option value="custom_html">Custom HTML</option>
              </select>
            </div>
            <div>
              <label style="font-size:10px;color:var(--text-muted)">Size</label>
              <select id="bnSize" class="search-input" style="width:auto;display:block;margin-top:2px">
                <option value="728x90">728x90 (Leaderboard)</option>
                <option value="300x250">300x250 (Medium Rect)</option>
                <option value="1080x1080">1080x1080 (Square)</option>
                <option value="160x600">160x600 (Skyscraper)</option>
                <option value="320x50">320x50 (Mobile)</option>
              </select>
            </div>
          </div>
          <div id="bnBannerforgeFields" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div style="flex:1;min-width:140px">
              <label style="font-size:10px;color:var(--text-muted)">Headline</label>
              <input id="bnHeadline" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="Banner headline text">
            </div>
            <div>
              <label style="font-size:10px;color:var(--text-muted)">CTA</label>
              <input id="bnCta" class="search-input" style="width:100px;display:block;margin-top:2px" value="Learn More">
            </div>
            <div style="flex:1;min-width:120px">
              <label style="font-size:10px;color:var(--text-muted)">Brand Name</label>
              <input id="bnBrand" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="Company name">
            </div>
          </div>
          <div id="bnUrlField" style="margin-top:8px;display:none">
            <label style="font-size:10px;color:var(--text-muted)">Image URL / HTML Content</label>
            <textarea id="bnContent" class="search-input" style="width:100%;display:block;margin-top:2px;min-height:60px;resize:vertical" placeholder="https://... or <div>...</div>"></textarea>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div style="flex:1;min-width:200px">
              <label style="font-size:10px;color:var(--text-muted)">Click URL</label>
              <input id="bnClickUrl" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="https://example.com">
            </div>
            <button class="btn" id="bnSubmitBtn" onclick="submitBannerForm()" style="color:var(--cyan);padding:6px 16px">Create</button>
            <button class="btn" onclick="hideBannerForm()" style="color:var(--text-muted)">Cancel</button>
          </div>
        </div>
      </div>
      <div id="bannerInjectionStatus" style="display:none;margin-bottom:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-size:11px;font-weight:600">Embed Status</div>
          <button class="btn" onclick="checkInjectionStatus()" style="font-size:10px;color:var(--text-muted);padding:2px 6px">Refresh</button>
        </div>
        <div id="injectionStatusGrid" style="display:flex;flex-wrap:wrap;gap:4px;font-size:10px"></div>
      </div>
      <div id="mktBannersGrid" class="marketing-grid"></div>
      <div id="bannerPlacementPanel" style="display:none;margin-top:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-size:12px;font-weight:600">Placements for: <span id="placementBannerName"></span></div>
          <button class="btn" onclick="closePlacementPanel()" style="color:var(--text-muted);font-size:11px">Close</button>
        </div>
        <div id="placementList"></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
          <div>
            <label style="font-size:10px;color:var(--text-muted)">App</label>
            <select id="plApp" class="search-input" style="width:auto;display:block;margin-top:2px"></select>
          </div>
          <div>
            <label style="font-size:10px;color:var(--text-muted)">Weight</label>
            <input id="plWeight" type="number" class="search-input" style="width:70px;display:block;margin-top:2px" value="100" min="1" max="500">
          </div>
          <button class="btn" onclick="addPlacement()" style="color:var(--green);font-size:11px;padding:3px 10px">+ Add Placement</button>
        </div>
      </div>
    </div>

    <!-- Playbook Tab -->
    <div id="mkt-playbook" class="mkt-tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <select id="playbookAppFilter" class="search-input" style="width:auto" onchange="fetchPlaybook()"></select>
          <div id="mktPlaybookSummary" class="marketing-summary"></div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn" onclick="generatePlaybook()" id="pbGenerateBtn" style="color:var(--purple)">Generate with AI</button>
          <button class="btn" onclick="showPlaybookForm()" style="color:var(--cyan)">+ Add Entry</button>
        </div>
      </div>
      <div id="playbookFormContainer" style="display:none;margin-bottom:12px">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
          <div style="font-size:12px;font-weight:600;margin-bottom:10px">New Playbook Entry</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div>
              <label style="font-size:10px;color:var(--text-muted)">Section</label>
              <select id="pbSection" class="search-input" style="width:auto;display:block;margin-top:2px">
                <option value="strategy">Strategy</option>
                <option value="channels">Channels</option>
                <option value="content">Content Plan</option>
                <option value="seo">SEO</option>
                <option value="email">Email</option>
                <option value="crosssell">Cross-Sell</option>
                <option value="notes">Notes</option>
              </select>
            </div>
            <div style="flex:1;min-width:200px">
              <label style="font-size:10px;color:var(--text-muted)">Title</label>
              <input id="pbTitle" class="search-input" style="width:100%;display:block;margin-top:2px" placeholder="Entry title">
            </div>
          </div>
          <div style="margin-top:8px">
            <label style="font-size:10px;color:var(--text-muted)">Content (Markdown)</label>
            <textarea id="pbContent" class="search-input" style="width:100%;display:block;margin-top:2px;min-height:100px;resize:vertical;font-family:monospace;font-size:12px" placeholder="Write your marketing plan in markdown..."></textarea>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" onclick="submitPlaybookEntry()" style="color:var(--cyan);padding:6px 16px">Save</button>
            <button class="btn" onclick="hidePlaybookForm()" style="color:var(--text-muted)">Cancel</button>
          </div>
        </div>
      </div>
      <div id="mktPlaybookGrid" class="marketing-grid"></div>
    </div>
  </div>

  <div class="docker-bar" id="dockerBar" style="margin-top:12px">
    <div class="docker-stat">
      <div><div class="docker-stat-label">Containers</div><div class="docker-stat-sub" id="dockerContainerSub"></div></div>
      <span class="docker-stat-value" id="dockerContainers">--</span>
    </div>
    <div class="docker-stat">
      <div><div class="docker-stat-label">Images</div><div class="docker-stat-sub" id="dockerImageSub"></div></div>
      <span class="docker-stat-value" id="dockerImages">--</span>
    </div>
    <div class="docker-stat">
      <div><div class="docker-stat-label">Volumes</div></div>
      <span class="docker-stat-value" id="dockerVolumes">--</span>
    </div>
  </div>

  <div id="errorBanner" class="error-banner">
    <span class="error-banner-icon">!</span>
    <div class="error-banner-text">
      <div class="error-banner-title" id="errorTitle"></div>
      <div id="errorDetail"></div>
    </div>
  </div>

  <div id="appSections"></div>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button class="modal-close" onclick="closeModal()">&#x2715;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // CSRF helper  reads token from cookie and injects into state-changing requests
    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|; )_csrf=([^;]*)/);
      return match ? decodeURIComponent(match[1]) : '';
    }
    function apiFetch(url, opts = {}) {
      const method = (opts.method || 'GET').toUpperCase();
      if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
        opts.headers = { ...opts.headers, 'X-CSRF-Token': getCsrfToken() };
      }
      return fetch(url, opts);
    }

    const fmt = (bytes) => {
      if (bytes >= 1e9) return (bytes / 1e9).toFixed(1) + ' GB';
      if (bytes >= 1e6) return (bytes / 1e6).toFixed(0) + ' MB';
      if (bytes >= 1e3) return (bytes / 1e3).toFixed(0) + ' KB';
      return bytes + ' B';
    };

    const formatBytes = fmt;
    const barColor = (pct) => pct > 85 ? 'var(--red)' : pct > 70 ? 'var(--yellow)' : 'var(--green)';
    const barColorName = (pct) => pct > 85 ? 'red' : pct > 70 ? 'yellow' : 'green';

    const uptimeFmt = (secs) => {
      const d = Math.floor(secs / 86400);
      const h = Math.floor((secs % 86400) / 3600);
      const m = Math.floor((secs % 3600) / 60);
      if (d > 0) return `${d}d ${h}h`;
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    };

    const typeLabels = { saas: 'SaaS Products', tool: 'Tools', infra: 'Infrastructure', static: 'Static Sites', redirect: 'Redirects' };
    const typeBadge = { saas: 'badge-saas', tool: 'badge-tool', infra: 'badge-infra', static: 'badge-static', redirect: 'badge-redirect' };
    const typeShort = { saas: 'SaaS', tool: 'Tool', infra: 'Infra', static: 'Static', redirect: 'Redirect' };
    const typeOrder = ['saas', 'tool', 'infra', 'static', 'redirect'];

    let appData = [];
    let statsData = {};
    let systemData = {};
    let uptimeData = {};
    let sslData = {};

    let dockerData = {};
    let keyHealthData = {};
    let envCache = {}; // slug -> env data

    async function logout() {
      await apiFetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    async function fetchAll() {
      try {
        const [appsRes, systemRes, statsRes, dockerRes, uptimeRes, sslRes] = await Promise.all([
          apiFetch('/api/apps'),
          apiFetch('/api/system'),
          apiFetch('/api/containers/stats'),
          apiFetch('/api/docker/overview'),
          apiFetch('/api/uptime'),
          apiFetch('/api/ssl'),
        ]);
        if (appsRes.status === 401) { window.location.href = '/login'; return; }
        if (!appsRes.ok || !systemRes.ok || !statsRes.ok) throw new Error('API error');
        appData = await appsRes.json();
        systemData = await systemRes.json();
        statsData = await statsRes.json();
        if (dockerRes.ok) dockerData = await dockerRes.json();
        if (uptimeRes.ok) uptimeData = await uptimeRes.json();
        if (sslRes.ok) sslData = await sslRes.json();

        renderSystem(systemData);
        renderDocker(dockerData);
        renderApps(appData);
        renderHealthSummary(appData);
        renderErrors(appData, systemData);
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch (err) {
        console.error('Fetch error:', err);
      }
    }

    function renderDocker(d) {
      if (!d.containers) return;
      document.getElementById('dockerContainers').textContent = d.containers.count;
      document.getElementById('dockerContainerSub').textContent = `${d.containers.running} running`;
      document.getElementById('dockerImages').textContent = d.images.count;
      document.getElementById('dockerImageSub').textContent = fmt(d.images.totalSize);
      document.getElementById('dockerVolumes').textContent = d.volumes.count;
    }

    function renderHealthSummary(apps) {
      const counts = { healthy: 0, issues: 0, static: 0 };
      for (const a of apps) {
        if (a.overallHealth === 'healthy' || a.overallHealth === 'running') counts.healthy++;
        else if (a.overallHealth === 'static') counts.static++;
        else counts.issues++;
      }
      const el = document.getElementById('healthSummary');
      el.innerHTML = `
        <span class="hs-item"><span class="status-dot healthy"></span><span class="hs-count">${counts.healthy}</span> healthy</span>
        ${counts.issues > 0 ? `<span class="hs-item"><span class="status-dot unhealthy"></span><span class="hs-count">${counts.issues}</span> issues</span>` : ''}
        <span class="hs-item"><span class="status-dot static"></span><span class="hs-count">${counts.static}</span> static</span>
      `;
    }

    function renderErrors(apps, sys) {
      const issues = [];
      for (const a of apps) {
        if (a.containerStatuses) {
          for (const c of a.containerStatuses) {
            if (c.health === 'restarting') issues.push(`${a.name}: container "${c.name}" is crash-looping`);
            else if (c.health === 'unhealthy') issues.push(`${a.name}: container "${c.name}" is unhealthy`);
          }
        }
      }
      if (sys.disk?.percent > 80) issues.push(`Disk usage at ${sys.disk.percent}%, consider cleanup`);
      if (sys.swap?.percent > 60) issues.push(`Swap at ${sys.swap.percent}%, RAM under pressure`);
      // SSL cert warnings
      if (sslData.domains) {
        for (const [domain, info] of Object.entries(sslData.domains)) {
          if (info.daysLeft != null && info.daysLeft <= 7) issues.push(`SSL cert for ${domain} expires in ${info.daysLeft} days`);
        }
      }
      // Uptime warnings
      if (uptimeData.monitors) {
        for (const [name, mon] of Object.entries(uptimeData.monitors)) {
          if (mon.status === 'down') issues.push(`${name} is DOWN (Uptime Kuma)`);
        }
      }

      const banner = document.getElementById('errorBanner');
      if (issues.length > 0) {
        document.getElementById('errorTitle').textContent = `${issues.length} issue${issues.length > 1 ? 's' : ''} detected`;
        document.getElementById('errorDetail').innerHTML = issues.map(i => `&bull; ${i}`).join('<br>');
        banner.classList.add('visible');
      } else {
        banner.classList.remove('visible');
      }
    }

    function renderSystem(s) {
      const setMetric = (id, pct, detail) => {
        document.getElementById(id + 'Value').textContent = pct + '%';
        const bar = document.getElementById(id + 'Bar');
        bar.style.width = pct + '%';
        bar.style.background = barColor(pct);
        document.getElementById(id + 'Detail').textContent = detail;
      };
      setMetric('mem', s.memory.percent, `${fmt(s.memory.used)} / ${fmt(s.memory.total)}`);
      setMetric('swap', s.swap.percent, `${fmt(s.swap.used)} / ${fmt(s.swap.total)}`);
      setMetric('disk', s.disk.percent, `${fmt(s.disk.used)} / ${fmt(s.disk.total)}`);

      const loadPct = Math.min(Math.round((s.load.avg1 / s.load.cpuCount) * 100), 100);
      document.getElementById('loadValue').textContent = s.load.avg1.toFixed(2);
      const bar = document.getElementById('loadBar');
      bar.style.width = loadPct + '%';
      bar.style.background = barColor(loadPct);
      document.getElementById('loadDetail').textContent = `${s.load.cpuCount} cores | up ${uptimeFmt(s.uptime)}`;
    }

    function renderApps(apps) {
      const filtered = searchTerm
        ? apps.filter(a => a.name.toLowerCase().includes(searchTerm) || a.domain?.toLowerCase().includes(searchTerm) || a.tech?.toLowerCase().includes(searchTerm))
        : apps;

      if (!filtered.length && !searchTerm) {
        document.getElementById('content').innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-muted)">
          <h3>No apps configured</h3>
          <p>Click <b>Settings</b> (or press <b>s</b>) to discover and add your Docker containers.</p>
        </div>`;
        return;
      }

      const grouped = {};
      for (const app of filtered) {
        const type = app.type || 'other';
        if (!grouped[type]) grouped[type] = [];
        grouped[type].push(app);
      }

      let html = '';
      for (const type of typeOrder) {
        const group = grouped[type];
        if (!group || group.length === 0) continue;

        html += `<div class="section">
          <div class="section-header">
            <span class="section-title">${typeLabels[type] || type}</span>
            <span class="section-count">${group.length}</span>
          </div>
          <div class="app-grid">`;

        for (const app of group) {
          const h = app.overallHealth || 'unknown';
          const hasIssue = h === 'unhealthy' || h === 'degraded';
          const hasWarning = h === 'restarting';
          const cardClass = hasIssue ? 'has-issue' : hasWarning ? 'has-warning' : '';

          // Calculate total resource usage for this app
          let totalCpu = 0, totalMem = 0;
          if (app.containerStatuses) {
            for (const c of app.containerStatuses) {
              const s = statsData[c.name] || {};
              totalCpu += s.cpu || 0;
              totalMem += s.memory || 0;
            }
          }

          html += `<div class="app-card ${cardClass}" onclick="openDetail('${app.name}')">
            <div class="app-card-header">
              <span class="app-name"><span class="status-dot ${h}"></span>${app.name}</span>
              <div class="app-badges">
                <span class="badge ${typeBadge[app.type]}">${typeShort[app.type]}</span>
                ${app.hasEnvFile ? (app.hasSentry ? '<span class="badge-sentry">S</span>' : '<span class="badge-no-sentry">!S</span>') : ''}
              </div>
            </div>
            <div class="app-domain"><a href="https://${app.domain}" target="_blank" onclick="event.stopPropagation()">${app.domain}</a></div>
            <div class="app-desc">${app.description || ''}</div>
            <div class="app-meta">`;

          // Uptime data from Kuma
          const um = uptimeData.monitors?.[app.name];
          const ssl = sslData.domains?.[app.domain];

          if (app.containerStatuses && app.containerStatuses.length > 0) {
            html += `<span class="app-meta-item">${app.containerStatuses.length} containers</span>`;
            if (totalCpu > 0) html += `<span class="app-meta-item">${totalCpu.toFixed(1)}% CPU</span>`;
            if (totalMem > 0) html += `<span class="app-meta-item">${fmt(totalMem)} RAM</span>`;
          } else if (app.type === 'redirect') {
            html += `<span class="app-meta-item">&#8594; ${app.redirectTo || ''}</span>`;
          } else {
            html += `<span class="app-meta-item">${app.tech || 'static'}</span>`;
          }
          if (um?.uptime24h != null) {
            const uColor = um.uptime24h >= 99.9 ? 'var(--green)' : um.uptime24h >= 95 ? 'var(--yellow)' : 'var(--red)';
            let spark = '';
            if (um.sparkline?.length > 0) {
              spark = '<span class="sparkline">' + um.sparkline.map(s =>
                '<span class="sparkline-bar ' + s + '" style="height:' + (s === 'up' ? '14' : s === 'down' ? '14' : '4') + 'px;' + (s === 'down' ? 'width:3px;' : '') + '"></span>'
              ).join('') + '</span>';
            }
            html += `<span class="app-meta-item" style="color:${uColor}">${um.uptime24h}%${spark}</span>`;
          }
          if (um?.avgPing) {
            html += `<span class="app-meta-item">${um.avgPing}ms</span>`;
          }
          if (ssl?.daysLeft != null && ssl.daysLeft <= 14) {
            const sColor = ssl.daysLeft <= 3 ? 'var(--red)' : 'var(--yellow)';
            html += `<span class="app-meta-item" style="color:${sColor}">SSL: ${ssl.daysLeft}d</span>`;
          }
          html += `</div>`;

          // Mini health bars for containers
          if (app.containerStatuses && app.containerStatuses.length > 0) {
            html += `<div class="container-bars">`;
            for (const c of app.containerStatuses) {
              html += `<div class="container-bar ${c.health}" title="${c.name}: ${c.health}"></div>`;
            }
            html += `</div>`;
          }
          html += `</div>`;
        }
        html += `</div></div>`;
      }
      document.getElementById('appSections').innerHTML = html;
    }

    let currentModalApp = null;
    let currentModalSlug = null;

    function slugify(name) { return name.toLowerCase().replace(/\s+/g, '-'); }

    async function openDetail(name) {
      const app = appData.find(a => a.name === name);
      if (!app) return;
      currentModalApp = app;
      currentModalSlug = slugify(app.name);

      const h = app.overallHealth || 'unknown';
      document.getElementById('modalTitle').innerHTML = `<span class="status-dot ${h}"></span> ${app.name}`;

      // Build tab bar
      const hasTabs = app.hasEnvFile;
      let tabsHtml = '';
      if (hasTabs) {
        tabsHtml = `<div class="modal-tabs">
          <button class="modal-tab active" onclick="switchTab('overview',this)">Overview</button>
          <button class="modal-tab" onclick="switchTab('env',this)">Environment</button>
        </div>`;
      }

      // Overview content
      const um = uptimeData.monitors?.[app.name];
      const ssl = sslData.domains?.[app.domain];

      let overview = `<dl class="detail-grid">
        <dt>Domain</dt><dd><a href="https://${app.domain}" target="_blank">${app.domain}</a></dd>
        <dt>Type</dt><dd><span class="badge ${typeBadge[app.type]}">${typeShort[app.type]}</span></dd>
        <dt>Tech</dt><dd>${app.tech || 'N/A'}</dd>
        <dt>Status</dt><dd><span class="status-dot ${h}"></span> ${h}</dd>
        ${app.port ? `<dt>Port</dt><dd>${app.port}</dd>` : ''}
        ${app.repo ? `<dt>Path</dt><dd style="font-family:monospace;font-size:12px">${app.repo}</dd>` : ''}
        ${um?.uptime24h != null ? `<dt>Uptime (24h)</dt><dd style="color:${um.uptime24h >= 99.9 ? 'var(--green)' : um.uptime24h >= 95 ? 'var(--yellow)' : 'var(--red)'}">${um.uptime24h}%</dd>` : ''}
        ${um?.avgPing ? `<dt>Avg Response</dt><dd>${um.avgPing}ms</dd>` : ''}
        ${ssl?.daysLeft != null ? `<dt>SSL Expiry</dt><dd style="color:${ssl.daysLeft <= 7 ? 'var(--red)' : ssl.daysLeft <= 14 ? 'var(--yellow)' : 'var(--green)'}">${ssl.daysLeft} days (${ssl.issuer})</dd>` : ''}
      </dl>`;

      if (um?.pingHistory?.length > 2) {
        overview += `<h3 style="font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-dim)">Response Time</h3>`;
        overview += renderPingChart(um.pingHistory);
        overview += `<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-bottom:16px">
          <span>Min: ${Math.min(...um.pingHistory)}ms</span>
          <span>Avg: ${um.avgPing}ms</span>
          <span>Max: ${Math.max(...um.pingHistory)}ms</span>
        </div>`;
      }

      if (app.containerStatuses && app.containerStatuses.length > 0) {
        overview += `<h3 style="font-size:13px;font-weight:600;margin-bottom:10px;color:var(--text-dim)">Containers</h3>`;
        for (const c of app.containerStatuses) {
          const s = statsData[c.name] || {};
          const memPct = s.memoryLimit > 0 ? Math.round((s.memory / s.memoryLimit) * 100) : 0;
          overview += `<div class="container-detail">
            <div class="container-detail-header">
              <span class="container-detail-name"><span class="status-dot ${c.health}"></span>${c.name}</span>
              <span class="container-detail-uptime">${c.uptime || ''}</span>
            </div>
            <div class="container-detail-stats">
              <span><span class="stat-label">CPU</span>${s.cpu !== undefined ? s.cpu.toFixed(2) + '%' : '--'}</span>
              <span><span class="stat-label">RAM</span>${s.memory ? fmt(s.memory) : '--'}${s.memoryLimit && s.memoryLimit < 1e12 ? ' / ' + fmt(s.memoryLimit) + ' (' + memPct + '%)' : ''}</span>
              <span><span class="stat-label">Net</span>${s.netRx ? fmt(s.netRx) + ' in / ' + fmt(s.netTx) + ' out' : '--'}</span>
            </div>
            <div class="btn-row">
              <button class="btn" onclick="viewLogs('${c.name}')">View Logs</button>
              <button class="btn" onclick="viewLogs('${c.name}', 200)">Last 200 lines</button>
              <button class="btn" onclick="restartContainer('${c.name}', this)" style="margin-left:auto;color:var(--yellow)">Restart</button>
            </div>
          </div>`;
        }
      }
      overview += `<div id="logArea"></div>`;

      let body = tabsHtml;
      body += `<div class="modal-body-inner">`;
      body += `<div id="tab-overview" class="modal-tab-content active">${overview}</div>`;
      if (hasTabs) {
        body += `<div id="tab-env" class="modal-tab-content"><div style="color:var(--text-muted);font-size:12px">Loading environment...</div></div>`;
      }
      body += `</div>`;

      document.getElementById('modalBody').innerHTML = body;
      document.getElementById('modal').classList.add('active');

      // Pre-fetch env data
      if (hasTabs) loadEnvTab(currentModalSlug);
    }

    function switchTab(tabName, btn) {
      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.modal-tab-content').forEach(t => t.classList.remove('active'));
      if (btn) btn.classList.add('active');
      const tabEl = document.getElementById('tab-' + tabName);
      if (tabEl) tabEl.classList.add('active');
    }

    let envRevealed = {};

    async function loadEnvTab(slug) {
      try {
        const res = await fetch(`/api/apps/${slug}/env`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        envCache[slug] = data;
        renderEnvTab(slug, data);
      } catch (err) {
        document.getElementById('tab-env').innerHTML = `<div style="color:var(--red);font-size:12px">Error: ${err.message}</div>`;
      }
    }

    function renderEnvTab(slug, data) {
      const missing = [];
      const hasStripe = data.vars.some(v => v.key === 'STRIPE_SECRET_KEY');
      const hasSentry = data.vars.some(v => v.key === 'SENTRY_DSN' || v.key === 'NEXT_PUBLIC_SENTRY_DSN');
      if (!hasSentry) missing.push('SENTRY_DSN');

      let html = '';
      if (missing.length > 0) {
        html += `<div class="env-warning">! Missing recommended: ${missing.join(', ')}</div>`;
      }

      html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <span style="font-size:12px;color:var(--text-muted)">${data.vars.length} variables</span>
        <div style="display:flex;gap:6px">
          <button class="btn" onclick="toggleRevealAll('${slug}')">Reveal All</button>
          <button class="btn" onclick="showAddVar('${slug}')" style="color:var(--green)">+ Add</button>
        </div>
      </div>`;

      html += `<table class="env-table"><tbody>`;
      for (const v of data.vars) {
        const revealed = envRevealed[slug + '::' + v.key];
        const displayValue = revealed ? (revealed === true ? v.value : revealed) : v.value;
        const dotClass = v.empty ? 'empty' : (v.sensitive ? 'present' : 'present');

        html += `<tr class="env-row" data-key="${escapeHtml(v.key)}">
          <td class="env-key"><span class="env-status-dot ${dotClass}"></span>${escapeHtml(v.key)}${v.sensitive ? ' <span style="color:var(--text-muted)">&#128274;</span>' : ''}</td>
          <td class="env-value${v.empty ? ' empty' : ''}" id="env-val-${v.key}">${v.empty ? '(empty)' : escapeHtml(displayValue)}</td>
          <td class="env-actions">
            ${v.sensitive ? `<button class="env-toggle" onclick="toggleReveal('${slug}', '${escapeHtml(v.key)}')">${revealed ? '&#128065;' : '&#128064;'}</button>` : ''}
            <button class="env-toggle" onclick="editEnvVar('${slug}', '${escapeHtml(v.key)}')">&#9998;</button>
          </td>
        </tr>`;
      }
      html += `</tbody></table>`;
      html += `<div id="envAddRow"></div>`;
      html += `<div id="envSaveArea" style="margin-top:12px"></div>`;
      document.getElementById('tab-env').innerHTML = html;
    }

    async function toggleReveal(slug, key) {
      const rKey = slug + '::' + key;
      if (envRevealed[rKey]) {
        delete envRevealed[rKey];
        renderEnvTab(slug, envCache[slug]);
        return;
      }
      // Fetch revealed value
      try {
        const res = await fetch(`/api/apps/${slug}/env?reveal=true`);
        const data = await res.json();
        const v = data.vars.find(v => v.key === key);
        if (v) {
          envRevealed[rKey] = v.value || '(empty)';
          // Update just this cell
          const cell = document.getElementById('env-val-' + key);
          if (cell) cell.textContent = v.value || '(empty)';
        }
      } catch {}
    }

    async function toggleRevealAll(slug) {
      try {
        const res = await fetch(`/api/apps/${slug}/env?reveal=true`);
        const data = await res.json();
        envCache[slug] = data;
        for (const v of data.vars) {
          if (v.sensitive) envRevealed[slug + '::' + v.key] = true;
        }
        renderEnvTab(slug, data);
      } catch {}
    }

    let pendingEnvChanges = {};

    function editEnvVar(slug, key) {
      const row = document.querySelector(`tr[data-key="${key}"]`);
      if (!row) return;
      const valCell = row.querySelector('.env-value');
      const currentVal = envRevealed[slug + '::' + key] || envCache[slug]?.vars.find(v => v.key === key)?.value || '';
      // Need revealed value for editing
      if (envCache[slug]?.vars.find(v => v.key === key)?.sensitive && !envRevealed[slug + '::' + key]) {
        toggleReveal(slug, key).then(() => editEnvVar(slug, key));
        return;
      }
      const actualVal = typeof envRevealed[slug + '::' + key] === 'string' ? envRevealed[slug + '::' + key] : currentVal;
      valCell.innerHTML = `<input class="env-edit-input" value="${escapeHtml(actualVal)}" onkeydown="if(event.key==='Enter')saveEnvEdit('${slug}','${key}',this.value);if(event.key==='Escape')loadEnvTab('${slug}')">
        <div class="btn-row" style="margin-top:4px">
          <button class="btn" onclick="saveEnvEdit('${slug}','${key}',this.parentElement.previousElementSibling.value)" style="color:var(--green)">Save</button>
          <button class="btn" onclick="loadEnvTab('${slug}')">Cancel</button>
        </div>`;
      valCell.querySelector('input').focus();
    }

    async function saveEnvEdit(slug, key, newValue) {
      try {
        const res = await fetch(`/api/apps/${slug}/env`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ changes: { [key]: newValue } })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        // Clear cache and reload
        delete envRevealed[slug + '::' + key];
        await loadEnvTab(slug);
        showRecreatePrompt(slug);
      } catch (err) {
        showToast('Error saving: ' + err.message, 'error');
      }
    }

    function showAddVar(slug) {
      const area = document.getElementById('envAddRow');
      area.innerHTML = `<div class="env-add-row" style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input class="env-edit-input" id="newEnvKey" placeholder="KEY" style="width:160px">
        <input class="env-edit-input" id="newEnvValue" placeholder="value" style="flex:1">
        <button class="btn" onclick="addEnvVar('${slug}')" style="color:var(--green)">Add</button>
        <button class="btn" onclick="document.getElementById('envAddRow').innerHTML=''">Cancel</button>
      </div>`;
      document.getElementById('newEnvKey').focus();
    }

    async function addEnvVar(slug) {
      const key = document.getElementById('newEnvKey').value.trim();
      const value = document.getElementById('newEnvValue').value;
      if (!key) return showToast('Key is required', 'warning');
      try {
        const res = await fetch(`/api/apps/${slug}/env`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ changes: { [key]: value } })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        await loadEnvTab(slug);
        showRecreatePrompt(slug);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function showRecreatePrompt(slug) {
      const area = document.getElementById('envSaveArea');
      area.innerHTML = `<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:6px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:12px;color:var(--text-dim)">Changes saved to .env file. Recreate container to apply?</span>
        <button class="btn" onclick="recreateContainer('${slug}', this)" style="color:var(--blue)">Recreate Container</button>
      </div>`;
    }

    async function recreateContainer(slug, btn) {
      if (!confirm('This will recreate the container with the new environment. Continue?')) return;
      const orig = btn.textContent;
      btn.textContent = 'Recreating...';
      btn.disabled = true;
      try {
        const res = await fetch(`/api/apps/${slug}/recreate`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          btn.textContent = 'Done!';
          btn.style.color = 'var(--green)';
          setTimeout(() => fetchAll(), 5000);
        } else {
          btn.textContent = 'Failed';
          btn.style.color = 'var(--red)';
          showToast(data.error || 'Unknown error', 'error');
        }
      } catch (err) {
        btn.textContent = 'Error';
        btn.style.color = 'var(--red)';
      }
      setTimeout(() => { btn.textContent = orig; btn.style.color = 'var(--blue)'; btn.disabled = false; }, 5000);
    }

    // --- API Key Health ---
    async function fetchKeyHealth(force = false) {
      try {
        const panel = document.getElementById('keyHealthPanel');
        const grid = document.getElementById('keyHealthGrid');
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Checking API keys... (this may take a moment)</span>';
        const res = await fetch(`/api/env/health${force ? '?force=true' : ''}`);
        const data = await res.json();
        keyHealthData = data;
        renderKeyHealth();
      } catch (err) {
        document.getElementById('keyHealthGrid').innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${err.message}</span>`;
      }
    }

    function renderKeyHealth() {
      const grid = document.getElementById('keyHealthGrid');
      if (!keyHealthData.results || Object.keys(keyHealthData.results).length === 0) {
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No API keys found</span>';
        return;
      }
      let html = '';
      for (const [appName, keys] of Object.entries(keyHealthData.results)) {
        html += `<div class="key-health-app">
          <div class="key-health-app-name">${appName}</div>`;
        for (const [keyName, info] of Object.entries(keys)) {
          const shortKey = keyName.replace(/_/g, ' ').replace(/STRIPE SECRET KEY/, 'Stripe').replace(/ANTHROPIC API KEY/, 'Anthropic').replace(/RESEND API KEY/, 'Resend').replace(/REPLICATE API TOKEN/, 'Replicate');
          const icon = info.status === 'valid' ? '&#10003;' : info.status === 'expired' ? '&#10007;' : '?';
          html += `<div class="key-health-item">
            <span style="color:var(--text-dim)">${shortKey} <span style="color:var(--text-muted);font-size:10px">${info.maskedValue}</span></span>
            <span class="key-health-status ${info.status}">${icon} ${info.status}</span>
          </div>`;
        }
        html += `</div>`;
      }
      if (keyHealthData.timestamp) {
        html += `<div style="grid-column:1/-1;font-size:10px;color:var(--text-muted);text-align:right;margin-top:4px">Last checked: ${new Date(keyHealthData.timestamp).toLocaleTimeString()}</div>`;
      }
      grid.innerHTML = html;
    }

    function toggleKeyHealth() {
      const panel = document.getElementById('keyHealthPanel');
      if (panel.classList.contains('visible')) {
        panel.classList.remove('visible');
        return;
      }
      panel.classList.add('visible');
      fetchKeyHealth();
    }

    // --- Database Backups ---
    async function fetchBackups() {
      try {
        const grid = document.getElementById('backupGrid');
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading backup status...</span>';
        const res = await apiFetch('/api/backups');
        const data = await res.json();
        renderBackups(data);
      } catch (err) {
        document.getElementById('backupGrid').innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${err.message}</span>`;
      }
    }

    function renderBackups(data) {
      const grid = document.getElementById('backupGrid');
      if (!data.backups || Object.keys(data.backups).length === 0) {
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No backup data available</span>';
        return;
      }

      let html = '';
      for (const [app, info] of Object.entries(data.backups)) {
        const name = app.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        let statusIcon, statusColor, statusText;

        if (info.status === 'ok') {
          statusIcon = '&#10003;';
          statusColor = 'var(--green)';
          statusText = `${info.ageHours}h ago`;
        } else if (info.status === 'stale') {
          statusIcon = '!';
          statusColor = 'var(--yellow)';
          statusText = info.ageHours ? `${info.ageHours}h ago (stale)` : 'stale';
        } else {
          statusIcon = '&#10007;';
          statusColor = 'var(--red)';
          statusText = 'No backups';
        }

        const size = info.totalSize ? formatBytes(info.totalSize) : '--';
        const count = info.count || 0;
        const latest = info.latest?.name || '--';

        html += `<div class="key-health-app">
          <div class="key-health-app-name" style="display:flex;justify-content:space-between;align-items:center">
            <span>${name}</span>
            <span style="color:${statusColor};font-size:11px;font-weight:500">${statusIcon} ${statusText}</span>
          </div>
          <div class="key-health-item"><span style="color:var(--text-dim)">Latest</span><span style="color:var(--text-muted);font-size:10px">${latest}</span></div>
          <div class="key-health-item"><span style="color:var(--text-dim)">Backups kept</span><span style="color:var(--text-muted)">${count}</span></div>
          <div class="key-health-item"><span style="color:var(--text-dim)">Total size</span><span style="color:var(--text-muted)">${size}</span></div>
        </div>`;
      }
      if (data.timestamp) {
        html += `<div style="grid-column:1/-1;font-size:10px;color:var(--text-muted);text-align:right;margin-top:4px">Checked: ${new Date(data.timestamp).toLocaleTimeString()}</div>`;
      }
      grid.innerHTML = html;
    }

    function toggleBackups() {
      const panel = document.getElementById('backupPanel');
      if (panel.classList.contains('visible')) {
        panel.classList.remove('visible');
        return;
      }
      panel.classList.add('visible');
      fetchBackups();
    }

    // --- Marketing Manager (tabbed) ---
    let mktRevenueData = null;
    let mktAnalyticsData = null;
    let mktSEOData = null;
    let mktHealthData = null;
    let mktCohortsData = null;
    let mktEmailsData = null;
    let mktQueueData = null;
    let mktContentData = null;
    let mktLoaded = false;

    function switchMktTab(tabName, btn) {
      document.querySelectorAll('.mkt-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.mkt-tab-content').forEach(t => t.classList.remove('active'));
      if (btn) btn.classList.add('active');
      const el = document.getElementById('mkt-' + tabName);
      if (el) el.classList.add('active');
      // Lazy-load emails tab data
      if (tabName === 'emails' && !mktEmailsData) fetchMktEmails();
      // Lazy-load content tab data
      if (tabName === 'content' && !mktContentData) fetchMktContent();
      // Lazy-load crosspromo tab data
      if (tabName === 'crosspromo' && !crosspromoData) fetchCrosspromo();
      // Lazy-load banners tab data
      if (tabName === 'banners') { if (!bannersData) fetchBanners(); checkInjectionStatus(); }
      // Lazy-load playbook tab data
      if (tabName === 'playbook') { initPlaybookFilter(); if (!playbookData) fetchPlaybook(); }
    }

    function switchRevenueSubtab(name, btn) {
      btn.closest('.mkt-subtabs').querySelectorAll('.mkt-subtab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('rev-sub-overview').classList.toggle('active', name === 'overview');
      document.getElementById('rev-sub-cohorts').classList.toggle('active', name === 'cohorts');
      if (name === 'cohorts' && !mktCohortsData) fetchMktCohorts();
    }

    function switchEmailsSubtab(name, btn) {
      btn.closest('.mkt-subtabs').querySelectorAll('.mkt-subtab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('email-sub-sequences').classList.toggle('active', name === 'sequences');
      document.getElementById('email-sub-queue').classList.toggle('active', name === 'queue');
      if (name === 'queue' && !mktQueueData) fetchMktQueue();
    }

    function fmtCents(cents, currency = 'eur') {
      const val = (cents / 100).toFixed(2);
      return currency === 'eur' ? val + ' \u20ac' : '$' + val;
    }

    async function fetchMktAll() {
      // Fetch all marketing data in parallel
      const [revRes, anaRes, seoRes, healthRes] = await Promise.allSettled([
        apiFetch('/api/marketing/revenue'),
        apiFetch('/api/marketing/analytics'),
        apiFetch('/api/marketing/seo'),
        apiFetch('/api/marketing/health'),
      ]);
      if (revRes.status === 'fulfilled' && revRes.value.ok) mktRevenueData = await revRes.value.json();
      if (anaRes.status === 'fulfilled' && anaRes.value.ok) mktAnalyticsData = await anaRes.value.json();
      if (seoRes.status === 'fulfilled' && seoRes.value.ok) mktSEOData = await seoRes.value.json();
      if (healthRes.status === 'fulfilled' && healthRes.value.ok) mktHealthData = await healthRes.value.json();

      renderMktOverview();
      renderMktRevenue();
      renderMktTraffic();
      renderMktSEO();
      document.getElementById('mktLastUpdated').textContent = 'Updated: ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      mktLoaded = true;
    }

    function renderMktOverview() {
      const el = document.getElementById('mktOverviewContent');
      let html = '<div class="marketing-summary">';

      // Portfolio health
      if (mktHealthData) {
        const avg = mktHealthData.avgScore;
        const color = avg >= 70 ? 'var(--green)' : avg >= 50 ? 'var(--yellow)' : 'var(--red)';
        html += `<div class="marketing-stat"><div class="marketing-avg-score" style="color:${color}">${avg}</div><div class="marketing-avg-label">Health Score</div></div>`;
      }
      // Revenue total
      if (mktRevenueData?.totals) {
        html += `<div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--green)">${fmtCents(mktRevenueData.totals.mrr)}</div><div class="marketing-stat-label">MRR</div></div>`;
        html += `<div class="marketing-stat"><div class="marketing-stat-value">${fmtCents(mktRevenueData.totals.revenue30d)}</div><div class="marketing-stat-label">Revenue (30d)</div></div>`;
        html += `<div class="marketing-stat"><div class="marketing-stat-value">${fmtCents(mktRevenueData.totals.balance)}</div><div class="marketing-stat-label">Balance</div></div>`;
      }
      // Traffic total
      if (mktAnalyticsData?.totals) {
        html += `<div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--cyan)">${mktAnalyticsData.totals.realtime}</div><div class="marketing-stat-label">Live Now</div></div>`;
        html += `<div class="marketing-stat"><div class="marketing-stat-value">${mktAnalyticsData.totals.visitors.toLocaleString()}</div><div class="marketing-stat-label">Visitors (30d)</div></div>`;
        html += `<div class="marketing-stat"><div class="marketing-stat-value">${mktAnalyticsData.totals.pageviews.toLocaleString()}</div><div class="marketing-stat-label">Pageviews (30d)</div></div>`;
      }
      // SEO avg
      if (mktSEOData?.summary) {
        const avg = mktSEOData.summary.avgScore;
        const color = avg >= 75 ? 'var(--green)' : avg >= 60 ? 'var(--yellow)' : 'var(--red)';
        html += `<div class="marketing-stat"><div class="marketing-stat-value" style="color:${color}">${avg}</div><div class="marketing-stat-label">SEO Score</div></div>`;
      }
      html += '</div>';

      // Per-app health cards
      if (mktHealthData?.apps) {
        html += '<div class="marketing-grid" style="margin-top:12px">';
        const sorted = Object.entries(mktHealthData.apps).sort((a, b) => b[1].score - a[1].score);
        for (const [name, data] of sorted) {
          const color = data.score >= 70 ? 'var(--green)' : data.score >= 50 ? 'var(--yellow)' : 'var(--red)';
          let factors = [];
          if (data.factors.visitors != null) factors.push(`${data.factors.visitors} visitors`);
          if (data.factors.mrr != null) factors.push(`${data.factors.mrr.toFixed(2)} \u20ac MRR`);
          if (data.factors.seo != null) factors.push(`SEO: ${data.factors.seo}`);
          if (data.factors.subscriptions != null) factors.push(`${data.factors.subscriptions} subs`);
          html += `<div class="health-card">
            <div class="health-card-left">
              <div class="health-card-name">${name}</div>
              <div class="health-card-factors">${factors.join(' &middot; ') || 'No data yet'}</div>
            </div>
            <div class="health-card-score" style="color:${color}">${data.score}</div>
          </div>`;
        }
        html += '</div>';
      }

      el.innerHTML = html;
    }

    function renderMktRevenue() {
      const summary = document.getElementById('mktRevenueSummary');
      const grid = document.getElementById('mktRevenueGrid');

      if (!mktRevenueData?.apps || Object.keys(mktRevenueData.apps).length === 0) {
        summary.innerHTML = '';
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No Stripe keys found in app environments</span>';
        return;
      }

      const t = mktRevenueData.totals;
      summary.innerHTML = `
        <div class="marketing-stat"><div class="marketing-avg-score" style="color:var(--green)">${fmtCents(t.mrr)}</div><div class="marketing-avg-label">Total MRR</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value">${fmtCents(t.revenue30d)}</div><div class="marketing-stat-label">Revenue (30d)</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value">${fmtCents(t.balance)}</div><div class="marketing-stat-label">Stripe Balance</div></div>
      `;

      let html = '';
      for (const [name, app] of Object.entries(mktRevenueData.apps)) {
        if (app.error) {
          html += `<div class="rev-card"><div class="rev-card-name">${name}</div><span style="color:var(--red);font-size:12px">Error: ${app.error}</span></div>`;
          continue;
        }
        html += `<div class="rev-card">
          <div class="rev-card-header">
            <span class="rev-card-name">${name}</span>
            <span class="rev-amount">${fmtCents(app.mrr, app.currency)}</span>
          </div>
          <div class="rev-label">Monthly Recurring Revenue</div>
          <div class="rev-stats">
            <div class="rev-stat"><div class="rev-stat-val">${fmtCents(app.revenue30d, app.currency)}</div><div class="rev-stat-lbl">30d Revenue</div></div>
            <div class="rev-stat"><div class="rev-stat-val">${app.activeSubscriptions}</div><div class="rev-stat-lbl">Active Subs</div></div>
            <div class="rev-stat"><div class="rev-stat-val">${app.chargeCount30d}</div><div class="rev-stat-lbl">Charges (30d)</div></div>
          </div>`;
        // Recent charges
        if (app.recentCharges?.length > 0) {
          html += '<div class="rev-charges">';
          for (const c of app.recentCharges) {
            const date = new Date(c.created * 1000).toLocaleDateString([], { month: 'short', day: 'numeric' });
            const statusColor = c.status === 'paid' ? 'var(--green)' : c.status === 'refunded' ? 'var(--yellow)' : 'var(--red)';
            html += `<div class="rev-charge"><span>${date} ${c.description || ''}</span><span style="color:${statusColor}">${fmtCents(c.amount, c.currency)}</span></div>`;
          }
          html += '</div>';
        }
        if (app.shared) {
          html += `<div class="rev-shared">Shared Stripe account with: ${app.sharedWith.join(', ')}</div>`;
        }
        html += '</div>';
      }
      grid.innerHTML = html;
    }

    function renderMktTraffic() {
      const summary = document.getElementById('mktTrafficSummary');
      const grid = document.getElementById('mktTrafficGrid');

      if (!mktAnalyticsData?.apps || Object.keys(mktAnalyticsData.apps).length === 0) {
        summary.innerHTML = '';
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No analytics data available. Apps may not have Plausible tracking installed.</span>';
        return;
      }

      const t = mktAnalyticsData.totals;
      summary.innerHTML = `
        <div class="marketing-stat"><div class="marketing-avg-score" style="color:var(--cyan)"><span class="ana-realtime-dot"></span>${t.realtime}</div><div class="marketing-avg-label">Live Visitors</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value">${t.visitors.toLocaleString()}</div><div class="marketing-stat-label">Visitors (30d)</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value">${t.pageviews.toLocaleString()}</div><div class="marketing-stat-label">Pageviews (30d)</div></div>
      `;

      let html = '';
      // Sort by visitors descending
      const sorted = Object.entries(mktAnalyticsData.apps).sort((a, b) => (b[1].visitors || 0) - (a[1].visitors || 0));
      for (const [name, app] of sorted) {
        if (app.error && !app.visitors) {
          html += `<div class="ana-card"><div class="ana-card-name">${name}</div><span style="color:var(--text-muted);font-size:11px">${app.error || 'No data'}</span><div style="font-size:10px;color:var(--text-muted);margin-top:4px">${app.domain} &mdash; Plausible tracking may not be installed</div></div>`;
          continue;
        }
        const maxVisitors = sorted[0]?.[1]?.visitors || 1;
        const barW = Math.round((app.visitors / maxVisitors) * 100);

        html += `<div class="ana-card">
          <div class="ana-card-header">
            <span class="ana-card-name">${name}</span>
            ${app.realtime > 0 ? `<span class="ana-realtime"><span class="ana-realtime-dot"></span>${app.realtime} live</span>` : ''}
          </div>
          <div style="font-size:11px;color:var(--cyan);margin-bottom:6px">${app.domain}</div>
          <div class="ana-stats">
            <div class="ana-stat"><div class="ana-stat-val">${(app.visitors || 0).toLocaleString()}</div><div class="ana-stat-lbl">Visitors</div></div>
            <div class="ana-stat"><div class="ana-stat-val">${(app.pageviews || 0).toLocaleString()}</div><div class="ana-stat-lbl">Pageviews</div></div>
            <div class="ana-stat"><div class="ana-stat-val">${app.bounceRate || 0}%</div><div class="ana-stat-lbl">Bounce</div></div>
            <div class="ana-stat"><div class="ana-stat-val">${app.visitDuration ? Math.round(app.visitDuration) + 's' : '--'}</div><div class="ana-stat-lbl">Avg Visit</div></div>
          </div>
          <div class="ana-list-bar"><div class="ana-list-bar-fill" style="width:${barW}%"></div></div>`;

        // Top pages
        if (app.topPages?.length > 0) {
          html += '<div class="ana-list" style="margin-top:8px"><div class="ana-list-title">Top Pages</div>';
          for (const p of app.topPages.slice(0, 3)) {
            html += `<div class="ana-list-item"><span>${escapeHtml(p.page)}</span><span>${p.visitors}</span></div>`;
          }
          html += '</div>';
        }
        // Top sources
        if (app.topSources?.length > 0) {
          html += '<div class="ana-list" style="margin-top:6px"><div class="ana-list-title">Top Sources</div>';
          for (const s of app.topSources.slice(0, 3)) {
            html += `<div class="ana-list-item"><span>${escapeHtml(s.source || 'Direct')}</span><span>${s.visitors}</span></div>`;
          }
          html += '</div>';
        }
        html += '</div>';
      }
      grid.innerHTML = html;
    }

    async function fetchSEO(force = false) {
      try {
        const grid = document.getElementById('marketingGrid');
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Scanning all apps for SEO... (this takes a few seconds)</span>';
        const res = await fetch(`/api/marketing/seo${force ? '?force=true' : ''}`);
        mktSEOData = await res.json();
        renderMktSEO();
      } catch (err) {
        document.getElementById('marketingGrid').innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${err.message}</span>`;
      }
    }

    function renderMktSEO() {
      const summary = document.getElementById('marketingSummary');
      const grid = document.getElementById('marketingGrid');

      if (!mktSEOData?.apps || Object.keys(mktSEOData.apps).length === 0) {
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No marketable apps found</span>';
        return;
      }

      const data = mktSEOData;
      const avg = data.summary.avgScore;
      const avgColor = avg >= 75 ? 'var(--green)' : avg >= 60 ? 'var(--yellow)' : 'var(--red)';
      const highIssues = Object.values(data.apps).reduce((sum, a) => sum + a.issues.filter(i => i.severity === 'high').length, 0);
      const medIssues = Object.values(data.apps).reduce((sum, a) => sum + a.issues.filter(i => i.severity === 'medium').length, 0);

      summary.innerHTML = `
        <div class="marketing-stat"><div class="marketing-avg-score" style="color:${avgColor}">${avg}</div><div class="marketing-avg-label">Avg SEO Score</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value">${data.summary.appCount}</div><div class="marketing-stat-label">Apps</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--red)">${highIssues}</div><div class="marketing-stat-label">Critical</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--yellow)">${medIssues}</div><div class="marketing-stat-label">Warnings</div></div>
      `;

      let html = '';
      const sorted = Object.entries(data.apps).sort((a, b) => a[1].score - b[1].score);
      for (const [name, app] of sorted) {
        const scoreColor = app.grade === 'A' ? 'var(--green)' : app.grade === 'B' ? 'var(--green)' : app.grade === 'C' ? 'var(--yellow)' : app.grade === 'D' ? 'var(--orange)' : 'var(--red)';
        const bColor = app.score >= 75 ? 'var(--green)' : app.score >= 60 ? 'var(--yellow)' : 'var(--red)';
        let checksHtml = '';
        const checkLabels = { title: 'Title', title_length: 'Title Len', meta_desc: 'Description', meta_desc_length: 'Desc Len', og_title: 'OG Title', og_desc: 'OG Desc', og_image: 'OG Image', canonical: 'Canonical', viewport: 'Viewport', lang: 'Lang', sitemap: 'Sitemap', robots: 'Robots', favicon: 'Favicon' };
        for (const [key, label] of Object.entries(checkLabels)) {
          const pass = app.checks[key];
          checksHtml += `<span class="seo-check ${pass ? 'pass' : 'fail'}">${pass ? '&#10003;' : '&#10007;'} ${label}</span>`;
        }
        let issuesHtml = '';
        if (app.issues.length > 0) {
          issuesHtml = '<div class="seo-issues">';
          for (const issue of app.issues.slice(0, 4)) {
            const icon = issue.severity === 'high' ? '&#9679;' : issue.severity === 'medium' ? '&#9675;' : '&#8226;';
            issuesHtml += `<div class="seo-issue ${issue.severity}">${icon} ${issue.msg}</div>`;
          }
          if (app.issues.length > 4) issuesHtml += `<div class="seo-issue low">+ ${app.issues.length - 4} more</div>`;
          issuesHtml += '</div>';
        }
        let marketingHtml = '';
        if (app.marketing) {
          const m = app.marketing;
          marketingHtml = '<div class="marketing-info">';
          if (m.tagline) marketingHtml += `<span>${m.tagline}</span>`;
          if (m.targetAudience) marketingHtml += `<span>${m.targetAudience}</span>`;
          if (m.languages) marketingHtml += `<span>${m.languages.join(', ')}</span>`;
          marketingHtml += '</div>';
        }
        html += `<div class="seo-card">
          <div class="seo-card-header"><div><div class="seo-card-name">${name}</div><a href="https://${app.domain}" target="_blank" class="seo-card-domain">${app.domain}</a></div>
            <div style="text-align:right"><span class="seo-score grade-${app.grade}">${app.score}</span><span class="seo-grade" style="background:${scoreColor}20;color:${scoreColor}">${app.grade}</span></div>
          </div>
          <div class="seo-bar"><div class="seo-bar-fill" style="width:${app.score}%;background:${bColor}"></div></div>
          <div class="seo-checks">${checksHtml}</div>
          ${issuesHtml}${marketingHtml}
        </div>`;
      }
      grid.innerHTML = html;
    }

    // --- Cohorts ---
    async function fetchMktCohorts() {
      const content = document.getElementById('mktCohortsContent');
      content.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Building customer graph... (may take 15-30s on first load)</span>';
      try {
        const [cohortRes, crosssellRes] = await Promise.allSettled([
          apiFetch('/api/marketing/cohorts'),
          apiFetch('/api/marketing/cohorts/crosssell'),
        ]);
        if (cohortRes.status === 'fulfilled' && cohortRes.value.ok) {
          mktCohortsData = await cohortRes.value.json();
          if (crosssellRes.status === 'fulfilled' && crosssellRes.value.ok) {
            mktCohortsData.crosssellOpportunities = (await crosssellRes.value.json()).opportunities;
          }
        }
        renderMktCohorts();
      } catch (err) {
        content.innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${err.message}</span>`;
      }
    }

    function renderMktCohorts() {
      const summary = document.getElementById('mktCohortsSummary');
      const content = document.getElementById('mktCohortsContent');
      if (!mktCohortsData) { content.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No cohort data</span>'; return; }

      const s = mktCohortsData.summary;
      summary.innerHTML = `
        <div class="marketing-stat"><div class="marketing-avg-score" style="color:var(--purple)">${s.totalUniqueCustomers}</div><div class="marketing-avg-label">Unique Customers</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value">${s.singleAppCustomers}</div><div class="marketing-stat-label">Single App</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--yellow)">${s.multiAppCustomers}</div><div class="marketing-stat-label">Multi-App</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--green)">${s.powerUsers}</div><div class="marketing-stat-label">Power Users (3+)</div></div>
      `;

      let html = '';
      // Overlap matrix
      const matrix = mktCohortsData.overlapMatrix || {};
      const matrixPairs = new Set();
      let hasOverlap = false;
      for (const [appA, overlaps] of Object.entries(matrix)) {
        for (const [appB, count] of Object.entries(overlaps)) {
          const key = [appA, appB].sort().join('|');
          if (count > 0 && !matrixPairs.has(key)) {
            matrixPairs.add(key);
            hasOverlap = true;
          }
        }
      }

      if (hasOverlap) {
        html += '<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;font-weight:600">App Overlap Matrix</div>';
        html += '<div class="cohort-matrix">';
        for (const key of matrixPairs) {
          const [a, b] = key.split('|');
          const count = matrix[a]?.[b] || 0;
          html += `<div class="cohort-cell"><div class="cohort-cell-count">${count}</div><div class="cohort-cell-label">${a} + ${b}</div></div>`;
        }
        html += '</div>';
      } else {
        html += '<div style="color:var(--text-muted);font-size:12px;margin:12px 0">No cross-app overlap detected yet. Data updates daily at 3:30 AM.</div>';
      }

      // Cross-sell opportunities
      const opps = mktCohortsData.crosssellOpportunities || [];
      if (opps.length > 0) {
        html += '<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin:16px 0 8px;font-weight:600">Cross-Sell Opportunities</div>';
        html += '<div class="marketing-grid">';
        for (const opp of opps) {
          html += `<div class="crosssell-card">
            <div class="crosssell-pairing">${escapeHtml(opp.label)}</div>
            <div style="font-size:11px;color:var(--text-dim);margin-bottom:8px">${opp.apps.join(' + ')}</div>
            <div style="font-size:11px;color:var(--text-muted)">${escapeHtml(opp.reason)}</div>
            <div style="display:flex;gap:16px;margin-top:10px">
              <div><div style="font-size:14px;font-weight:600;color:var(--purple);font-variant-numeric:tabular-nums">${opp.existingOverlap}</div><div style="font-size:9px;color:var(--text-muted)">OVERLAP</div></div>
              <div><div style="font-size:14px;font-weight:600;font-variant-numeric:tabular-nums">${opp.potentialReach}</div><div style="font-size:9px;color:var(--text-muted)">POTENTIAL</div></div>
            </div>
          </div>`;
        }
        html += '</div>';
      }

      content.innerHTML = html || '<span style="color:var(--text-muted);font-size:12px">No data yet</span>';
    }

    // --- Emails ---
    async function fetchMktEmails() {
      try {
        const res = await apiFetch('/api/marketing/emails/sequences');
        if (res.ok) mktEmailsData = await res.json();
        renderMktEmails();
      } catch (err) {
        console.error('Failed to fetch email sequences:', err);
      }
    }

    async function fetchMktQueue() {
      try {
        const res = await apiFetch('/api/marketing/emails/queue');
        if (res.ok) mktQueueData = await res.json();
        renderMktQueue();
      } catch (err) {
        console.error('Failed to fetch email queue:', err);
      }
    }

    function renderMktEmails() {
      const summary = document.getElementById('mktEmailsSummary');
      if (!mktEmailsData) return;

      const seqCount = mktEmailsData.sequences?.length || 0;
      const totalQueued = mktEmailsData.sequences?.reduce((s, seq) => s + (seq.queuedCount || 0), 0) || 0;
      const totalSent = mktEmailsData.sequences?.reduce((s, seq) => s + (seq.sentCount || 0), 0) || 0;

      summary.innerHTML = `
        <div class="marketing-stat"><div class="marketing-stat-value">${seqCount}</div><div class="marketing-stat-label">Sequences</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--yellow)">${totalQueued}</div><div class="marketing-stat-label">Queued</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--green)">${totalSent}</div><div class="marketing-stat-label">Sent</div></div>
      `;

      renderSequencesGrid();
    }

    function renderSequencesGrid() {
      const grid = document.getElementById('mktSequencesGrid');
      if (!mktEmailsData?.sequences?.length) {
        grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No sequences configured</span>';
        return;
      }

      let html = '';
      for (const seq of mktEmailsData.sequences) {
        const statusClass = seq.active ? 'active' : 'paused';
        const statusLabel = seq.active ? 'Active' : 'Paused';
        const actionLabel = seq.active ? 'Pause' : 'Resume';
        const actionEndpoint = seq.active ? 'pause' : 'resume';

        html += `<div class="seq-card">
          <div class="seq-card-header">
            <span class="seq-card-name">${escapeHtml(seq.name)}</span>
            <div style="display:flex;gap:6px;align-items:center">
              <span class="seq-status ${statusClass}">${statusLabel}</span>
              <button class="btn" onclick="toggleSequence(${seq.id}, '${actionEndpoint}', this)">${actionLabel}</button>
            </div>
          </div>
          <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">
            Segment: ${escapeHtml(seq.segment)}${seq.app_slug ? ' &middot; ' + escapeHtml(seq.app_slug) : ' &middot; All apps'}
            &nbsp;&middot;&nbsp; ${seq.queuedCount} queued &nbsp;&middot;&nbsp; ${seq.sentCount} sent
          </div>`;

        for (const step of (seq.steps || [])) {
          html += `<div class="seq-step">
            <span class="seq-step-day">Day +${step.delay_days}</span>
            <span>${escapeHtml(step.subject)}</span>
          </div>`;
        }
        html += '</div>';
      }
      grid.innerHTML = html;
    }

    function renderMktQueue() {
      const el = document.getElementById('mktQueueContent');
      if (!mktQueueData) { el.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading...</span>'; return; }

      const counts = mktQueueData.counts || {};
      const dailySent = mktQueueData.dailySentToday || 0;
      const pct = Math.round((dailySent / 100) * 100);
      const capColor = pct > 80 ? 'var(--red)' : pct > 50 ? 'var(--yellow)' : 'var(--green)';

      let html = `<div style="display:flex;gap:16px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <div style="font-size:11px"><span style="color:var(--text-muted)">Pending:</span> <strong>${counts.pending || 0}</strong></div>
        <div style="font-size:11px"><span style="color:var(--text-muted)">Sent:</span> <strong style="color:var(--green)">${counts.sent || 0}</strong></div>
        <div style="font-size:11px"><span style="color:var(--text-muted)">Failed:</span> <strong style="color:var(--red)">${counts.failed || 0}</strong></div>
        <div style="min-width:120px">
          <div style="font-size:10px;color:var(--text-muted)">Daily: ${dailySent}/100</div>
          <div class="daily-cap-bar"><div class="daily-cap-fill" style="width:${pct}%;background:${capColor}"></div></div>
        </div>
      </div>`;

      if (mktQueueData.queue?.length) {
        html += '<div class="queue-row queue-header"><span>Template</span><span>App</span><span>Scheduled</span><span>Status</span></div>';
        for (const item of mktQueueData.queue) {
          const statusColor = item.status === 'sent' ? 'var(--green)' : item.status === 'failed' ? 'var(--red)' : item.status === 'paused' ? 'var(--yellow)' : 'var(--text-dim)';
          const date = new Date(item.scheduled_at).toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          html += `<div class="queue-row">
            <span>${escapeHtml(item.template_key)}</span>
            <span>${escapeHtml(item.app_slug)}</span>
            <span>${date}</span>
            <span style="color:${statusColor}">${item.status}</span>
          </div>`;
        }
      } else {
        html += '<div style="color:var(--text-muted);font-size:12px;margin-top:8px">Queue is empty</div>';
      }

      el.innerHTML = html;
    }

    async function toggleSequence(id, action, btn) {
      const orig = btn.textContent;
      btn.textContent = '...'; btn.disabled = true;
      try {
        const res = await fetch(`/api/marketing/emails/${action}/${id}`, { method: 'POST' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Failed');
        await fetchMktEmails();
      } catch (err) {
        btn.textContent = orig; btn.disabled = false;
        showToast(err.message, 'error');
      }
    }

    // --- Content Pipeline ---
    async function fetchMktContent() {
      try {
        const appFilter = document.getElementById('contentAppFilter')?.value || '';
        const statusFilter = document.getElementById('contentStatusFilter')?.value || '';
        let url = '/api/marketing/content?';
        if (appFilter) url += 'app_slug=' + encodeURIComponent(appFilter) + '&';
        if (statusFilter) url += 'status=' + encodeURIComponent(statusFilter);
        const res = await fetch(url);
        if (res.ok) mktContentData = await res.json();
        populateContentAppFilter();
        renderMktContent();
      } catch (err) {
        console.error('Failed to fetch content:', err);
      }
    }

    function populateContentAppFilter() {
      const sel = document.getElementById('contentAppFilter');
      if (!sel || sel.options.length > 1) return;
      const marketable = (appData || []).filter(a => a.type === 'saas' || a.type === 'tool');
      for (const app of marketable) {
        const slug = app.name.toLowerCase().replace(/\s+/g, '-');
        sel.innerHTML += `<option value="${slug}">${escapeHtml(app.name)}</option>`;
      }
    }

    function renderMktContent() {
      const grid = document.getElementById('mktContentGrid');
      const summary = document.getElementById('mktContentSummary');
      if (!mktContentData) { grid.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading...</span>'; return; }

      const counts = mktContentData.counts || {};
      summary.innerHTML = `
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--text-muted)">${counts.draft || 0}</div><div class="marketing-stat-label">Drafts</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--green)">${counts.approved || 0}</div><div class="marketing-stat-label">Approved</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--cyan)">${counts.published || 0}</div><div class="marketing-stat-label">Published</div></div>
        <div class="marketing-stat"><div class="marketing-stat-value" style="color:var(--red)">${counts.rejected || 0}</div><div class="marketing-stat-label">Rejected</div></div>
      `;

      let html = '';
      for (const item of (mktContentData.items || [])) {
        const statusLabel = item.status.charAt(0).toUpperCase() + item.status.slice(1);
        const date = new Date(item.created_at).toLocaleDateString([], { month: 'short', day: 'numeric' });
        const typeClass = item.content_type.replace(/\s+/g, '_');

        html += `<div class="content-card">
          <div class="content-card-header">
            <div>
              <span class="content-type-badge ${typeClass}">${item.content_type.replace(/_/g, ' ')}</span>
              <span style="font-size:11px;color:var(--text-muted);margin-left:8px">${escapeHtml(item.app_slug)} &middot; ${escapeHtml(item.keyword || '')}</span>
            </div>
            <span class="content-status ${item.status}">${statusLabel} &middot; ${date}</span>
          </div>
          <div class="content-body" id="cb-${item.id}">${escapeHtml(item.body || '')}</div>
          <button class="btn" onclick="toggleContentExpand(${item.id})" style="font-size:10px;color:var(--text-muted)">Show more</button>
          <div class="content-actions">`;

        if (item.status === 'draft') {
          html += `<button class="btn" onclick="updateContent(${item.id}, 'approved', this)" style="color:var(--green)">Approve</button>
                   <button class="btn" onclick="updateContent(${item.id}, 'rejected', this)" style="color:var(--red)">Reject</button>`;
        }
        if (item.status === 'approved') {
          html += `<button class="btn" onclick="updateContent(${item.id}, 'published', this)" style="color:var(--cyan)">Mark Published</button>
                   <button class="btn" onclick="updateContent(${item.id}, 'rejected', this)" style="color:var(--red)">Reject</button>`;
        }
        html += `</div></div>`;
      }

      grid.innerHTML = html || '<span style="color:var(--text-muted);font-size:12px">No content items. Click "+ Generate" to create content.</span>';
    }

    function toggleContentExpand(id) {
      const el = document.getElementById('cb-' + id);
      if (el) el.classList.toggle('expanded');
    }

    async function updateContent(id, status, btn) {
      const orig = btn.textContent;
      btn.textContent = '...'; btn.disabled = true;
      try {
        const body = { status };
        if (status === 'published') body.published_at = new Date().toISOString();
        const res = await fetch(`/api/marketing/content/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        await fetchMktContent();
      } catch (err) {
        btn.textContent = orig; btn.disabled = false;
        showToast(err.message, 'error');
      }
    }

    function showGenerateForm() {
      const container = document.getElementById('generateFormContainer');
      container.style.display = 'block';
      // Populate app dropdown
      const sel = document.getElementById('genAppSlug');
      if (sel.options.length === 0) {
        const marketable = (appData || []).filter(a => a.type === 'saas' || a.type === 'tool');
        for (const app of marketable) {
          const slug = app.name.toLowerCase().replace(/\s+/g, '-');
          sel.innerHTML += `<option value="${slug}">${escapeHtml(app.name)}</option>`;
        }
      }
    }

    function hideGenerateForm() {
      document.getElementById('generateFormContainer').style.display = 'none';
    }

    async function submitGenerate() {
      const appSlug = document.getElementById('genAppSlug').value;
      const contentType = document.getElementById('genContentType').value;
      const keyword = document.getElementById('genKeyword').value.trim();
      if (!keyword) { showToast('Please enter a keyword', 'warning'); return; }

      const btn = document.getElementById('genSubmitBtn');
      btn.textContent = 'Generating...'; btn.disabled = true;
      try {
        const res = await apiFetch('/api/marketing/content/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ app_slug: appSlug, content_type: contentType, keyword }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        hideGenerateForm();
        document.getElementById('genKeyword').value = '';
        await fetchMktContent();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        btn.textContent = 'Generate'; btn.disabled = false;
      }
    }

    // --- Cross-Promo ---
    let crosspromoData = null;
    let bannersData = null;
    let playbookData = null;
    let playbookFilterInit = false;
    let currentPlacementBannerId = null;

    async function fetchCrosspromo() {
      try {
        const res = await apiFetch('/api/marketing/crosspromo');
        if (!res.ok) throw new Error('Failed to load campaigns');
        crosspromoData = await res.json();
        renderCrosspromo();
      } catch (err) {
        document.getElementById('mktCrosspromoGrid').innerHTML = '<span style="color:var(--red);font-size:12px">Error loading campaigns</span>';
      }
    }

    function renderCrosspromo() {
      const grid = document.getElementById('mktCrosspromoGrid');
      const summary = document.getElementById('mktCrosspromoSummary');
      if (!crosspromoData || crosspromoData.length === 0) {
        summary.innerHTML = '<span style="font-size:12px;color:var(--text-muted)">No campaigns yet</span>';
        grid.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">Create your first cross-promotion campaign to promote apps on each other\'s sites.</div>';
        return;
      }
      const active = crosspromoData.filter(c => c.status === 'active').length;
      const totalViews = crosspromoData.reduce((s, c) => s + c.views, 0);
      const totalClicks = crosspromoData.reduce((s, c) => s + c.clicks, 0);
      const ctr = totalViews > 0 ? ((totalClicks / totalViews) * 100).toFixed(1) : '0.0';
      summary.innerHTML = `
        <div class="marketing-stat"><span class="marketing-stat-value" style="color:var(--cyan)">${active}</span> active</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${totalViews}</span> views</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${totalClicks}</span> clicks</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${ctr}%</span> CTR</div>`;
      grid.innerHTML = crosspromoData.map(c => {
        const statusColors = { draft: 'var(--text-muted)', active: 'var(--green)', paused: 'var(--yellow)', ended: 'var(--red)' };
        const statusColor = statusColors[c.status] || 'var(--text-muted)';
        const viewsClicks = c.views > 0 ? ((c.clicks / c.views) * 100).toFixed(1) + '% CTR' : 'No data';
        return `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="font-weight:600;font-size:13px">${escapeHtml(c.name)}</div>
            <span style="font-size:10px;color:${statusColor};text-transform:uppercase;font-weight:600">${c.status}</span>
          </div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">
            <strong>${escapeHtml(c.source_app)}</strong> shows banner for <strong>${escapeHtml(c.target_app)}</strong>
          </div>
          <div style="font-size:12px;margin-bottom:8px;color:var(--text)">"${escapeHtml(c.headline)}"  <span style="color:var(--cyan)">${escapeHtml(c.cta_text)}</span></div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:11px;color:var(--text-muted)">${c.views} views / ${c.clicks} clicks (${viewsClicks})</span>
            <div style="display:flex;gap:4px">
              ${c.status === 'draft' ? `<button class="btn" onclick="setCrosspromoStatus(${c.id},'active')" style="color:var(--green);font-size:11px;padding:3px 8px">Activate</button>` : ''}
              ${c.status === 'active' ? `<button class="btn" onclick="setCrosspromoStatus(${c.id},'paused')" style="color:var(--yellow);font-size:11px;padding:3px 8px">Pause</button>` : ''}
              ${c.status === 'paused' ? `<button class="btn" onclick="setCrosspromoStatus(${c.id},'active')" style="color:var(--green);font-size:11px;padding:3px 8px">Resume</button>` : ''}
              <button class="btn" onclick="showCrosspromoEmbed('${escapeHtml(c.source_app)}')" style="color:var(--cyan);font-size:11px;padding:3px 8px">Embed</button>
              <button class="btn" onclick="deleteCrosspromo(${c.id})" style="color:var(--red);font-size:11px;padding:3px 8px">Delete</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    async function setCrosspromoStatus(id, status) {
      try {
        const res = await apiFetch('/api/marketing/crosspromo/' + id, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Update failed'); }
      } catch (err) {
        showToast(err.message, 'error');
      }
      fetchCrosspromo();
    }

    async function deleteCrosspromo(id) {
      if (!confirm('Delete this campaign?')) return;
      try {
        const res = await apiFetch('/api/marketing/crosspromo/' + id, { method: 'DELETE' });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Delete failed'); }
      } catch (err) {
        showToast(err.message, 'error');
      }
      fetchCrosspromo();
    }

    function showCrosspromoForm() {
      if (!appData || appData.length === 0) { showToast('No apps loaded yet', 'warning'); return; }
      const apps = appData.map(a => a.name);
      const slugs = apps.map(n => n.toLowerCase().replace(/\s+/g, '-'));
      ['xpSourceApp', 'xpTargetApp'].forEach(id => {
        const sel = document.getElementById(id);
        sel.innerHTML = apps.map((n, i) => `<option value="${escapeHtml(slugs[i])}">${escapeHtml(n)}</option>`).join('');
      });
      // Default: first two apps selected
      const srcSel = document.getElementById('xpSourceApp');
      const tgtSel = document.getElementById('xpTargetApp');
      if (srcSel.options.length > 0) srcSel.selectedIndex = 0;
      if (tgtSel.options.length > 1) tgtSel.selectedIndex = 1;
      document.getElementById('crosspromoFormContainer').style.display = '';
    }

    function hideCrosspromoForm() {
      document.getElementById('crosspromoFormContainer').style.display = 'none';
    }

    async function submitCrosspromoForm() {
      const btn = document.getElementById('xpSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      try {
        const body = {
          name: document.getElementById('xpName').value,
          source_app: document.getElementById('xpSourceApp').value,
          target_app: document.getElementById('xpTargetApp').value,
          headline: document.getElementById('xpHeadline').value || undefined,
          cta_text: document.getElementById('xpCta').value || undefined,
        };
        const res = await apiFetch('/api/marketing/crosspromo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error); }
        hideCrosspromoForm();
        fetchCrosspromo();
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create';
      }
    }

    function showCrosspromoEmbed(sourceApp) {
      const code = `<script src="${location.origin}/api/crosspromo/embed.js" data-app="${sourceApp}"><\/script>`;
      document.getElementById('crosspromoEmbedCode').textContent = code;
      document.getElementById('crosspromoEmbed').style.display = '';
    }

    // =============================================
    // Banner Management
    // =============================================

    async function checkInjectionStatus() {
      const grid = document.getElementById('injectionStatusGrid');
      const container = document.getElementById('bannerInjectionStatus');
      container.style.display = '';
      grid.innerHTML = '<span style="color:var(--text-muted)">Checking sites...</span>';
      try {
        const res = await apiFetch('/api/banners/injection-status');
        if (!res.ok) throw new Error();
        const data = await res.json();
        grid.innerHTML = data.map(s => {
          const color = s.injected ? 'var(--green)' : s.error ? 'var(--yellow)' : 'var(--red)';
          const icon = s.injected ? '&#10003;' : s.error ? '?' : '&#10007;';
          const title = s.injected ? 'Embed.js injected' : s.error ? 'Site unreachable' : 'Not injected';
          return `<span style="background:var(--surface1);border:1px solid var(--border);border-radius:6px;padding:2px 8px;white-space:nowrap" title="${title}"><span style="color:${color}">${icon}</span> ${s.slug}</span>`;
        }).join('');
      } catch {
        grid.innerHTML = '<span style="color:var(--red)">Failed to check</span>';
      }
    }

    async function fetchBanners() {
      try {
        renderSkeletons('mktBannersGrid', 2);
        const res = await apiFetch('/api/marketing/banners');
        if (!res.ok) throw new Error('Failed to load banners');
        bannersData = await res.json();
        renderBanners();
      } catch (err) {
        document.getElementById('mktBannersGrid').innerHTML = '<span style="color:var(--red);font-size:12px">Error loading banners</span>';
      }
    }

    function renderBanners() {
      const grid = document.getElementById('mktBannersGrid');
      const summary = document.getElementById('mktBannersSummary');
      const totalBanners = bannersData.length;
      const totalPlacements = bannersData.reduce((s, b) => s + (b.placements?.length || 0), 0);
      const totalViews = bannersData.reduce((s, b) => s + (b.total_views || 0), 0);
      const totalClicks = bannersData.reduce((s, b) => s + (b.total_clicks || 0), 0);
      const ctr = totalViews > 0 ? ((totalClicks / totalViews) * 100).toFixed(1) : '0.0';

      summary.innerHTML = `
        <div class="marketing-stat"><span class="marketing-stat-value" style="color:var(--cyan)">${totalBanners}</span> banners</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${totalPlacements}</span> placements</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${totalViews}</span> views</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${totalClicks}</span> clicks</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${ctr}%</span> CTR</div>`;

      if (totalBanners === 0) {
        grid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">\uD83C\uDFA8</div><div class="empty-state-text">No banners yet.<br>Create your first banner to start managing ads across your sites.</div><button class="btn" onclick="showBannerForm()" style="color:var(--cyan)">+ Create Banner</button></div>`;
        return;
      }

      grid.innerHTML = bannersData.map(b => {
        const typeBadge = { bannerforge: 'var(--purple)', image_url: 'var(--blue)', custom_html: 'var(--yellow)' };
        const typeColor = typeBadge[b.type] || 'var(--text-muted)';
        const activePl = (b.placements || []).filter(p => p.status === 'active').length;
        const bCtr = b.total_views > 0 ? ((b.total_clicks / b.total_views) * 100).toFixed(1) + '% CTR' : 'No data';
        const preview = b.content && b.content.indexOf('data:image') === 0
          ? `<img src="${escapeHtml(b.content)}" style="max-width:120px;max-height:40px;border-radius:4px;margin-right:8px" alt="">`
          : b.type === 'image_url' ? `<img src="${escapeHtml(b.content)}" style="max-width:120px;max-height:40px;border-radius:4px;margin-right:8px" alt="" onerror="this.style.display='none'">`
          : '';
        return `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="display:flex;align-items:center">${preview}<span style="font-weight:600;font-size:13px">${escapeHtml(b.name)}</span></div>
            <span style="font-size:10px;color:${typeColor};text-transform:uppercase;font-weight:600">${b.type.replace('_', ' ')}</span>
          </div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">
            ${b.width}x${b.height} &mdash; ${activePl} active placement${activePl !== 1 ? 's' : ''}
            ${b.click_url ? ` &mdash; <span style="color:var(--cyan)">${escapeHtml(b.click_url)}</span>` : ''}
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:11px;color:var(--text-muted)">${b.total_views} views / ${b.total_clicks} clicks (${bCtr})</span>
            <div style="display:flex;gap:4px">
              <button class="btn" onclick="openPlacementPanel(${b.id})" style="color:var(--green);font-size:11px;padding:3px 8px">Placements</button>
              ${b.type === 'bannerforge' ? `<button class="btn" onclick="regenerateBanner(${b.id})" style="color:var(--purple);font-size:11px;padding:3px 8px">Regen</button>` : ''}
              <button class="btn" onclick="deleteBanner(${b.id})" style="color:var(--red);font-size:11px;padding:3px 8px">Delete</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function toggleBannerFields() {
      const type = document.getElementById('bnType').value;
      document.getElementById('bnBannerforgeFields').style.display = type === 'bannerforge' ? 'flex' : 'none';
      document.getElementById('bnUrlField').style.display = type !== 'bannerforge' ? 'block' : 'none';
    }

    function showBannerForm() {
      document.getElementById('bannerFormContainer').style.display = '';
      toggleBannerFields();
    }
    function hideBannerForm() { document.getElementById('bannerFormContainer').style.display = 'none'; }

    async function submitBannerForm() {
      const btn = document.getElementById('bnSubmitBtn');
      btn.disabled = true; btn.textContent = 'Creating...';
      try {
        const type = document.getElementById('bnType').value;
        const [w, h] = document.getElementById('bnSize').value.split('x').map(Number);
        const body = { name: document.getElementById('bnName').value, type, width: w, height: h, click_url: document.getElementById('bnClickUrl').value || undefined };
        if (type === 'bannerforge') {
          body.bannerforge_config = {
            brand: { companyName: document.getElementById('bnBrand').value || body.name, colors: ['#1a1a2e', '#e94560', '#0f3460'] },
            copy: { headline: document.getElementById('bnHeadline').value || body.name, cta: document.getElementById('bnCta').value || 'Learn More' },
          };
        } else {
          body.content = document.getElementById('bnContent').value;
        }
        const res = await apiFetch('/api/marketing/banners', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Create failed'); }
        hideBannerForm();
        bannersData = null;
        fetchBanners();
        showToast('Banner created successfully', 'success');
      } catch (err) { showToast(err.message, 'error'); }
      finally { btn.disabled = false; btn.textContent = 'Create'; }
    }

    async function deleteBanner(id) {
      if (!confirm('Delete this banner and all its placements?')) return;
      try {
        const res = await apiFetch('/api/marketing/banners/' + id, { method: 'DELETE' });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Delete failed'); }
        showToast('Banner deleted', 'success');
      } catch (err) { showToast(err.message, 'error'); }
      bannersData = null; fetchBanners();
    }

    async function regenerateBanner(id) {
      try {
        const res = await apiFetch('/api/marketing/banners/' + id + '/regenerate', { method: 'POST' });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Regenerate failed'); }
        bannersData = null; fetchBanners();
      } catch (err) { showToast(err.message, 'error'); }
    }

    function openPlacementPanel(bannerId) {
      if (!bannersData) return;
      currentPlacementBannerId = bannerId;
      const banner = bannersData.find(b => b.id === bannerId);
      if (!banner) return;
      document.getElementById('placementBannerName').textContent = banner.name;
      // Populate app dropdown
      if (appData && appData.length > 0) {
        const sel = document.getElementById('plApp');
        sel.innerHTML = appData.map(a => {
          const slug = a.name.toLowerCase().replace(/\s+/g, '-');
          return `<option value="${escapeHtml(slug)}">${escapeHtml(a.name)}</option>`;
        }).join('');
      }
      renderPlacements(banner);
      document.getElementById('bannerPlacementPanel').style.display = '';
    }

    function closePlacementPanel() {
      document.getElementById('bannerPlacementPanel').style.display = 'none';
      currentPlacementBannerId = null;
    }

    function renderPlacements(banner) {
      const list = document.getElementById('placementList');
      const placements = banner.placements || [];
      if (placements.length === 0) {
        list.innerHTML = '<div style="color:var(--text-muted);font-size:11px;margin-bottom:8px">No placements yet. Add this banner to a site below.</div>';
        return;
      }
      const statusColors = { draft: 'var(--text-muted)', active: 'var(--green)', paused: 'var(--yellow)', ended: 'var(--red)' };
      list.innerHTML = placements.map(p => {
        const sc = statusColors[p.status] || 'var(--text-muted)';
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">
          <div style="font-size:12px"><strong>${escapeHtml(p.app_slug)}</strong> <span style="color:${sc};font-size:10px;text-transform:uppercase">${p.status}</span> <span style="color:var(--text-muted);font-size:10px">w:${p.weight}</span></div>
          <div style="display:flex;gap:4px;align-items:center">
            <span style="font-size:10px;color:var(--text-muted)">${p.views}v/${p.clicks}c</span>
            ${p.status === 'draft' ? `<button class="btn" onclick="updatePlacement(${p.id},'active')" style="color:var(--green);font-size:10px;padding:2px 6px">Activate</button>` : ''}
            ${p.status === 'active' ? `<button class="btn" onclick="updatePlacement(${p.id},'paused')" style="color:var(--yellow);font-size:10px;padding:2px 6px">Pause</button>` : ''}
            ${p.status === 'paused' ? `<button class="btn" onclick="updatePlacement(${p.id},'active')" style="color:var(--green);font-size:10px;padding:2px 6px">Resume</button>` : ''}
            <button class="btn" onclick="removePlacement(${p.id})" style="color:var(--red);font-size:10px;padding:2px 6px">Remove</button>
          </div>
        </div>`;
      }).join('');
    }

    async function addPlacement() {
      if (!currentPlacementBannerId) return;
      const appSlug = document.getElementById('plApp').value;
      const weight = parseInt(document.getElementById('plWeight').value) || 100;
      try {
        const res = await apiFetch('/api/marketing/placements', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ banner_id: currentPlacementBannerId, app_slug: appSlug, weight }) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed'); }
        showToast('Placement added', 'success');
        bannersData = null; await fetchBanners();
        const banner = bannersData.find(b => b.id === currentPlacementBannerId);
        if (banner) renderPlacements(banner);
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function updatePlacement(id, status) {
      try {
        const res = await apiFetch('/api/marketing/placements/' + id, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed'); }
        showToast('Placement ' + status, 'success');
        bannersData = null; await fetchBanners();
        if (currentPlacementBannerId) {
          const banner = bannersData.find(b => b.id === currentPlacementBannerId);
          if (banner) renderPlacements(banner);
        }
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function removePlacement(id) {
      try {
        const res = await apiFetch('/api/marketing/placements/' + id, { method: 'DELETE' });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed'); }
        bannersData = null; await fetchBanners();
        if (currentPlacementBannerId) {
          const banner = bannersData.find(b => b.id === currentPlacementBannerId);
          if (banner) renderPlacements(banner);
        }
      } catch (err) { showToast(err.message, 'error'); }
    }

    // =============================================
    // Marketing Playbook
    // =============================================

    function initPlaybookFilter() {
      const sel = document.getElementById('playbookAppFilter');
      if (!appData || appData.length === 0) {
        sel.innerHTML = '<option value="">Loading apps...</option>';
        playbookFilterInit = false;
        setTimeout(initPlaybookFilter, 500);
        return;
      }
      if (playbookFilterInit) return;
      playbookFilterInit = true;
      sel.innerHTML = appData.filter(a => a.type === 'saas' || a.type === 'tool').map(a => {
        const slug = a.name.toLowerCase().replace(/\s+/g, '-');
        return `<option value="${escapeHtml(slug)}">${escapeHtml(a.name)}</option>`;
      }).join('');
    }

    async function fetchPlaybook() {
      const appSlug = document.getElementById('playbookAppFilter').value;
      if (!appSlug) return;
      try {
        renderSkeletons('mktPlaybookGrid', 3);
        const res = await apiFetch('/api/marketing/playbooks?app=' + encodeURIComponent(appSlug));
        if (!res.ok) throw new Error('Failed to load playbook');
        playbookData = await res.json();
        renderPlaybook();
      } catch (err) {
        const msg = err.message || '';
        if (msg.includes('Anthropic') || msg.includes('API key') || msg.includes('ANTHROPIC')) {
          document.getElementById('mktPlaybookGrid').innerHTML = '<span style="color:var(--text-muted);font-size:12px">Configure an Anthropic API key in one of your app .env files to enable AI playbooks.</span>';
        } else {
          document.getElementById('mktPlaybookGrid').innerHTML = '<span style="color:var(--red);font-size:12px">Error loading playbook</span>';
        }
      }
    }

    const sectionLabels = { strategy: 'Strategy', channels: 'Channels', content: 'Content Plan', seo: 'SEO', email: 'Email', crosssell: 'Cross-Sell', notes: 'Notes' };
    const sectionColors = { strategy: 'var(--cyan)', channels: 'var(--blue)', content: 'var(--green)', seo: 'var(--yellow)', email: 'var(--purple)', crosssell: 'var(--red)', notes: 'var(--text-muted)' };

    function renderPlaybook() {
      const grid = document.getElementById('mktPlaybookGrid');
      const summary = document.getElementById('mktPlaybookSummary');
      const appSlug = document.getElementById('playbookAppFilter').value;

      if (!playbookData || playbookData.length === 0) {
        summary.innerHTML = '';
        grid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">\uD83D\uDCD6</div><div class="empty-state-text">No marketing playbook for this app yet.<br>Generate one with AI or create entries manually.</div><button class="btn" onclick="generatePlaybook()" style="color:var(--purple);padding:6px 16px">Generate with AI</button> <button class="btn" onclick="showPlaybookForm()" style="color:var(--cyan);padding:6px 16px">Create Manually</button></div>`;
        return;
      }

      const sections = [...new Set(playbookData.map(e => e.section))];
      summary.innerHTML = `<div class="marketing-stat"><span class="marketing-stat-value" style="color:var(--cyan)">${playbookData.length}</span> entries</div>
        <div class="marketing-stat"><span class="marketing-stat-value">${sections.length}</span> sections</div>`;

      grid.innerHTML = playbookData.map(e => {
        const sColor = sectionColors[e.section] || 'var(--text-muted)';
        const sLabel = sectionLabels[e.section] || e.section;
        const statusColors = { draft: 'var(--text-muted)', active: 'var(--green)', completed: 'var(--cyan)' };
        const stColor = statusColors[e.status] || 'var(--text-muted)';
        // Simple markdown to HTML
        const html = escapeHtml(e.content)
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/^- (.+)/gm, '&bull; $1')
          .replace(/^(\d+)\. (.+)/gm, '$1. $2')
          .replace(/\n/g, '<br>');
        return `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div><span style="font-size:10px;color:${sColor};font-weight:600;text-transform:uppercase;margin-right:6px">${sLabel}</span><span style="font-weight:600;font-size:13px">${escapeHtml(e.title)}</span></div>
            <div style="display:flex;gap:4px;align-items:center">
              <span style="font-size:10px;color:${stColor};text-transform:uppercase">${e.status}</span>
              ${e.status === 'draft' ? `<button class="btn" onclick="updatePlaybookStatus(${e.id},'active')" style="color:var(--green);font-size:10px;padding:2px 6px">Activate</button>` : ''}
              ${e.status === 'active' ? `<button class="btn" onclick="updatePlaybookStatus(${e.id},'completed')" style="color:var(--cyan);font-size:10px;padding:2px 6px">Complete</button>` : ''}
              <button class="btn" onclick="deletePlaybookEntry(${e.id})" style="color:var(--red);font-size:10px;padding:2px 6px">Delete</button>
            </div>
          </div>
          <div style="font-size:12px;color:var(--text);line-height:1.5">${html}</div>
        </div>`;
      }).join('');
    }

    function showPlaybookForm() { document.getElementById('playbookFormContainer').style.display = ''; }
    function hidePlaybookForm() { document.getElementById('playbookFormContainer').style.display = 'none'; }

    async function submitPlaybookEntry() {
      const appSlug = document.getElementById('playbookAppFilter').value;
      if (!appSlug) { showToast('Select an app first', 'warning'); return; }
      try {
        const body = {
          app_slug: appSlug,
          section: document.getElementById('pbSection').value,
          title: document.getElementById('pbTitle').value,
          content: document.getElementById('pbContent').value,
        };
        if (!body.title?.trim() || !body.content?.trim()) { showToast('Title and content required', 'warning'); return; }
        const res = await apiFetch('/api/marketing/playbooks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed'); }
        hidePlaybookForm();
        playbookData = null;
        fetchPlaybook();
        showToast('Playbook entry saved', 'success');
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function updatePlaybookStatus(id, status) {
      try {
        const res = await apiFetch('/api/marketing/playbooks/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed'); }
        playbookData = null; fetchPlaybook();
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function deletePlaybookEntry(id) {
      if (!confirm('Delete this playbook entry?')) return;
      try {
        const res = await apiFetch('/api/marketing/playbooks/' + id, { method: 'DELETE' });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed'); }
        playbookData = null; fetchPlaybook();
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function generatePlaybook() {
      const appSlug = document.getElementById('playbookAppFilter').value;
      if (!appSlug) { showToast('Select an app first', 'warning'); return; }
      const btn = document.getElementById('pbGenerateBtn');
      btn.disabled = true; btn.textContent = 'Generating...';
      try {
        const res = await apiFetch('/api/marketing/playbooks/' + encodeURIComponent(appSlug) + '/generate', { method: 'POST' });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Generation failed'); }
        const data = await res.json();
        playbookData = data.entries;
        renderPlaybook();
        showToast(`Playbook generated: ${(data.entries||[]).length} entries`, 'success');
      } catch (err) { showToast(err.message, 'error'); }
      finally { btn.disabled = false; btn.textContent = 'Generate with AI'; }
    }

    function toggleMarketing() {
      const panel = document.getElementById('marketingPanel');
      if (panel.classList.contains('visible')) {
        panel.classList.remove('visible');
        return;
      }
      panel.classList.add('visible');
      if (!mktLoaded) fetchMktAll();
    }

    async function viewLogs(containerName, lines = 80) {
      const area = document.getElementById('logArea');
      area.innerHTML = `<div class="log-viewer" style="color:var(--text-muted)">Loading logs...</div>`;
      try {
        const res = await fetch(`/api/containers/${containerName}/logs?lines=${lines}`);
        const text = await res.text();
        area.innerHTML = `
          <div class="log-viewer-header">
            <h3>Logs: ${containerName}</h3>
            <span style="font-size:11px;color:var(--text-muted)">${lines} lines</span>
          </div>
          <div class="log-viewer">${escapeHtml(text)}</div>`;
        // Scroll to bottom
        const viewer = area.querySelector('.log-viewer');
        viewer.scrollTop = viewer.scrollHeight;
      } catch (err) {
        area.innerHTML = `<div class="log-viewer" style="color:var(--red)">Error: ${err.message}</div>`;
      }
    }

    function renderPingChart(pings) {
      const w = 660, h = 50, pad = 2;
      const max = Math.max(...pings) * 1.1 || 1;
      const min = Math.min(...pings) * 0.9;
      const range = max - min || 1;
      const points = pings.map((p, i) => {
        const x = pad + (i / (pings.length - 1)) * (w - pad * 2);
        const y = pad + (1 - (p - min) / range) * (h - pad * 2);
        return `${x},${y}`;
      });
      const fillPoints = `${pad},${h - pad} ${points.join(' ')} ${w - pad},${h - pad}`;
      return `<svg viewBox="0 0 ${w} ${h}" style="width:100%;height:50px;margin-bottom:4px">
        <defs><linearGradient id="pg" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="var(--green)" stop-opacity="0.2"/>
          <stop offset="100%" stop-color="var(--green)" stop-opacity="0"/>
        </linearGradient></defs>
        <polygon points="${fillPoints}" fill="url(#pg)"/>
        <polyline points="${points.join(' ')}" fill="none" stroke="var(--green)" stroke-width="1.5" stroke-linejoin="round"/>
      </svg>`;
    }

    async function restartContainer(name, btn) {
      if (!confirm(`Restart container "${name}"?`)) return;
      const orig = btn.textContent;
      btn.textContent = 'Restarting...';
      btn.disabled = true;
      try {
        const res = await fetch(`/api/containers/${name}/restart`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          btn.textContent = 'Restarted';
          btn.style.color = 'var(--green)';
          setTimeout(() => fetchAll(), 3000);
        } else {
          btn.textContent = 'Failed';
          btn.style.color = 'var(--red)';
        }
      } catch (err) {
        btn.textContent = 'Error';
        btn.style.color = 'var(--red)';
      }
      setTimeout(() => { btn.textContent = orig; btn.style.color = 'var(--yellow)'; btn.disabled = false; }, 5000);
    }

    function escapeHtml(str) {
      return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const icons = { success: '\u2713', error: '\u2717', info: '\u2139', warning: '\u26A0' };
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = `<span>${icons[type] || ''}</span><span>${escapeHtml(message)}</span>`;
      container.appendChild(toast);
      setTimeout(() => { if (toast.parentNode) toast.remove(); }, 4200);
    }

    function renderSkeletons(containerId, count = 3) {
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = Array.from({length: count}, () =>
        `<div class="skeleton skeleton-card" style="margin-bottom:8px"></div>`
      ).join('');
    }

    let eventsData = [];

    async function toggleActivity() {
      const panel = document.getElementById('activityPanel');
      if (panel.classList.contains('visible')) {
        panel.classList.remove('visible');
        return;
      }
      panel.classList.add('visible');
      document.getElementById('activityList').innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading...</span>';
      try {
        const res = await apiFetch('/api/events');
        const data = await res.json();
        eventsData = data.events || [];
        renderActivity();
      } catch (err) {
        document.getElementById('activityList').innerHTML = '<span style="color:var(--red);font-size:12px">Error loading events</span>';
      }
    }

    function renderActivity() {
      const list = document.getElementById('activityList');
      document.getElementById('activityCount').textContent = eventsData.length + ' events';
      if (eventsData.length === 0) {
        list.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No events in the last 6 hours</span>';
        return;
      }
      list.innerHTML = eventsData.map(e => {
        const action = (e.action || '').split(':')[0];
        const detail = e.action?.includes(':') ? e.action.split(':')[1] : '';
        const time = new Date(e.time * 1000);
        const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return `<div class="activity-item">
          <span class="activity-time">${timeStr}</span>
          <span class="activity-action ${escapeHtml(action)}">${escapeHtml(action)}</span>
          <span class="activity-name">${escapeHtml(e.actor || '')}${detail ? ' <span style="color:var(--text-muted)">(' + escapeHtml(detail) + ')</span>' : ''}</span>
        </div>`;
      }).join('');
    }

    function toggleSSLPanel() {
      const panel = document.getElementById('sslPanel');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        renderSSLPanel();
      } else {
        panel.style.display = 'none';
      }
    }

    function renderSSLPanel() {
      const list = document.getElementById('sslList');
      if (!sslData.domains) { list.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading...</span>'; return; }
      const sorted = Object.entries(sslData.domains).sort((a, b) => (a[1].daysLeft || 999) - (b[1].daysLeft || 999));
      list.innerHTML = sorted.map(([domain, info]) => {
        if (info.error) return `<div style="font-size:12px;padding:6px 10px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)"><span style="color:var(--red)">${domain}</span> <span style="color:var(--text-muted)">unreachable</span></div>`;
        const color = info.daysLeft <= 7 ? 'var(--red)' : info.daysLeft <= 30 ? 'var(--yellow)' : 'var(--green)';
        const barW = Math.min(100, Math.round((info.daysLeft / 90) * 100));
        return `<div style="font-size:12px;padding:6px 10px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>${domain}</span><span style="color:${color};font-weight:600">${info.daysLeft}d</span></div>
          <div style="height:2px;background:var(--surface3);border-radius:1px"><div style="width:${barW}%;height:100%;background:${color};border-radius:1px"></div></div>
        </div>`;
      }).join('');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    async function dockerPrune(btn) {
      if (!confirm('Run Docker prune? This removes stopped containers, dangling images, and build cache.')) return;
      const orig = btn.textContent;
      btn.textContent = 'Pruning...';
      btn.disabled = true;
      try {
        const res = await apiFetch('/api/actions/prune', { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          const freed = data.spaceReclaimed > 0 ? ' Freed ' + fmt(data.spaceReclaimed) : '';
          btn.textContent = 'Done!' + freed;
          btn.style.color = 'var(--green)';
          setTimeout(() => fetchAll(), 2000);
        } else {
          btn.textContent = 'Failed';
          btn.style.color = 'var(--red)';
        }
      } catch { btn.textContent = 'Error'; btn.style.color = 'var(--red)'; }
      setTimeout(() => { btn.textContent = orig; btn.style.color = ''; btn.disabled = false; }, 5000);
    }

    // Search/filter
    let searchTerm = '';
    function filterApps(term) {
      searchTerm = term.toLowerCase();
      renderApps(appData);
    }

    // === Morning Briefing ===
    let briefingData = null;
    let briefingDismissed = false;

    async function fetchBriefing(force = false) {
      try {
        const res = await apiFetch('/api/briefing' + (force ? '?force=true' : ''));
        briefingData = await res.json();
        renderBriefing();
      } catch (err) {
        const msg = err.message || '';
        if (msg.includes('Anthropic') || msg.includes('API key') || msg.includes('ANTHROPIC')) {
          document.getElementById('briefingBody').innerHTML = '<span style="color:var(--text-muted)">Configure an Anthropic API key in one of your app .env files to enable AI briefings.</span>';
        } else {
          document.getElementById('briefingBody').innerHTML = `<span style="color:var(--red)">Error: ${escapeHtml(msg)}</span>`;
        }
      }
    }

    function renderBriefing() {
      if (!briefingData) return;
      const body = document.getElementById('briefingBody');
      const meta = document.getElementById('briefingMeta');

      if (briefingData.type === 'ai' && briefingData.briefing) {
        // Simple markdown to HTML
        let html = escapeHtml(briefingData.briefing);
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>\n?)+/g, (m) => '<ul>' + m + '</ul>');
        html = html.replace(/\n\n/g, '<br><br>');
        html = html.replace(/\n/g, '<br>');
        body.innerHTML = html;
        meta.textContent = `Generated ${new Date(briefingData.generated).toLocaleTimeString()}  ${briefingData.tokens || 0} tokens`;
      } else if (briefingData.type === 'raw') {
        const c = briefingData.context;
        let html = '<strong>System:</strong> ';
        if (c.system?.diskUsedPct) html += `Disk ${c.system.diskUsedPct}%, Memory ${c.system.memUsedPct}%`;
        html += `<br><strong>Containers:</strong> ${c.containers?.running || '?'}/${c.containers?.total || '?'} running`;
        if (c.containers?.unhealthy?.length) html += `  <span style="color:var(--red)">${c.containers.unhealthy.length} unhealthy</span>`;
        if (c.revenue) html += `<br><strong>Revenue:</strong> ${c.revenue.totalMRR} EUR MRR, ${c.revenue.revenue30d} EUR 30d`;
        html += '<br><em style="color:var(--text-muted)">No Anthropic key available for AI summary</em>';
        body.innerHTML = html;
        meta.textContent = 'Raw data (no AI summary)';
      }
    }

    function toggleBriefing() {
      const panel = document.getElementById('briefingPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active') && !briefingData) fetchBriefing();
    }

    function dismissBriefing() {
      document.getElementById('briefingPanel').classList.remove('active');
      briefingDismissed = true;
      sessionStorage.setItem('briefingDismissed', '1');
    }

    // Auto-show briefing on first visit of the day
    function maybeShowBriefing() {
      const lastShown = localStorage.getItem('briefingLastDate');
      const today = new Date().toDateString();
      if (lastShown !== today && !sessionStorage.getItem('briefingDismissed')) {
        localStorage.setItem('briefingLastDate', today);
        toggleBriefing();
      }
    }

    // === Command Palette ===
    let cmdSelectedIdx = 0;
    let cmdResults = [];
    let cmdDebounce = null;

    function openCommandPalette() {
      const overlay = document.getElementById('cmdOverlay');
      overlay.classList.add('active');
      const input = document.getElementById('cmdInput');
      input.value = '';
      input.focus();
      cmdResults = [];
      cmdSelectedIdx = 0;
      document.getElementById('cmdResults').innerHTML = '';
      // Show default commands
      searchCommands('');
    }

    function closeCommandPalette() {
      document.getElementById('cmdOverlay').classList.remove('active');
    }

    async function searchCommands(query) {
      if (!query && !cmdResults.length) {
        // Show default suggestions
        cmdResults = [
          { type: 'command', cmd: 'briefing', label: 'Morning Briefing', description: 'AI operations summary', shortcut: 'd' },
          { type: 'command', cmd: 'healing', label: 'Auto-Healing Log', description: 'Recent auto-healing actions', shortcut: 'h' },
          { type: 'command', cmd: 'revenue', label: 'Revenue Dashboard', description: 'Open marketing revenue', shortcut: 'm' },
          { type: 'command', cmd: 'seo', label: 'SEO Audit', description: 'Open SEO audit tab', shortcut: '' },
          { type: 'command', cmd: 'backups', label: 'Backup Status', description: 'Database backup panel', shortcut: 'b' },
          { type: 'command', cmd: 'errors', label: 'Error Tracker', description: 'App errors and performance', shortcut: 'e' },
        ];
        renderCmdResults();
        return;
      }
      try {
        const res = await apiFetch('/api/command/search?q=' + encodeURIComponent(query));
        const data = await res.json();
        cmdResults = data.results || [];
        cmdSelectedIdx = 0;
        renderCmdResults();
      } catch {}
    }

    function renderCmdResults() {
      const container = document.getElementById('cmdResults');
      if (!cmdResults.length) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:12px">No results</div>';
        return;
      }
      container.innerHTML = cmdResults.map((r, i) => {
        const iconClass = r.type === 'app' ? 'app' : r.type === 'action' ? 'action' : 'command';
        const icon = r.type === 'app' ? '&#9679;' : r.type === 'action' ? '&#9654;' : '&#8984;';
        const name = escapeHtml(r.name || r.label || r.cmd);
        const desc = escapeHtml(r.description || r.domain || '');
        const shortcut = r.shortcut ? `<span class="cmd-item-shortcut">${escapeHtml(r.shortcut)}</span>` : '';
        return `<div class="cmd-item${i === cmdSelectedIdx ? ' selected' : ''}" onclick="executeCmdResult(${i})" data-idx="${i}">
          <div class="cmd-item-icon ${iconClass}">${icon}</div>
          <div class="cmd-item-text"><div class="cmd-item-name">${name}</div><div class="cmd-item-desc">${desc}</div></div>
          ${shortcut}
        </div>`;
      }).join('');
    }

    function executeCmdResult(idx) {
      const r = cmdResults[idx];
      if (!r) return;
      closeCommandPalette();

      if (r.type === 'app') {
        openDetail(r.name);
      } else if (r.type === 'action') {
        if (r.action === 'log') openDetail(r.app);
        else if (r.action === 'restart') { if (confirm(`Restart ${r.app}?`)) fetch(`/api/containers/${r.slug}/restart`, { method: 'POST' }).then(() => fetchAll()); }
        else if (r.action === 'seo') { toggleMarketing(); setTimeout(() => switchMktTab('seo', document.querySelector('.mkt-tab:nth-child(4)')), 100); }
        else if (r.action === 'revenue') { toggleMarketing(); setTimeout(() => switchMktTab('revenue', document.querySelector('.mkt-tab:nth-child(2)')), 100); }
        else if (r.action === 'env') openDetail(r.app);
        else openDetail(r.app);
      } else if (r.type === 'command') {
        const cmdMap = {
          briefing: () => toggleBriefing(),
          revenue: () => { if (!document.getElementById('marketingPanel').classList.contains('active')) toggleMarketing(); setTimeout(() => switchMktTab('revenue', document.querySelector('.mkt-tab:nth-child(2)')), 100); },
          seo: () => { if (!document.getElementById('marketingPanel').classList.contains('active')) toggleMarketing(); setTimeout(() => switchMktTab('seo', document.querySelector('.mkt-tab:nth-child(4)')), 100); },
          backups: () => toggleBackups(),
          prune: () => dockerPrune(document.querySelector('.header-btn[onclick*="dockerPrune"]')),
          healing: () => toggleHealing(),
          security: () => toggleSecurity(),
          projects: () => toggleProjects(),
          tasks: () => { toggleProjects(); setTimeout(() => switchProjTab('tasks', document.querySelector('.proj-tab:nth-child(2)')), 100); },
          roadmap: () => { toggleProjects(); setTimeout(() => switchProjTab('roadmap', document.querySelector('.proj-tab:nth-child(3)')), 100); },
          overdue: () => { toggleProjects(); setTimeout(() => { switchProjTab('tasks', document.querySelector('.proj-tab:nth-child(2)')); projTaskFilter.status = 'overdue'; fetchProjectTasks(); }, 100); },
          ops: () => toggleOps(),
          errors: () => toggleErrors(),
          worry: () => { toggleOps(); setTimeout(() => switchOpsTab('pulse', document.querySelector('.ops-tab:first-child')), 100); },
          drift: () => { toggleOps(); setTimeout(() => switchOpsTab('timeline', document.querySelector('.ops-tab:nth-child(4)')), 100); },
          reportcards: () => { toggleOps(); setTimeout(() => switchOpsTab('reportcards', document.querySelector('.ops-tab:nth-child(3)')), 100); },
          emails: () => { if (!document.getElementById('marketingPanel').classList.contains('active')) toggleMarketing(); setTimeout(() => switchMktTab('emails', document.querySelector('.mkt-tab:nth-child(5)')), 100); },
          content: () => { if (!document.getElementById('marketingPanel').classList.contains('active')) toggleMarketing(); setTimeout(() => switchMktTab('content', document.querySelector('.mkt-tab:nth-child(6)')), 100); },
          cohorts: () => { if (!document.getElementById('marketingPanel').classList.contains('active')) toggleMarketing(); setTimeout(() => { switchMktTab('revenue', document.querySelector('.mkt-tab:nth-child(2)')); setTimeout(() => switchRevenueSubtab('cohorts', document.querySelector('.mkt-subtab:nth-child(2)')), 100); }, 100); },
          keys: () => toggleKeyHealth(),
          ssl: () => toggleSSLPanel(),
          crosspromo: () => { if (!document.getElementById('marketingPanel').classList.contains('visible')) toggleMarketing(); setTimeout(() => switchMktTab('crosspromo', document.querySelector('.mkt-tab:nth-child(7)')), 100); },
          banners: () => { if (!document.getElementById('marketingPanel').classList.contains('visible')) toggleMarketing(); setTimeout(() => switchMktTab('banners', document.querySelector('.mkt-tab:nth-child(8)')), 100); },
          playbook: () => { if (!document.getElementById('marketingPanel').classList.contains('visible')) toggleMarketing(); setTimeout(() => switchMktTab('playbook', document.querySelector('.mkt-tab:nth-child(9)')), 100); },
          status: () => window.scrollTo({ top: 0, behavior: 'smooth' }),
        };
        if (cmdMap[r.cmd]) cmdMap[r.cmd]();
      }
    }

    // Command palette input handling
    document.getElementById('cmdInput').addEventListener('input', (e) => {
      clearTimeout(cmdDebounce);
      cmdDebounce = setTimeout(() => searchCommands(e.target.value), 150);
    });

    document.getElementById('cmdInput').addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') { e.preventDefault(); cmdSelectedIdx = Math.min(cmdSelectedIdx + 1, cmdResults.length - 1); renderCmdResults(); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); cmdSelectedIdx = Math.max(cmdSelectedIdx - 1, 0); renderCmdResults(); }
      else if (e.key === 'Enter') { e.preventDefault(); executeCmdResult(cmdSelectedIdx); }
      else if (e.key === 'Escape') { closeCommandPalette(); }
    });

    document.getElementById('cmdOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeCommandPalette();
    });

    // === Auto-Healing Panel ===
    let healingData = null;

    async function fetchHealingLog() {
      try {
        const res = await apiFetch('/api/healing/log');
        healingData = await res.json();
        renderHealingLog();
        updateHealingShield();
      } catch {}
    }

    function renderHealingLog() {
      const list = document.getElementById('healingList');
      if (!healingData?.logs?.length) {
        list.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px">No healing actions recorded yet. The engine checks every 2 minutes.</div>';
        return;
      }
      list.innerHTML = healingData.logs.slice(0, 20).map(h => {
        const time = new Date(h.timestamp + 'Z').toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const badge = h.result;
        const actions = h.result === 'pending' ? `
          <button class="btn" onclick="approveHealing(${h.id})" style="font-size:10px;padding:2px 8px">Approve</button>
          <button class="btn" onclick="dismissHealing(${h.id})" style="font-size:10px;padding:2px 8px">Dismiss</button>
        ` : '';
        return `<div class="healing-item">
          <span class="healing-badge ${escapeHtml(badge)}">${escapeHtml(badge)}</span>
          <span style="color:var(--text-dim);min-width:60px">${escapeHtml(h.app_slug || 'system')}</span>
          <span style="flex:1">${escapeHtml(h.condition)} &rarr; ${escapeHtml(h.action_taken)}</span>
          <span style="color:var(--text-muted);font-size:10px">${time}</span>
          ${actions}
        </div>`;
      }).join('');
    }

    function updateHealingShield() {
      const shield = document.getElementById('healingShield');
      const pending = healingData?.pending || 0;
      if (pending > 0) {
        shield.innerHTML = `Healing <span style="background:var(--yellow);color:var(--bg);padding:1px 5px;border-radius:8px;font-size:9px;font-weight:700">${pending}</span>`;
      } else {
        shield.textContent = 'Healing';
      }
    }

    function toggleHealing() {
      const panel = document.getElementById('healingPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active')) fetchHealingLog();
    }

    async function approveHealing(id) {
      try {
        await apiFetch('/api/healing/approve/' + id, { method: 'POST' });
        fetchHealingLog();
      } catch {}
    }

    async function dismissHealing(id) {
      try {
        await apiFetch('/api/healing/dismiss/' + id, { method: 'POST' });
        fetchHealingLog();
      } catch {}
    }

    // --- Security Manager ---
    let securityData = null;

    function toggleSecurity() {
      const panel = document.getElementById('securityPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active') && !securityData) fetchSecurityStatus();
    }

    function switchSecTab(tabName, btn) {
      document.querySelectorAll('.sec-tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sec-tab').forEach(b => b.classList.remove('active'));
      document.getElementById('sec-' + tabName).classList.add('active');
      btn.classList.add('active');
    }

    async function fetchSecurityStatus() {
      try {
        document.getElementById('secDashboardContent').innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading latest scan...</span>';
        const res = await apiFetch('/api/security/status');
        const data = await res.json();
        if (data.status === 'no_scan') {
          document.getElementById('secDashboardContent').innerHTML = '<span style="color:var(--text-muted);font-size:12px">No scan yet. Press "Run Scan" to audit your infrastructure.</span>';
          return;
        }
        securityData = data;
        renderSecDashboard();
        renderSecContainers();
        renderSecCertificates();
        renderSecHeaders();
        renderSecNetwork();
        updateSecGradeBadge();
      } catch (err) {
        document.getElementById('secDashboardContent').innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${escapeHtml(err.message)}</span>`;
      }
    }

    async function runSecurityScan() {
      const btn = document.getElementById('secScanBtn');
      btn.disabled = true;
      btn.textContent = 'Scanning...';
      try {
        const res = await apiFetch('/api/security/scan');
        securityData = await res.json();
        renderSecDashboard();
        renderSecContainers();
        renderSecCertificates();
        renderSecHeaders();
        renderSecNetwork();
        updateSecGradeBadge();
        showToast(`Security scan complete: ${securityData.grade} (${securityData.overall_score}/100)`, securityData.overall_score >= 75 ? 'success' : 'warning');
      } catch (err) {
        showToast('Security scan failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Run Scan';
      }
    }

    function updateSecGradeBadge() {
      if (!securityData) return;
      const badge = document.getElementById('secGradeBadge');
      const s = securityData.overall_score;
      const g = securityData.grade;
      const color = s >= 90 ? 'var(--green)' : s >= 75 ? 'var(--yellow)' : s >= 60 ? 'var(--orange)' : 'var(--red)';
      badge.textContent = g;
      badge.style.background = color + '20';
      badge.style.color = color;
      badge.style.display = 'inline';
    }

    function scoreColor(s) { return s >= 90 ? 'var(--green)' : s >= 75 ? 'var(--yellow)' : s >= 60 ? 'var(--orange)' : 'var(--red)'; }

    function renderSecDashboard() {
      if (!securityData) return;
      const d = securityData;
      const ts = d.timestamp ? new Date(d.timestamp + 'Z').toLocaleString() : '';
      document.getElementById('secLastScan').textContent = ts ? 'Last scan: ' + ts : '';
      const cats = d.category_scores || {};

      let html = `<div style="display:grid;grid-template-columns:180px 1fr;gap:16px;align-items:start">`;
      // Score card
      html += `<div class="sec-score-card"><div class="sec-score-big" style="color:${scoreColor(d.overall_score)}">${d.overall_score}</div>`;
      html += `<div class="sec-grade" style="background:${scoreColor(d.overall_score)}20;color:${scoreColor(d.overall_score)}">${escapeHtml(d.grade)}</div>`;
      html += `<div style="font-size:10px;color:var(--text-muted);margin-top:6px">${d.total_findings} findings</div></div>`;
      // Right side
      html += `<div>`;
      // Category cards
      html += `<div class="sec-category-grid">`;
      for (const [cat, score] of Object.entries(cats)) {
        const label = cat.charAt(0).toUpperCase() + cat.slice(1);
        html += `<div class="sec-cat-card"><h4>${escapeHtml(label)}</h4><div class="sec-cat-score" style="color:${scoreColor(score)}">${score}<span style="font-size:12px;color:var(--text-muted)">/100</span></div></div>`;
      }
      html += `</div>`;
      // Finding counts
      html += `<div class="sec-findings-summary">`;
      if (d.critical_count) html += `<span class="sec-count critical">${d.critical_count} Critical</span>`;
      if (d.high_count) html += `<span class="sec-count high">${d.high_count} High</span>`;
      if (d.medium_count) html += `<span class="sec-count medium">${d.medium_count} Medium</span>`;
      if (d.low_count) html += `<span class="sec-count low">${d.low_count} Low</span>`;
      if (!d.total_findings) html += `<span class="sec-count low">All clear</span>`;
      html += `</div>`;
      // Top findings
      const topFindings = (d.findings || []).filter(f => f.status !== 'dismissed').slice(0, 10);
      if (topFindings.length) {
        html += `<div style="margin-top:12px;font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;font-weight:600;margin-bottom:6px">Top Findings</div>`;
        html += topFindings.map(f => renderFinding(f)).join('');
      }
      html += `</div></div>`;
      document.getElementById('secDashboardContent').innerHTML = html;
    }

    function renderFinding(f) {
      const rem = f.remediation ? `<div class="sec-finding-remediation" onclick="navigator.clipboard.writeText(this.textContent);showToast('Copied to clipboard','info')" title="Click to copy">${escapeHtml(f.remediation)}</div>` : '';
      const dismiss = f.id ? `<button class="sec-dismiss-btn" onclick="dismissSecFinding(${f.id})">Dismiss</button>` : '';
      return `<div class="sec-finding ${f.severity}"><span class="sec-badge ${f.severity}">${f.severity}</span><div class="sec-finding-body"><div class="sec-finding-title">${escapeHtml(f.title)}</div>${rem}</div>${dismiss}</div>`;
    }

    async function dismissSecFinding(id) {
      try {
        await apiFetch('/api/security/dismiss/' + id, { method: 'POST' });
        showToast('Finding dismissed', 'info');
        fetchSecurityStatus();
      } catch {}
    }

    function renderSecContainers() {
      if (!securityData?.findings) return;
      const containerFindings = securityData.findings.filter(f => f.category === 'containers' && f.status !== 'dismissed');
      const byContainer = {};
      containerFindings.forEach(f => {
        const name = f.container_name || 'unknown';
        if (!byContainer[name]) byContainer[name] = [];
        byContainer[name].push(f);
      });

      const checkLabels = { privileged_mode: 'Privileged', docker_socket: 'Docker Socket', host_pid: 'Host PID', host_ipc: 'Host IPC',
        host_network: 'Host Net', root_user: 'Root User', excessive_caps: 'Capabilities', sensitive_mounts: 'Sensitive Mounts',
        no_memory_limit: 'Memory Limit', no_cpu_limit: 'CPU Limit', no_new_privileges: 'No-New-Priv', no_pids_limit: 'PID Limit',
        writable_rootfs: 'Read-Only FS', no_restart_policy: 'Restart Policy' };
      const allCheckIds = Object.keys(checkLabels);

      // Get all container names from findings (including passes  we infer from missing)
      const allContainers = new Set();
      securityData.findings.filter(f => f.category === 'containers').forEach(f => allContainers.add(f.container_name));
      // Also add containers that have no findings (all passed)
      if (securityData.findings.filter(f => f.category === 'containers').length === 0) {
        document.getElementById('secContainersContent').innerHTML = '<span style="color:var(--text-muted);font-size:12px">No container security data. Run a scan first.</span>';
        return;
      }

      let html = '';
      for (const [name, findings] of Object.entries(byContainer)) {
        const failedIds = new Set(findings.map(f => f.check_id));
        html += `<div class="sec-container-card">`;
        html += `<div class="sec-container-name"><span style="color:${failedIds.size > 3 ? 'var(--red)' : failedIds.size > 0 ? 'var(--yellow)' : 'var(--green)'}">${failedIds.size > 3 ? '!!' : failedIds.size > 0 ? '!' : 'OK'}</span> ${escapeHtml(name)}</div>`;
        html += `<div class="sec-checks-grid">`;
        for (const cid of allCheckIds) {
          const pass = !failedIds.has(cid);
          html += `<span class="sec-check ${pass ? 'pass' : 'fail'}">${pass ? 'OK' : 'FAIL'} ${checkLabels[cid]}</span>`;
        }
        html += `</div>`;
        // Show failed details
        if (findings.length) {
          html += `<div style="margin-top:8px">`;
          html += findings.map(f => renderFinding(f)).join('');
          html += `</div>`;
        }
        html += `</div>`;
      }
      document.getElementById('secContainersContent').innerHTML = html || '<span style="color:var(--green);font-size:12px">All containers passed security checks.</span>';
    }

    function renderSecCertificates() {
      if (!securityData?.findings) return;
      const certFindings = securityData.findings.filter(f => f.category === 'certificates' && f.status !== 'dismissed');
      const byDomain = {};
      certFindings.forEach(f => {
        const domain = f.title?.split(':')[0] || 'unknown';
        if (!byDomain[domain]) byDomain[domain] = [];
        byDomain[domain].push(f);
      });

      const checkLabels = { ssl_valid: 'Valid', ssl_expiry: 'Expiry', ssl_chain: 'Chain', tls_version: 'TLS Version', self_signed: 'CA-Signed' };
      const allCheckIds = Object.keys(checkLabels);

      if (Object.keys(byDomain).length === 0 && securityData.category_scores?.certificates !== undefined) {
        document.getElementById('secCertificatesContent').innerHTML = `<div style="padding:12px;text-align:center"><span style="color:var(--green);font-size:24px;font-weight:700">${securityData.category_scores.certificates}/100</span><div style="color:var(--text-muted);font-size:12px;margin-top:4px">All certificates are healthy</div></div>`;
        return;
      }

      let html = '';
      for (const [domain, findings] of Object.entries(byDomain)) {
        const failedIds = new Set(findings.map(f => f.check_id));
        html += `<div class="sec-domain-card"><div class="sec-domain-name">${escapeHtml(domain)}</div>`;
        html += `<div class="sec-checks-grid">`;
        for (const cid of allCheckIds) {
          html += `<span class="sec-check ${failedIds.has(cid) ? 'fail' : 'pass'}">${failedIds.has(cid) ? 'FAIL' : 'OK'} ${checkLabels[cid]}</span>`;
        }
        html += `</div>`;
        if (findings.length) {
          html += `<div style="margin-top:8px">${findings.map(f => renderFinding(f)).join('')}</div>`;
        }
        html += `</div>`;
      }
      document.getElementById('secCertificatesContent').innerHTML = html || '<span style="color:var(--text-muted);font-size:12px">No certificate data. Run a scan first.</span>';
    }

    function renderSecHeaders() {
      if (!securityData?.findings) return;
      const headerFindings = securityData.findings.filter(f => f.category === 'headers' && f.status !== 'dismissed');
      const byDomain = {};
      headerFindings.forEach(f => {
        const domain = f.title?.split(':')[0] || 'unknown';
        if (!byDomain[domain]) byDomain[domain] = [];
        byDomain[domain].push(f);
      });

      const headerLabels = { hsts: 'HSTS', csp: 'CSP', xcto: 'X-CTO', xfo: 'X-Frame', referrer: 'Referrer', permissions: 'Permissions', xss: 'XSS-Prot', unreachable: 'Reachable' };
      const allCheckIds = ['hsts', 'csp', 'xcto', 'xfo', 'referrer', 'permissions', 'xss'];

      if (Object.keys(byDomain).length === 0 && securityData.category_scores?.headers !== undefined) {
        document.getElementById('secHeadersContent').innerHTML = `<div style="padding:12px;text-align:center"><span style="color:var(--green);font-size:24px;font-weight:700">${securityData.category_scores.headers}/100</span><div style="color:var(--text-muted);font-size:12px;margin-top:4px">All security headers present</div></div>`;
        return;
      }

      let html = '';
      for (const [domain, findings] of Object.entries(byDomain)) {
        const failedIds = new Set(findings.map(f => f.check_id));
        html += `<div class="sec-domain-card"><div class="sec-domain-name">${escapeHtml(domain)}</div>`;
        html += `<div class="sec-checks-grid">`;
        for (const cid of allCheckIds) {
          html += `<span class="sec-check ${failedIds.has(cid) ? 'fail' : 'pass'}">${failedIds.has(cid) ? 'FAIL' : 'OK'} ${headerLabels[cid]}</span>`;
        }
        html += `</div>`;
        if (findings.length) {
          html += `<div style="margin-top:8px">${findings.map(f => renderFinding(f)).join('')}</div>`;
        }
        html += `</div>`;
      }
      document.getElementById('secHeadersContent').innerHTML = html || '<span style="color:var(--text-muted);font-size:12px">No header data. Run a scan first.</span>';
    }

    function renderSecNetwork() {
      if (!securityData?.findings) return;
      const netFindings = securityData.findings.filter(f => f.category === 'network' && f.status !== 'dismissed');

      if (netFindings.length === 0 && securityData.category_scores?.network !== undefined) {
        document.getElementById('secNetworkContent').innerHTML = `<div style="padding:12px;text-align:center"><span style="color:var(--green);font-size:24px;font-weight:700">${securityData.category_scores.network}/100</span><div style="color:var(--text-muted);font-size:12px;margin-top:4px">Network configuration looks good</div></div>`;
        return;
      }

      let html = netFindings.map(f => renderFinding(f)).join('');
      document.getElementById('secNetworkContent').innerHTML = html || '<span style="color:var(--text-muted);font-size:12px">No network data. Run a scan first.</span>';
    }

    // --- Settings Panel ---
    function toggleSettings() {
      const panel = document.getElementById('settingsPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active')) loadSettings();
    }

    async function loadSettings() {
      try {
        const [configRes, discoverRes] = await Promise.all([
          apiFetch('/api/config/apps'),
          apiFetch('/api/discover'),
        ]);
        if (configRes.ok) {
          const apps = await configRes.json();
          document.getElementById('configAppCount').textContent = apps.length;
          document.getElementById('configAppList').innerHTML = apps.map(a => `
            <div class="app-config-item">
              <div>
                <span class="app-config-name">${escapeHtml(a.name)}</span>
                ${a.domain ? `<span style="color:var(--text-muted);font-size:11px;margin-left:6px">${escapeHtml(a.domain)}</span>` : ''}
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span class="app-config-type">${escapeHtml(a.type)}</span>
                <div class="app-config-actions">
                  <button onclick="removeApp('${escapeHtml(a.slug)}')" class="danger">Remove</button>
                </div>
              </div>
            </div>
          `).join('') + `<button class="btn" onclick="showAddAppForm()" style="margin-top:8px;font-size:12px">+ Add App</button>`;
        }
        if (discoverRes.ok) {
          const data = await discoverRes.json();
          if (data.suggestions.length === 0) {
            document.getElementById('discoverList').innerHTML = '<p style="color:var(--text-muted);font-size:12px">All containers are tracked. No untracked containers found.</p>';
          } else {
            document.getElementById('discoverList').innerHTML = data.suggestions.map(s => `
              <div class="discover-item">
                <div>
                  <span style="font-weight:500">${escapeHtml(s.suggestedName)}</span>
                  <span style="color:var(--text-muted);font-size:11px;margin-left:4px">${s.containers.length} container${s.containers.length > 1 ? 's' : ''}</span>
                  <span style="font-size:11px;color:${s.state === 'running' ? 'var(--green)' : 'var(--yellow)'};margin-left:4px">${s.state}</span>
                </div>
                <button class="btn" onclick="addDiscovered('${escapeHtml(s.suggestedName)}', ${JSON.stringify(s.containers).replace(/'/g, "\\'")})" style="font-size:11px">+ Add</button>
              </div>
            `).join('');
          }
        }
      } catch (err) {
        console.error('Failed to load settings:', err);
      }
    }

    function showAddAppForm(name, containers) {
      document.getElementById('addAppForm').classList.add('active');
      if (name) document.getElementById('addAppName').value = name;
      if (containers) document.getElementById('addAppContainers').value = containers.join(', ');
      document.getElementById('addAppError').style.display = 'none';
    }

    function cancelAddApp() {
      document.getElementById('addAppForm').classList.remove('active');
      document.getElementById('addAppName').value = '';
      document.getElementById('addAppDomain').value = '';
      document.getElementById('addAppPort').value = '';
      document.getElementById('addAppHealth').value = '/';
      document.getElementById('addAppDesc').value = '';
      document.getElementById('addAppContainers').value = '';
      document.getElementById('addAppTech').value = '';
    }

    function addDiscovered(name, containers) {
      showAddAppForm(name, containers);
    }

    async function submitAddApp() {
      const errEl = document.getElementById('addAppError');
      errEl.style.display = 'none';
      const name = document.getElementById('addAppName').value.trim();
      if (!name) { errEl.textContent = 'Name is required'; errEl.style.display = 'block'; return; }

      const containersStr = document.getElementById('addAppContainers').value;
      const containers = containersStr ? containersStr.split(',').map(c => c.trim()).filter(Boolean) : [];

      try {
        const res = await apiFetch('/api/config/apps', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            type: document.getElementById('addAppType').value,
            domain: document.getElementById('addAppDomain').value.trim(),
            port: document.getElementById('addAppPort').value || null,
            health: document.getElementById('addAppHealth').value.trim() || '/',
            description: document.getElementById('addAppDesc').value.trim(),
            containers,
            tech: document.getElementById('addAppTech').value.trim(),
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        cancelAddApp();
        loadSettings();
        fetchAll(); // Refresh main app list
      } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = 'block';
      }
    }

    async function removeApp(slug) {
      if (!confirm('Remove this app from the dashboard? (This does not stop the container)')) return;
      try {
        await apiFetch('/api/config/apps/' + slug, { method: 'DELETE' });
        loadSettings();
        fetchAll();
      } catch {}
    }

    // --- Projects Manager ---
    let projOverviewData = null;
    let projTasksData = null;
    let projRoadmapData = null;
    let projTaskFilter = { app: '', status: '', priority: '' };

    function toggleProjects() {
      const panel = document.getElementById('projectsPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active') && !projOverviewData) fetchProjectsOverview();
    }

    function switchProjTab(tabName, btn) {
      document.querySelectorAll('.proj-tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.proj-tab').forEach(b => b.classList.remove('active'));
      document.getElementById('proj-' + tabName).classList.add('active');
      if (btn) btn.classList.add('active');
      if (tabName === 'tasks' && !projTasksData) fetchProjectTasks();
      if (tabName === 'roadmap' && !projRoadmapData) fetchProjectRoadmap();
      if (tabName === 'insights') fetchProjectInsights();
    }

    async function fetchProjectsOverview(force) {
      try {
        const el = document.getElementById('projOverviewContent');
        el.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading...</span>';
        const res = await apiFetch('/api/projects/overview');
        projOverviewData = await res.json();
        renderProjectsOverview();
        // Update badge
        const badge = document.getElementById('projTaskBadge');
        if (projOverviewData.totals.openTasks > 0) {
          badge.textContent = projOverviewData.totals.openTasks;
          badge.style.display = 'inline';
          if (projOverviewData.totals.overdueTasks > 0) { badge.style.background = 'rgba(239,68,68,0.15)'; badge.style.color = 'var(--red)'; }
          else { badge.style.background = 'rgba(168,85,247,0.15)'; badge.style.color = 'var(--purple)'; }
        } else { badge.style.display = 'none'; }
      } catch (err) {
        document.getElementById('projOverviewContent').innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${escapeHtml(err.message)}</span>`;
      }
    }

    function renderProjectsOverview() {
      const d = projOverviewData;
      if (!d) return;
      const el = document.getElementById('projOverviewContent');

      // Lifecycle swimlanes
      const lifecycles = ['idea', 'development', 'beta', 'launched', 'mature', 'deprecated'];
      const laneHtml = lifecycles.map(lc => {
        const apps = d.apps.filter(a => a.lifecycle === lc);
        return `<div class="proj-lane"><div class="proj-lane-title">${lc} (${apps.length})</div>${apps.map(a => `<div class="proj-chip" onclick="showProjAppEdit('${escapeHtml(a.slug)}')">${escapeHtml(a.name)}</div>`).join('')}</div>`;
      }).join('');

      // KPI cards
      const totalMRR = d.apps.reduce((s, a) => s + (a.mrr || 0), 0);
      const kpiHtml = `
        <div class="proj-kpi"><div class="proj-kpi-value" style="color:var(--green)">${(totalMRR / 100).toFixed(0)}</div><div class="proj-kpi-label">Total MRR</div></div>
        <div class="proj-kpi"><div class="proj-kpi-value" style="color:${d.totals.overdueTasks > 0 ? 'var(--red)' : 'var(--text)'}">${d.totals.openTasks}</div><div class="proj-kpi-label">Open Tasks${d.totals.overdueTasks > 0 ? ` (${d.totals.overdueTasks} overdue)` : ''}</div></div>
        <div class="proj-kpi"><div class="proj-kpi-value" style="color:var(--cyan)">${d.totals.completedThisWeek}</div><div class="proj-kpi-label">Done This Week</div></div>
        <div class="proj-kpi"><div class="proj-kpi-value">${d.apps.filter(a => a.type === 'saas' || a.type === 'tool').length}</div><div class="proj-kpi-label">Active Products</div></div>
      `;

      // App rows
      const sorted = [...d.apps].sort((a, b) => a.priority - b.priority);
      const appRowsHtml = sorted.map(a => {
        const goalPct = a.revenue_goal_mrr ? Math.min(100, Math.round((a.mrr / a.revenue_goal_mrr) * 100)) : null;
        return `<div class="proj-app-row">
          <span class="proj-lifecycle-badge ${a.lifecycle}">${a.lifecycle}</span>
          <span class="proj-priority-dot p${a.priority}" title="Priority ${a.priority}"></span>
          <span style="font-weight:600;min-width:100px">${escapeHtml(a.name)}</span>
          <span style="color:var(--text-muted);flex:1;font-size:11px">${escapeHtml(a.type)}</span>
          ${a.mrr ? `<span style="color:var(--green)">${(a.mrr/100).toFixed(0)}</span>` : ''}
          ${a.seo_score !== null ? `<span style="color:var(--text-dim)">SEO:${a.seo_score}</span>` : ''}
          ${a.security_findings > 0 ? `<span style="color:var(--orange)">${a.security_findings} findings</span>` : ''}
          <span style="color:var(--text-dim)">${a.tasks.open} tasks</span>
          ${goalPct !== null ? `<span style="font-size:10px;color:${goalPct >= 80 ? 'var(--green)' : goalPct >= 40 ? 'var(--yellow)' : 'var(--red)'}">${goalPct}% of goal</span>` : ''}
          <button class="btn" onclick="showProjAppEdit('${escapeHtml(a.slug)}')" style="font-size:10px;color:var(--purple);padding:2px 8px">Edit</button>
        </div>`;
      }).join('');

      el.innerHTML = `
        <div class="proj-lifecycle-strip">${laneHtml}</div>
        <div class="proj-kpi-grid">${kpiHtml}</div>
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);margin-bottom:8px">All Apps</div>
        ${appRowsHtml}
      `;
    }

    function showProjAppEdit(slug) {
      const a = projOverviewData?.apps?.find(x => x.slug === slug);
      if (!a) return;
      const html = `<div class="proj-form active" id="projEditForm">
        <div style="font-size:12px;font-weight:600;margin-bottom:10px">Edit ${escapeHtml(a.name)}</div>
        <div class="proj-form-row">
          <div class="proj-form-field"><label>Lifecycle</label><select id="projEditLifecycle"><option ${a.lifecycle==='idea'?'selected':''}>idea</option><option ${a.lifecycle==='development'?'selected':''}>development</option><option ${a.lifecycle==='beta'?'selected':''}>beta</option><option ${a.lifecycle==='launched'?'selected':''}>launched</option><option ${a.lifecycle==='mature'?'selected':''}>mature</option><option ${a.lifecycle==='deprecated'?'selected':''}>deprecated</option></select></div>
          <div class="proj-form-field"><label>Priority</label><select id="projEditPriority"><option value="1" ${a.priority===1?'selected':''}>1 - Focus</option><option value="2" ${a.priority===2?'selected':''}>2 - Maintain</option><option value="3" ${a.priority===3?'selected':''}>3 - Idle</option><option value="4" ${a.priority===4?'selected':''}>4 - Sunset</option></select></div>
          <div class="proj-form-field"><label>MRR Goal (cents)</label><input type="number" id="projEditMRR" value="${a.revenue_goal_mrr||''}" placeholder="e.g. 50000 = 500"></div>
        </div>
        <div class="proj-form-row">
          <div class="proj-form-field"><label>Traffic Goal (monthly PV)</label><input type="number" id="projEditTraffic" value="${a.traffic_goal_mpv||''}" placeholder="e.g. 10000"></div>
          <div class="proj-form-field"><label>User Goal</label><input type="number" id="projEditUsers" value="${a.user_goal||''}" placeholder="e.g. 100"></div>
        </div>
        <div class="proj-form-row"><div class="proj-form-field" style="flex:3"><label>Notes</label><textarea id="projEditNotes" placeholder="Strategic notes...">${escapeHtml(a.notes||'')}</textarea></div></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" onclick="saveProjMeta('${escapeHtml(slug)}')" style="color:var(--purple);padding:5px 14px;font-size:12px">Save</button>
          <button class="btn" onclick="document.getElementById('projEditForm').remove()" style="color:var(--text-muted);font-size:12px">Cancel</button>
        </div>
      </div>`;
      const old = document.getElementById('projEditForm');
      if (old) old.remove();
      document.getElementById('projOverviewContent').insertAdjacentHTML('afterbegin', html);
    }

    async function saveProjMeta(slug) {
      try {
        await apiFetch('/api/projects/meta/' + slug, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lifecycle: document.getElementById('projEditLifecycle').value,
            priority: parseInt(document.getElementById('projEditPriority').value),
            revenue_goal_mrr: parseInt(document.getElementById('projEditMRR').value) || null,
            traffic_goal_mpv: parseInt(document.getElementById('projEditTraffic').value) || null,
            user_goal: parseInt(document.getElementById('projEditUsers').value) || null,
            notes: document.getElementById('projEditNotes').value || null,
          })
        });
        showToast('Saved', 'success');
        const f = document.getElementById('projEditForm');
        if (f) f.remove();
        fetchProjectsOverview(true);
      } catch (err) { showToast(err.message, 'error'); }
    }

    // --- Tasks ---
    async function fetchProjectTasks() {
      try {
        const el = document.getElementById('projTasksContent');
        el.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading...</span>';
        let url = '/api/projects/tasks?';
        if (projTaskFilter.status === 'overdue') {
          url = '/api/projects/tasks/overdue';
        } else {
          if (projTaskFilter.app) url += `app=${projTaskFilter.app}&`;
          if (projTaskFilter.status) url += `status=${projTaskFilter.status}&`;
          if (projTaskFilter.priority) url += `priority=${projTaskFilter.priority}&`;
        }
        const res = await fetch(url);
        projTasksData = await res.json();
        renderProjectTasks();
      } catch (err) {
        document.getElementById('projTasksContent').innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${escapeHtml(err.message)}</span>`;
      }
    }

    function renderProjectTasks() {
      const el = document.getElementById('projTasksContent');
      const tasks = projTasksData || [];
      const today = new Date().toISOString().split('T')[0];
      const overdue = tasks.filter(t => t.due_date && t.due_date < today && t.status !== 'done' && t.status !== 'cancelled');

      // App options from overview
      const appOptions = (projOverviewData?.apps || []).map(a => `<option value="${escapeHtml(a.slug)}" ${projTaskFilter.app === a.slug ? 'selected' : ''}>${escapeHtml(a.name)}</option>`).join('');

      const filterHtml = `<div class="proj-filter-bar">
        <select onchange="projTaskFilter.app=this.value;fetchProjectTasks()"><option value="">All Apps</option>${appOptions}</select>
        <select onchange="projTaskFilter.status=this.value;fetchProjectTasks()">
          <option value="" ${!projTaskFilter.status?'selected':''}>All Status</option>
          <option value="todo" ${projTaskFilter.status==='todo'?'selected':''}>Todo</option>
          <option value="in_progress" ${projTaskFilter.status==='in_progress'?'selected':''}>In Progress</option>
          <option value="blocked" ${projTaskFilter.status==='blocked'?'selected':''}>Blocked</option>
          <option value="done" ${projTaskFilter.status==='done'?'selected':''}>Done</option>
          <option value="overdue" ${projTaskFilter.status==='overdue'?'selected':''}>Overdue</option>
        </select>
        <select onchange="projTaskFilter.priority=this.value;fetchProjectTasks()">
          <option value="" ${!projTaskFilter.priority?'selected':''}>All Priority</option>
          <option value="critical" ${projTaskFilter.priority==='critical'?'selected':''}>Critical</option>
          <option value="high" ${projTaskFilter.priority==='high'?'selected':''}>High</option>
          <option value="medium" ${projTaskFilter.priority==='medium'?'selected':''}>Medium</option>
          <option value="low" ${projTaskFilter.priority==='low'?'selected':''}>Low</option>
        </select>
        <button class="btn" onclick="showTaskForm()" style="color:var(--purple);font-size:11px">+ New Task</button>
        <button class="btn" onclick="showImportForm()" style="color:var(--text-dim);font-size:11px">Import</button>
      </div>`;

      const overdueHtml = overdue.length > 0 ? `<div class="proj-overdue-banner"> ${overdue.length} overdue task${overdue.length > 1 ? 's' : ''}</div>` : '';

      const taskFormHtml = `<div class="proj-form" id="projTaskForm">
        <div style="font-size:12px;font-weight:600;margin-bottom:10px">New Task</div>
        <div class="proj-form-row">
          <div class="proj-form-field" style="flex:3"><label>Title</label><input type="text" id="projNewTaskTitle" placeholder="Task title..."></div>
          <div class="proj-form-field"><label>App</label><select id="projNewTaskApp"><option value="">Portfolio</option>${appOptions}</select></div>
        </div>
        <div class="proj-form-row">
          <div class="proj-form-field"><label>Priority</label><select id="projNewTaskPriority"><option value="medium" selected>Medium</option><option value="critical">Critical</option><option value="high">High</option><option value="low">Low</option></select></div>
          <div class="proj-form-field"><label>Due Date</label><input type="date" id="projNewTaskDue"></div>
          <div class="proj-form-field"><label>Reminder</label><input type="datetime-local" id="projNewTaskReminder"></div>
        </div>
        <div class="proj-form-row"><div class="proj-form-field" style="flex:3"><label>Description</label><textarea id="projNewTaskDesc" placeholder="Details..."></textarea></div></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" onclick="createTask()" style="color:var(--purple);padding:5px 14px;font-size:12px">Create</button>
          <button class="btn" onclick="document.getElementById('projTaskForm').classList.remove('active')" style="color:var(--text-muted);font-size:12px">Cancel</button>
        </div>
      </div>`;

      const importFormHtml = `<div class="proj-form" id="projImportForm">
        <div style="font-size:12px;font-weight:600;margin-bottom:10px">Import from Markdown</div>
        <div class="proj-form-row">
          <div class="proj-form-field" style="flex:3"><label>Paste markdown (- [ ] todo / - [x] done)</label><textarea id="projImportText" style="min-height:100px" placeholder="- [ ] Post Show HN\n- [ ] Fix billing\n- [x] Deploy security manager"></textarea></div>
          <div class="proj-form-field"><label>App</label><select id="projImportApp"><option value="">Portfolio</option>${appOptions}</select></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" onclick="importTasks()" style="color:var(--purple);padding:5px 14px;font-size:12px">Import</button>
          <button class="btn" onclick="document.getElementById('projImportForm').classList.remove('active')" style="color:var(--text-muted);font-size:12px">Cancel</button>
        </div>
      </div>`;

      const taskListHtml = tasks.map(t => {
        const isDone = t.status === 'done' || t.status === 'cancelled';
        const isOverdue = t.due_date && t.due_date < today && !isDone;
        const appName = projOverviewData?.apps?.find(a => a.slug === t.app_slug)?.name || '';
        return `<div class="proj-task-row ${isDone ? 'done' : ''}">
          <input type="checkbox" ${isDone ? 'checked disabled' : ''} onchange="completeTask(${t.id})" style="cursor:pointer">
          <div class="proj-task-priority ${t.priority}"></div>
          <span class="proj-task-title">${escapeHtml(t.title)}</span>
          ${appName ? `<span class="proj-task-app">${escapeHtml(appName)}</span>` : ''}
          ${t.due_date ? `<span class="proj-task-due ${isOverdue ? 'overdue' : ''}">${t.due_date}</span>` : ''}
          ${t.reminder_at && !t.reminder_sent ? '<span title="Reminder set" style="font-size:10px"></span>' : ''}
          <select onchange="updateTaskStatus(${t.id}, this.value)" style="font-size:10px;padding:2px 4px;background:var(--surface3);border:1px solid var(--border);border-radius:3px;color:var(--text-dim)">
            <option value="todo" ${t.status==='todo'?'selected':''}>todo</option>
            <option value="in_progress" ${t.status==='in_progress'?'selected':''}>in progress</option>
            <option value="blocked" ${t.status==='blocked'?'selected':''}>blocked</option>
            <option value="done" ${t.status==='done'?'selected':''}>done</option>
          </select>
          <button class="sec-dismiss-btn" onclick="deleteTask(${t.id})" title="Delete"></button>
        </div>`;
      }).join('');

      el.innerHTML = filterHtml + taskFormHtml + importFormHtml + overdueHtml + (tasks.length > 0 ? taskListHtml : '<span style="color:var(--text-muted);font-size:12px">No tasks yet. Click "+ New Task" to create one.</span>');
    }

    function showTaskForm() { document.getElementById('projTaskForm').classList.add('active'); document.getElementById('projNewTaskTitle').focus(); }
    function showImportForm() { document.getElementById('projImportForm').classList.add('active'); document.getElementById('projImportText').focus(); }

    async function createTask() {
      try {
        const title = document.getElementById('projNewTaskTitle').value.trim();
        if (!title) { showToast('Title required', 'warning'); return; }
        await apiFetch('/api/projects/tasks', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            app_slug: document.getElementById('projNewTaskApp').value || null,
            priority: document.getElementById('projNewTaskPriority').value,
            due_date: document.getElementById('projNewTaskDue').value || null,
            reminder_at: document.getElementById('projNewTaskReminder').value || null,
            description: document.getElementById('projNewTaskDesc').value || null,
          })
        });
        showToast('Task created', 'success');
        document.getElementById('projTaskForm').classList.remove('active');
        document.getElementById('projNewTaskTitle').value = '';
        document.getElementById('projNewTaskDesc').value = '';
        fetchProjectTasks();
        fetchProjectsOverview(true);
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function importTasks() {
      try {
        const text = document.getElementById('projImportText').value;
        if (!text.trim()) { showToast('Paste some markdown', 'warning'); return; }
        const res = await apiFetch('/api/projects/tasks/import', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, app_slug: document.getElementById('projImportApp').value || null })
        });
        const data = await res.json();
        showToast(`Imported ${data.created} tasks`, 'success');
        document.getElementById('projImportForm').classList.remove('active');
        document.getElementById('projImportText').value = '';
        fetchProjectTasks();
        fetchProjectsOverview(true);
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function completeTask(id) { try { await apiFetch('/api/projects/tasks/' + id + '/complete', { method: 'POST' }); fetchProjectTasks(); fetchProjectsOverview(true); } catch {} }
    async function updateTaskStatus(id, status) { try { await apiFetch('/api/projects/tasks/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) }); fetchProjectTasks(); } catch {} }
    async function deleteTask(id) { if (!confirm('Delete this task?')) return; try { await apiFetch('/api/projects/tasks/' + id, { method: 'DELETE' }); fetchProjectTasks(); fetchProjectsOverview(true); showToast('Task deleted', 'success'); } catch {} }

    // --- Roadmap ---
    async function fetchProjectRoadmap() {
      try {
        const el = document.getElementById('projRoadmapContent');
        el.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading...</span>';
        const res = await apiFetch('/api/projects/roadmap');
        projRoadmapData = await res.json();
        renderProjectRoadmap();
      } catch (err) {
        document.getElementById('projRoadmapContent').innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${escapeHtml(err.message)}</span>`;
      }
    }

    function renderProjectRoadmap() {
      const items = projRoadmapData || [];
      const el = document.getElementById('projRoadmapContent');
      const statuses = ['idea', 'planned', 'in_progress', 'shipped'];
      const statusLabels = { idea: 'Ideas', planned: 'Planned', in_progress: 'In Progress', shipped: 'Shipped' };

      const appOptions = (projOverviewData?.apps || []).map(a => `<option value="${escapeHtml(a.slug)}">${escapeHtml(a.name)}</option>`).join('');

      const formHtml = `<div class="proj-form" id="projRoadmapForm">
        <div style="font-size:12px;font-weight:600;margin-bottom:10px">New Roadmap Item</div>
        <div class="proj-form-row">
          <div class="proj-form-field" style="flex:3"><label>Title</label><input type="text" id="projNewRmTitle" placeholder="Feature name..."></div>
          <div class="proj-form-field"><label>App</label><select id="projNewRmApp"><option value="">Portfolio</option>${appOptions}</select></div>
        </div>
        <div class="proj-form-row">
          <div class="proj-form-field"><label>Type</label><select id="projNewRmType"><option value="feature">Feature</option><option value="milestone">Milestone</option><option value="release">Release</option><option value="experiment">Experiment</option></select></div>
          <div class="proj-form-field"><label>Impact</label><select id="projNewRmImpact"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select></div>
          <div class="proj-form-field"><label>Effort</label><select id="projNewRmEffort"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
          <div class="proj-form-field"><label>Target Date</label><input type="date" id="projNewRmDate"></div>
        </div>
        <div class="proj-form-row"><div class="proj-form-field" style="flex:3"><label>Description</label><textarea id="projNewRmDesc" placeholder="What and why..."></textarea></div></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" onclick="createRoadmapItem()" style="color:var(--purple);padding:5px 14px;font-size:12px">Create</button>
          <button class="btn" onclick="document.getElementById('projRoadmapForm').classList.remove('active')" style="color:var(--text-muted);font-size:12px">Cancel</button>
        </div>
      </div>`;

      const kanbanHtml = statuses.map(s => {
        const colItems = items.filter(i => i.status === s);
        const cards = colItems.map(i => {
          const appName = projOverviewData?.apps?.find(a => a.slug === i.app_slug)?.name || '';
          return `<div class="proj-kanban-card" onclick="editRoadmapItem(${i.id})">
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap">
              <span class="proj-impact-badge ${i.impact}">${i.impact}</span>
              <span class="proj-effort-badge ${i.effort}">${i.effort}</span>
              ${i.type !== 'feature' ? `<span style="font-size:9px;color:var(--text-muted)">${i.type}</span>` : ''}
            </div>
            <div style="font-weight:500;margin-bottom:3px">${escapeHtml(i.title)}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              ${appName ? `<span class="proj-task-app">${escapeHtml(appName)}</span>` : '<span></span>'}
              ${i.target_date ? `<span style="font-size:10px;color:var(--text-muted)">${i.target_date}</span>` : ''}
            </div>
            ${s === 'in_progress' ? `<button class="btn" onclick="event.stopPropagation();shipRoadmapItem(${i.id})" style="margin-top:6px;font-size:10px;color:var(--green);padding:2px 8px">Mark Shipped</button>` : ''}
          </div>`;
        }).join('');
        return `<div class="proj-kanban-col"><div class="proj-kanban-col-title"><span>${statusLabels[s]}</span><span>${colItems.length}</span></div>${cards}</div>`;
      }).join('');

      el.innerHTML = `
        <div style="margin-bottom:12px"><button class="btn" onclick="showRoadmapForm()" style="color:var(--purple);font-size:11px">+ New Roadmap Item</button></div>
        ${formHtml}
        <div class="proj-kanban">${kanbanHtml}</div>
      `;
    }

    function showRoadmapForm() { document.getElementById('projRoadmapForm').classList.add('active'); document.getElementById('projNewRmTitle').focus(); }

    async function createRoadmapItem() {
      try {
        const title = document.getElementById('projNewRmTitle').value.trim();
        if (!title) { showToast('Title required', 'warning'); return; }
        await apiFetch('/api/projects/roadmap', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            app_slug: document.getElementById('projNewRmApp').value || null,
            type: document.getElementById('projNewRmType').value,
            impact: document.getElementById('projNewRmImpact').value,
            effort: document.getElementById('projNewRmEffort').value,
            target_date: document.getElementById('projNewRmDate').value || null,
            description: document.getElementById('projNewRmDesc').value || null,
          })
        });
        showToast('Roadmap item created', 'success');
        document.getElementById('projRoadmapForm').classList.remove('active');
        document.getElementById('projNewRmTitle').value = '';
        document.getElementById('projNewRmDesc').value = '';
        fetchProjectRoadmap();
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function shipRoadmapItem(id) { try { await apiFetch('/api/projects/roadmap/' + id + '/ship', { method: 'POST' }); showToast('Shipped!', 'success'); fetchProjectRoadmap(); } catch {} }

    function editRoadmapItem(id) {
      const item = projRoadmapData?.find(i => i.id === id);
      if (!item) return;
      const appOptions = (projOverviewData?.apps || []).map(a => `<option value="${escapeHtml(a.slug)}" ${item.app_slug===a.slug?'selected':''}>${escapeHtml(a.name)}</option>`).join('');
      const html = `<div class="proj-form active" id="projRmEditForm" style="margin-bottom:12px">
        <div style="font-size:12px;font-weight:600;margin-bottom:10px">Edit: ${escapeHtml(item.title)}</div>
        <div class="proj-form-row">
          <div class="proj-form-field" style="flex:3"><label>Title</label><input type="text" id="projRmEditTitle" value="${escapeHtml(item.title)}"></div>
          <div class="proj-form-field"><label>Status</label><select id="projRmEditStatus"><option ${item.status==='idea'?'selected':''}>idea</option><option ${item.status==='planned'?'selected':''}>planned</option><option ${item.status==='in_progress'?'selected':''}>in_progress</option><option ${item.status==='shipped'?'selected':''}>shipped</option><option ${item.status==='cancelled'?'selected':''}>cancelled</option></select></div>
          <div class="proj-form-field"><label>App</label><select id="projRmEditApp"><option value="">Portfolio</option>${appOptions}</select></div>
        </div>
        <div class="proj-form-row">
          <div class="proj-form-field"><label>Impact</label><select id="projRmEditImpact"><option ${item.impact==='high'?'selected':''}>high</option><option ${item.impact==='medium'?'selected':''}>medium</option><option ${item.impact==='low'?'selected':''}>low</option></select></div>
          <div class="proj-form-field"><label>Effort</label><select id="projRmEditEffort"><option ${item.effort==='low'?'selected':''}>low</option><option ${item.effort==='medium'?'selected':''}>medium</option><option ${item.effort==='high'?'selected':''}>high</option></select></div>
          <div class="proj-form-field"><label>Target Date</label><input type="date" id="projRmEditDate" value="${item.target_date||''}"></div>
        </div>
        <div class="proj-form-row"><div class="proj-form-field" style="flex:3"><label>Description</label><textarea id="projRmEditDesc">${escapeHtml(item.description||'')}</textarea></div></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" onclick="saveRoadmapEdit(${id})" style="color:var(--purple);padding:5px 14px;font-size:12px">Save</button>
          <button class="btn" onclick="document.getElementById('projRmEditForm').remove()" style="color:var(--text-muted);font-size:12px">Cancel</button>
        </div>
      </div>`;
      const old = document.getElementById('projRmEditForm');
      if (old) old.remove();
      document.getElementById('projRoadmapContent').insertAdjacentHTML('afterbegin', html);
    }

    async function saveRoadmapEdit(id) {
      try {
        await apiFetch('/api/projects/roadmap/' + id, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: document.getElementById('projRmEditTitle').value,
            status: document.getElementById('projRmEditStatus').value,
            app_slug: document.getElementById('projRmEditApp').value || null,
            impact: document.getElementById('projRmEditImpact').value,
            effort: document.getElementById('projRmEditEffort').value,
            target_date: document.getElementById('projRmEditDate').value || null,
            description: document.getElementById('projRmEditDesc').value || null,
          })
        });
        showToast('Saved', 'success');
        document.getElementById('projRmEditForm').remove();
        fetchProjectRoadmap();
      } catch (err) { showToast(err.message, 'error'); }
    }

    // --- Insights ---
    async function fetchProjectInsights() {
      const el = document.getElementById('projInsightsContent');
      el.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading portfolio summary...</span>';
      try {
        // Portfolio summary
        const summaryRes = await apiFetch('/api/projects/insights/portfolio/summary');
        const summary = await summaryRes.json();
        const saasApps = (projOverviewData?.apps || []).filter(a => a.type === 'saas' || a.type === 'tool');

        let html = `<div class="proj-insight-card">
          <h4>Portfolio Summary <span style="font-size:10px;font-weight:400;color:var(--text-muted)">${summary.cached ? 'cached' : 'fresh'}  ${summary.generated_at ? new Date(summary.generated_at).toLocaleString() : ''}</span></h4>
          <div class="proj-insight-content">${escapeHtml(summary.content || summary.error || 'No summary available')}</div>
        </div>`;

        // Per-app insight cards
        html += '<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);margin:12px 0 8px">Per-App Insights</div>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:10px">';
        for (const app of saasApps) {
          html += `<div class="proj-insight-card" id="projInsight-${app.slug}">
            <h4>${escapeHtml(app.name)} <button class="btn" onclick="refreshInsight('${escapeHtml(app.slug)}')" style="font-size:10px;color:var(--purple);padding:2px 8px">Generate</button></h4>
            <div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">${app.lifecycle}  priority ${app.priority}  ${((app.mrr||0)/100).toFixed(0)} MRR  ${app.tasks.open} open tasks</div>
            <div class="proj-insight-content" id="projInsightContent-${app.slug}" style="color:var(--text-muted)">Click "Generate" for AI-powered next actions</div>
          </div>`;
        }
        html += '</div>';
        el.innerHTML = html;
      } catch (err) {
        el.innerHTML = `<span style="color:var(--red);font-size:12px">Error: ${escapeHtml(err.message)}</span>`;
      }
    }

    async function refreshInsight(slug) {
      const el = document.getElementById('projInsightContent-' + slug);
      if (!el) return;
      el.innerHTML = '<span style="color:var(--text-muted)">Generating...</span>';
      try {
        const res = await apiFetch('/api/projects/insights/' + slug + '?force=true');
        const data = await res.json();
        el.textContent = data.content || data.error || 'No insight generated';
        el.style.color = 'var(--text-dim)';
      } catch (err) {
        el.innerHTML = `<span style="color:var(--red)">${escapeHtml(err.message)}</span>`;
      }
    }

    // ========== OPS INTELLIGENCE ==========
    let opsLoaded = false;
    let adhdMode = localStorage.getItem('adhdMode') === '1';
    if (adhdMode) document.body.classList.add('adhd-mode');

    function toggleOps() {
      const panel = document.getElementById('opsPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active') && !opsLoaded) fetchOpsAll();
    }

    function switchOpsTab(tab, btn) {
      document.querySelectorAll('.ops-tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.ops-tab').forEach(t => t.classList.remove('active'));
      document.getElementById('ops-' + tab).classList.add('active');
      if (btn) btn.classList.add('active');
      if (tab === 'reportcards') fetchOpsReportCards();
      if (tab === 'keys') fetchOpsDependencies();
    }

    // --- Error Tracker ---
    let errorsData = null;
    let errIssuesPage = { status: '', app: '', offset: 0 };
    let errEventsPage = { offset: 0 };

    function toggleErrors() {
      const panel = document.getElementById('errorsPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active') && !errorsData) fetchErrorsOverview();
    }

    function switchErrTab(tabName, btn) {
      document.querySelectorAll('.err-tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.err-tab').forEach(b => b.classList.remove('active'));
      document.getElementById('err-' + tabName).classList.add('active');
      if (btn) btn.classList.add('active');
      if (tabName === 'issues') fetchErrIssues();
      if (tabName === 'events') fetchErrEvents();
      if (tabName === 'perf') fetchErrPerf();
    }

    async function fetchErrorsOverview() {
      try {
        document.getElementById('errOverviewContent').innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading error stats...</span>';
        const res = await apiFetch('/api/errors/stats');
        errorsData = await res.json();
        document.getElementById('errLastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
        renderErrOverview();
        // Update badge
        const badge = document.getElementById('errCountBadge');
        if (errorsData.totalOpen > 0) {
          badge.textContent = errorsData.totalOpen;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      } catch (err) {
        document.getElementById('errOverviewContent').innerHTML = '<span style="color:var(--red);font-size:12px">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    function renderErrOverview() {
      if (!errorsData) return;
      const d = errorsData;
      const severityColors = { critical: 'var(--red)', error: '#f87171', warning: 'var(--yellow)', info: 'var(--blue)' };

      // Summary cards
      let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px">';
      html += `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center">
        <div style="font-size:28px;font-weight:800;color:${d.totalOpen > 0 ? 'var(--red)' : 'var(--green)'}">${d.totalOpen}</div>
        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase">Open Issues</div></div>`;
      html += `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center">
        <div style="font-size:28px;font-weight:800;color:var(--text)">${d.last24h}</div>
        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase">Events (24h)</div></div>`;

      // Severity breakdown
      const sevMap = {};
      (d.bySeverity || []).forEach(s => { sevMap[s.severity] = s.count; });
      html += `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px">
        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">By Severity</div>
        ${['critical','error','warning','info'].map(s => sevMap[s] ? `<span class="err-severity ${s}" style="margin-right:4px">${s} ${sevMap[s]}</span>` : '').join('')}
        ${Object.keys(sevMap).length === 0 ? '<span style="color:var(--text-muted);font-size:11px">None</span>' : ''}</div>`;
      html += '</div>';

      // Per-app bar chart
      if (d.byApp && d.byApp.length > 0) {
        const maxCount = Math.max(...d.byApp.map(a => a.count));
        html += '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px">';
        html += '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase">Errors by App</div>';
        for (const app of d.byApp) {
          const pct = maxCount > 0 ? Math.round((app.count / maxCount) * 100) : 0;
          html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
            <span style="font-size:11px;color:var(--text);width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(app.app_slug)}</span>
            <div style="flex:1;background:var(--surface3);border-radius:3px;height:16px;overflow:hidden">
              <div class="err-bar" style="width:${pct}%;background:${app.critical > 0 ? 'var(--red)' : 'var(--yellow)'};height:100%"></div>
            </div>
            <span style="font-size:11px;color:var(--text-dim);min-width:30px;text-align:right">${app.count}</span></div>`;
        }
        html += '</div>';
      }

      // 7-day trend sparkline
      if (d.last7d && d.last7d.length > 0) {
        const maxDay = Math.max(...d.last7d.map(d => d.count));
        html += '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px">';
        html += '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase">7-Day Trend</div>';
        html += '<div style="display:flex;align-items:flex-end;gap:4px;height:60px">';
        for (const day of d.last7d) {
          const h = maxDay > 0 ? Math.max(4, Math.round((day.count / maxDay) * 56)) : 4;
          html += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">
            <span style="font-size:9px;color:var(--text-muted)">${day.count}</span>
            <div style="width:100%;height:${h}px;background:var(--red);border-radius:2px;opacity:0.7"></div>
            <span style="font-size:8px;color:var(--text-muted)">${day.day.slice(5)}</span></div>`;
        }
        html += '</div></div>';
      }

      // Top 5 noisiest
      if (d.noisiest && d.noisiest.length > 0) {
        html += '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px">';
        html += '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase">Top Noisiest Issues</div>';
        for (const issue of d.noisiest) {
          html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)">
            <div style="flex:1;overflow:hidden">
              <span class="err-severity ${issue.severity}" style="margin-right:6px">${issue.severity}</span>
              <span style="font-size:11px;color:var(--text)">${escapeHtml(issue.title.slice(0, 80))}${issue.title.length > 80 ? '...' : ''}</span>
              <span style="font-size:10px;color:var(--text-muted);margin-left:6px">${escapeHtml(issue.app_slug)}</span>
            </div>
            <span style="font-size:11px;color:var(--text-dim);font-weight:600;min-width:40px;text-align:right">${issue.occurrence_count}x</span></div>`;
        }
        html += '</div>';
      }

      document.getElementById('errOverviewContent').innerHTML = html;
    }

    async function fetchErrIssues() {
      try {
        const p = errIssuesPage;
        let url = '/api/errors/issues?limit=50';
        if (p.status) url += '&status=' + p.status;
        if (p.app) url += '&app=' + encodeURIComponent(p.app);
        const res = await apiFetch(url);
        const data = await res.json();
        renderErrIssues(data.issues || []);
      } catch (err) {
        document.getElementById('errIssuesContent').innerHTML = '<span style="color:var(--red);font-size:12px">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    function renderErrIssues(issues) {
      let html = '<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">';
      ['', 'open', 'resolved', 'ignored'].forEach(s => {
        const label = s || 'all';
        const active = errIssuesPage.status === s;
        html += `<button style="font-size:10px;padding:3px 10px;border-radius:4px;border:1px solid ${active ? 'var(--blue)' : 'var(--border)'};background:${active ? 'rgba(59,130,246,0.12)' : 'var(--surface2)'};color:${active ? 'var(--blue)' : 'var(--text-dim)'};cursor:pointer" onclick="errIssuesPage.status='${s}';fetchErrIssues()">${label}</button>`;
      });
      html += '</div>';

      if (issues.length === 0) {
        html += '<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:12px">No issues found</div>';
      } else {
        for (const issue of issues) {
          const age = timeAgo(issue.last_seen);
          html += `<div class="err-issue-row" onclick="toggleErrExpand(${issue.id},this)">
            <span class="err-severity ${issue.severity}">${issue.severity}</span>
            <div style="flex:1;overflow:hidden">
              <div style="font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(issue.title)}</div>
              <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${escapeHtml(issue.app_slug)} &middot; ${issue.occurrence_count}x &middot; ${age} &middot; <span style="color:${issue.status === 'open' ? 'var(--yellow)' : issue.status === 'resolved' ? 'var(--green)' : 'var(--text-muted)'}">${issue.status}</span></div>
            </div>
          </div>
          <div class="err-issue-expand" id="errExpand-${issue.id}"></div>`;
        }
      }
      document.getElementById('errIssuesContent').innerHTML = html;
    }

    async function toggleErrExpand(issueId, row) {
      const expand = document.getElementById('errExpand-' + issueId);
      if (expand.classList.contains('active')) {
        expand.classList.remove('active');
        return;
      }
      expand.innerHTML = '<span style="color:var(--text-muted)">Loading...</span>';
      expand.classList.add('active');
      try {
        const res = await apiFetch('/api/errors/issues/' + issueId);
        const data = await res.json();
        let html = '';
        if (data.issue) {
          html += '<div class="err-actions">';
          if (data.issue.status !== 'resolved') html += `<button onclick="event.stopPropagation();patchErrIssue(${issueId},'resolved')">Resolve</button>`;
          if (data.issue.status !== 'ignored') html += `<button onclick="event.stopPropagation();patchErrIssue(${issueId},'ignored')">Ignore</button>`;
          if (data.issue.status !== 'open') html += `<button onclick="event.stopPropagation();patchErrIssue(${issueId},'open')">Reopen</button>`;
          html += '</div>';
        }
        if (data.events && data.events.length > 0) {
          const latest = data.events[0];
          if (latest.stack_trace) {
            html += '<div style="margin-top:8px;font-size:10px;color:var(--text-muted);text-transform:uppercase">Stack Trace</div>';
            html += '<div class="err-stack">' + escapeHtml(latest.stack_trace) + '</div>';
          }
          if (latest.breadcrumbs && latest.breadcrumbs.length > 0) {
            html += '<div style="margin-top:8px;font-size:10px;color:var(--text-muted);text-transform:uppercase">Breadcrumbs</div>';
            html += '<div style="font-size:11px;color:var(--text-dim);margin-top:4px">';
            for (const b of latest.breadcrumbs.slice(-10)) {
              html += '<div>' + escapeHtml(typeof b === 'string' ? b : JSON.stringify(b)) + '</div>';
            }
            html += '</div>';
          }
          html += `<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Showing latest of ${data.events.length} recent events &middot; Source: <span class="err-source">${escapeHtml(latest.source)}</span>${latest.request_url ? ' &middot; ' + escapeHtml(latest.request_method + ' ' + latest.request_url) : ''}</div>`;
        }
        expand.innerHTML = html || '<span style="color:var(--text-muted);font-size:11px">No event details</span>';
      } catch (err) {
        expand.innerHTML = '<span style="color:var(--red);font-size:11px">Failed to load: ' + escapeHtml(err.message) + '</span>';
      }
    }

    async function patchErrIssue(id, status) {
      try {
        await apiFetch('/api/errors/issues/' + id, {
          method: 'PATCH', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        fetchErrIssues();
        fetchErrorsOverview();
      } catch {}
    }

    async function fetchErrEvents() {
      try {
        const res = await apiFetch('/api/errors/events?limit=50&offset=' + errEventsPage.offset);
        const data = await res.json();
        renderErrEvents(data.events || []);
      } catch (err) {
        document.getElementById('errEventsContent').innerHTML = '<span style="color:var(--red);font-size:12px">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    function renderErrEvents(events) {
      if (events.length === 0) {
        document.getElementById('errEventsContent').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:12px">No events recorded yet</div>';
        return;
      }
      let html = '';
      for (const ev of events) {
        const age = timeAgo(ev.timestamp);
        html += `<div style="padding:8px 12px;border-bottom:1px solid var(--border);font-size:11px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="flex:1;overflow:hidden">
              <span class="err-severity ${ev.severity}">${ev.severity}</span>
              <span style="margin-left:6px;color:var(--text)">${escapeHtml(ev.issue_title || ev.message).slice(0, 100)}</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
              <span class="err-source">${escapeHtml(ev.source)}</span>
              <span style="color:var(--text-muted);font-size:10px">${escapeHtml(ev.app_slug)}</span>
              <span style="color:var(--text-muted);font-size:10px">${age}</span>
            </div>
          </div>
          ${ev.container_name ? '<div style="color:var(--text-muted);font-size:10px;margin-top:2px">Container: ' + escapeHtml(ev.container_name) + '</div>' : ''}
        </div>`;
      }
      // Pagination
      html += '<div style="display:flex;justify-content:center;gap:8px;padding:10px">';
      if (errEventsPage.offset > 0) html += `<button class="btn" onclick="errEventsPage.offset-=50;fetchErrEvents()">Previous</button>`;
      if (events.length >= 50) html += `<button class="btn" onclick="errEventsPage.offset+=50;fetchErrEvents()">Next</button>`;
      html += '</div>';
      document.getElementById('errEventsContent').innerHTML = html;
    }

    async function fetchErrPerf() {
      try {
        document.getElementById('errPerfContent').innerHTML = '<span style="color:var(--text-muted);font-size:12px">Loading performance data...</span>';
        const res = await apiFetch('/api/errors/perf?hours=24');
        const data = await res.json();
        renderErrPerf(data.metrics || []);
      } catch (err) {
        document.getElementById('errPerfContent').innerHTML = '<span style="color:var(--red);font-size:12px">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    function renderErrPerf(metrics) {
      if (metrics.length === 0) {
        document.getElementById('errPerfContent').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:12px">No performance data yet. Metrics are collected every 15 minutes.</div>';
        return;
      }
      let html = '<table style="width:100%;border-collapse:collapse;font-size:11px">';
      html += '<thead><tr style="border-bottom:2px solid var(--border);text-align:left">';
      html += '<th style="padding:6px 8px;color:var(--text-muted)">Endpoint</th>';
      html += '<th class="err-perf-cell" style="padding:6px 8px;color:var(--text-muted)">Req/24h</th>';
      html += '<th class="err-perf-cell" style="padding:6px 8px;color:var(--text-muted)">p50</th>';
      html += '<th class="err-perf-cell" style="padding:6px 8px;color:var(--text-muted)">p95</th>';
      html += '<th class="err-perf-cell" style="padding:6px 8px;color:var(--text-muted)">p99</th>';
      html += '<th class="err-perf-cell" style="padding:6px 8px;color:var(--text-muted)">Errors</th>';
      html += '</tr></thead><tbody>';
      for (const m of metrics) {
        const p95class = m.avg_p95 > 3000 ? 'err-perf-critical' : m.avg_p95 > 1000 ? 'err-perf-slow' : '';
        const p99class = m.avg_p99 > 3000 ? 'err-perf-critical' : m.avg_p99 > 1000 ? 'err-perf-slow' : '';
        html += `<tr style="border-bottom:1px solid var(--border)">
          <td style="padding:6px 8px;color:var(--text);font-family:monospace;font-size:10px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(m.endpoint)}</td>
          <td class="err-perf-cell" style="padding:6px 8px;color:var(--text-dim)">${m.requests}</td>
          <td class="err-perf-cell" style="padding:6px 8px;color:var(--text-dim)">${m.avg_p50}ms</td>
          <td class="err-perf-cell ${p95class}" style="padding:6px 8px">${m.avg_p95}ms</td>
          <td class="err-perf-cell ${p99class}" style="padding:6px 8px">${m.avg_p99}ms</td>
          <td class="err-perf-cell" style="padding:6px 8px;color:${m.errors > 0 ? 'var(--red)' : 'var(--text-dim)'}">${m.errors}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('errPerfContent').innerHTML = html;
    }

    function timeAgo(ts) {
      if (!ts) return '';
      const diff = Date.now() - new Date(ts).getTime();
      if (diff < 60000) return 'just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return Math.floor(diff / 86400000) + 'd ago';
    }

    function toggleADHDMode() {
      adhdMode = !adhdMode;
      document.body.classList.toggle('adhd-mode', adhdMode);
      localStorage.setItem('adhdMode', adhdMode ? '1' : '0');
      document.getElementById('adhdModeBtn').style.borderColor = adhdMode ? '#f97316' : '';
      showToast(adhdMode ? 'ADHD Mode: showing only issues' : 'ADHD Mode off: showing everything', 'info');
    }

    function worryColor(score) {
      if (score <= 15) return 'green';
      if (score <= 35) return 'yellow';
      if (score <= 60) return 'orange';
      return 'red';
    }

    function updateWorryBadge(score) {
      const badge = document.getElementById('worryBadge');
      if (score === undefined || score === null) { badge.style.display = 'none'; return; }
      badge.style.display = '';
      badge.textContent = score;
      badge.className = 'worry-badge ' + worryColor(score);
    }

    async function fetchOpsAll(force) {
      try {
        const [worryRes, heartbeatRes, timelineRes] = await Promise.all([
          apiFetch('/api/ops/worry-score'), apiFetch('/api/ops/heartbeat'), apiFetch('/api/ops/timeline')
        ]);
        const worry = await worryRes.json();
        const heartbeat = await heartbeatRes.json();
        const timeline = await timelineRes.json();
        opsLoaded = true;
        renderOpsPulse(worry, heartbeat);
        renderOpsTimeline(timeline);
        updateWorryBadge(worry.score);
      } catch (err) { console.error('Ops fetch error:', err); }
    }

    async function fetchOpsReportCards() {
      try {
        const res = await apiFetch('/api/ops/report-cards');
        const data = await res.json();
        renderOpsReportCards(data.cards);
      } catch (err) { document.getElementById('opsReportCardsContent').innerHTML = '<span style="color:var(--red);font-size:12px">Error: ' + escapeHtml(err.message) + '</span>'; }
    }

    async function fetchOpsDependencies() {
      try {
        const res = await apiFetch('/api/ops/dependencies');
        const data = await res.json();
        renderOpsDependencies(data);
      } catch (err) { document.getElementById('opsKeysContent').innerHTML = '<span style="color:var(--red);font-size:12px">Error: ' + escapeHtml(err.message) + '</span>'; }
    }

    async function createBaseline() {
      try {
        const res = await apiFetch('/api/ops/baseline', { method: 'POST' });
        const data = await res.json();
        showToast(data.ok ? 'Baseline snapshot created' : 'Failed to create baseline', data.ok ? 'success' : 'error');
      } catch (err) { showToast('Error: ' + err.message, 'error'); }
    }

    async function acknowledgeDrift(id) {
      try {
        await apiFetch('/api/ops/drift/' + id + '/acknowledge', { method: 'POST' });
        fetchOpsAll(true);
      } catch {}
    }

    function renderOpsPulse(worry, heartbeat) {
      const color = worryColor(worry.score);
      const labels = { containers: 'Containers', keys: 'API Keys', disk: 'Disk', backups: 'Backups', security: 'Security', healing: 'Healing', seo: 'SEO' };
      const statusText = worry.score <= 15 ? 'All clear' : worry.score <= 35 ? 'Minor issues' : worry.score <= 60 ? 'Needs attention' : 'Critical issues';
      let html = '<div style="display:grid;grid-template-columns:1fr 2fr;gap:20px">';
      // Left: Score + Streak
      html += '<div class="worry-score-display">';
      html += '<div class="worry-score-number ' + color + '">' + worry.score + '</div>';
      html += '<div class="worry-label">Worry Score</div>';
      html += '<div style="font-size:11px;color:var(--text-muted);margin-top:4px">' + statusText + '</div>';
      if (worry.streak) html += '<div class="streak-display"><span class="streak-count">' + worry.streak.days + '</span><span class="streak-label">day streak</span></div>';
      html += '</div>';
      // Right: Breakdown + Heartbeat
      html += '<div><div class="worry-breakdown">';
      for (const [key, value] of Object.entries(worry.breakdown || {})) {
        const max = worry.maxScores?.[key] || 0;
        const fc = value === 0 ? 'var(--green)' : value >= max * 0.7 ? 'var(--red)' : '#eab308';
        html += '<div class="worry-factor' + (value === 0 ? ' zero' : '') + '"><div class="worry-factor-score" style="color:' + fc + '">' + value + '/' + max + '</div><div class="worry-factor-label">' + (labels[key] || key) + '</div></div>';
      }
      html += '</div>';
      html += '<div style="margin-top:14px"><div style="font-size:11px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;font-weight:600">App Heartbeat</div>';
      html += '<div class="heartbeat-grid">';
      for (const app of (heartbeat.apps || [])) {
        const isOk = app.health === 'healthy' || app.health === 'static';
        html += '<div class="heartbeat-app' + (isOk ? ' ok' : '') + '" title="' + escapeHtml(app.name) + ' (' + app.health + ')">';
        html += '<div class="heartbeat-dot ' + app.health + '"></div>';
        html += '<div class="heartbeat-name">' + escapeHtml(app.name) + '</div></div>';
      }
      html += '</div></div></div></div>';
      document.getElementById('opsPulseContent').innerHTML = html;
    }

    function renderOpsReportCards(cards) {
      if (!cards || cards.length === 0) { document.getElementById('opsReportCardsContent').innerHTML = '<span style="color:var(--text-muted);font-size:12px">No report card data</span>'; return; }
      let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px">';
      for (const card of cards.sort((a, b) => a.overall - b.overall)) {
        html += '<div class="report-card grade-' + card.grade.toLowerCase() + '">';
        html += '<div class="report-card-header"><div><div style="font-size:13px;font-weight:600">' + escapeHtml(card.name) + '</div>';
        html += '<div style="font-size:10px;color:var(--text-muted)">' + card.type + ' &middot; ' + card.overall + '/100</div></div>';
        html += '<div class="report-card-grade ' + card.grade + '">' + card.grade + '</div></div>';
        html += '<div class="report-dims">';
        for (const [dim, data] of Object.entries(card.dimensions)) {
          const dc = (data.score >= 80) ? 'var(--green)' : (data.score >= 60) ? '#eab308' : 'var(--red)';
          html += '<div class="report-dim"><div class="report-dim-score" style="color:' + dc + '">' + (data.grade || '-') + '</div><div class="report-dim-label">' + dim.slice(0, 5) + '</div></div>';
        }
        html += '</div></div>';
      }
      html += '</div>';
      document.getElementById('opsReportCardsContent').innerHTML = html;
    }

    function renderOpsDependencies(data) {
      let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div>';
      html += '<div style="font-size:11px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;font-weight:600">Shared Keys (Blast Radius)</div>';
      if (!data.shared_keys?.length) html += '<div style="font-size:12px;color:var(--text-muted)">No shared keys detected</div>';
      for (const shared of (data.shared_keys || [])) {
        html += '<div class="dep-shared-key"><div class="dep-key-name">' + escapeHtml(shared.key) + ' <span style="color:var(--text-muted);font-size:10px">' + escapeHtml(shared.maskedValue) + '</span></div>';
        html += '<div class="dep-app-list">' + shared.apps.map(a => '<span class="dep-app-badge">' + escapeHtml(a) + '</span>').join('') + '</div>';
        html += '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Blast radius: ' + shared.apps.length + ' apps affected if key expires</div></div>';
      }
      html += '</div><div>';
      html += '<div style="font-size:11px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;font-weight:600">App Connections</div>';
      const adjMap = {};
      for (const edge of (data.edges || [])) {
        if (!adjMap[edge.source]) adjMap[edge.source] = [];
        adjMap[edge.source].push({ target: edge.target, label: edge.label });
      }
      for (const [source, targets] of Object.entries(adjMap)) {
        html += '<div style="font-size:12px;margin-bottom:6px"><span style="color:var(--text);font-weight:500">' + escapeHtml(source) + '</span> <span style="color:var(--text-muted)">shares with:</span>';
        for (const t of targets) html += ' <span style="color:var(--cyan)">' + escapeHtml(t.target) + '</span><span style="color:var(--text-muted);font-size:10px"> (' + escapeHtml(t.label) + ')</span>';
        html += '</div>';
      }
      if (Object.keys(adjMap).length === 0) html += '<div style="font-size:12px;color:var(--text-muted)">No shared connections</div>';
      html += '</div></div>';
      document.getElementById('opsKeysContent').innerHTML = html;
    }

    function renderOpsTimeline(data) {
      let html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
      html += '<span style="font-size:11px;color:var(--text-muted)">' + (data.unacknowledged || 0) + ' unacknowledged</span>';
      html += '<button class="btn" onclick="fetchOpsAll(true)">Refresh</button></div>';
      if (!data.events?.length) {
        html += '<span style="color:var(--text-muted);font-size:12px">No ops events yet. Create a baseline to start tracking drift.</span>';
        document.getElementById('opsTimelineContent').innerHTML = html;
        return;
      }
      for (const ev of data.events) {
        const time = new Date(ev.timestamp).toLocaleString('de-DE', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        html += '<div class="ops-event ' + ev.severity + '">';
        html += '<span class="ops-event-time">' + time + '</span>';
        html += '<span class="ops-event-title">' + escapeHtml(ev.title) + '</span>';
        html += ev.acknowledged ? '<span style="font-size:10px;color:var(--green)">&#10003;</span>' : '<button class="ops-event-ack" onclick="acknowledgeDrift(' + ev.id + ')">Ack</button>';
        html += '</div>';
      }
      document.getElementById('opsTimelineContent').innerHTML = html;
    }

    // Auto-refresh worry badge every 5 min
    let lastWorryFetch = 0;
    setInterval(async () => {
      try {
        const res = await apiFetch('/api/ops/worry-score');
        const data = await res.json();
        updateWorryBadge(data.score);
      } catch {}
    }, 300000);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Command palette takes priority
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); openCommandPalette(); return; }
      if (e.key === 'Escape') {
        if (document.getElementById('cmdOverlay').classList.contains('active')) { closeCommandPalette(); return; }
        closeModal();
        document.getElementById('searchInput').blur();
        return;
      }
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
      if (e.key === '/') { e.preventDefault(); document.getElementById('searchInput').focus(); }
      if (e.key === 'r') fetchAll();
      if (e.key === 'a') toggleActivity();
      if (e.key === 's') toggleSSLPanel();
      if (e.key === 'k') toggleKeyHealth();
      if (e.key === 'b') toggleBackups();
      if (e.key === 'm') toggleMarketing();
      if (e.key === 'd') toggleBriefing();
      if (e.key === 'h') toggleHealing();
      if (e.key === 'S') toggleSecurity();
      if (e.key === 'j') toggleProjects();
      if (e.key === 'o') toggleOps();
      if (e.key === 'e') toggleErrors();
      if (e.key === 'A') toggleADHDMode();
      if (e.key === 'x') { if (!document.getElementById('marketingPanel').classList.contains('visible')) toggleMarketing(); setTimeout(() => switchMktTab('crosspromo', document.querySelector('.mkt-tab:nth-child(7)')), 100); }
      if (e.key === 'B') { if (!document.getElementById('marketingPanel').classList.contains('visible')) toggleMarketing(); setTimeout(() => switchMktTab('banners', document.querySelector('.mkt-tab:nth-child(8)')), 100); }
      if (e.key === 'p') { if (!document.getElementById('marketingPanel').classList.contains('visible')) toggleMarketing(); setTimeout(() => switchMktTab('playbook', document.querySelector('.mkt-tab:nth-child(9)')), 100); }
      if (e.key === '?') openCommandPalette();
    });

    // Auto-refresh with countdown
    let nextRefresh = 30;
    function tick() {
      nextRefresh--;
      if (nextRefresh <= 0) { fetchAll(); nextRefresh = 30; }
      document.getElementById('countdown').textContent = nextRefresh + 's';
    }

    // Periodically check healing status (every 60s)
    setInterval(() => fetchHealingLog(), 60000);

    fetchAll();
    setInterval(tick, 1000);

    // Auto-show briefing on first visit
    setTimeout(maybeShowBriefing, 3000);
  </script>
</body>
</html>
